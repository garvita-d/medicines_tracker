<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Activated Medicine Reminder & Stock Alert System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                margin: 0 10px;
            }
        }

        /* Notification Setup Panel */
        .notification-setup {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .setup-button {
            background: #fff;
            color: #17a2b8;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-button:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .notification-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-granted {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #155724;
        }

        .status-denied {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }

        /* PWA Installation */
        .pwa-section {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
        }

        .install-button {
            background: #fff;
            color: #6f42c1;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            text-align: center;
            color: white;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: #28a745;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-status {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 50px;
            font-style: italic;
        }

        .voice-response {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Mobile responsive tabs */
        @media (max-width: 768px) {
            .tab-content {
                padding: 15px;
                max-height: 70vh;
            }
        }

        .person-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .person-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .person-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .person-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .time-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .medicine-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .medicine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .medicine-item.low-stock {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .medicine-item.taken-today {
            border-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #c3e6cb 100%);
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .medicine-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .medicine-stock {
            text-align: right;
            margin-left: 15px;
        }

        .stock-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }

        .stock-count.low {
            color: #dc3545;
        }

        .stock-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            align-items: center;
        }

        .dose-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .dose-label {
            font-size: 0.9rem;
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .alert {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            color: #721c24;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .alert-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .current-time {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Scrollable stock alerts container */
        .stock-alerts-container {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar for webkit browsers */
        .stock-alerts-container::-webkit-scrollbar {
            width: 8px;
        }

        .stock-alerts-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .urgent-alert {
            animation: pulse 2s infinite;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom notification popup */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Mobile responsive notification */
        @media (max-width: 768px) {
            .notification-popup {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-400px);
            }

            .notification-popup.show {
                transform: translateY(0);
            }
        }

        .today-status {
            font-size: 0.8rem;
            color: #28a745;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice-Activated Medicine System</h1>
            <p>Real Notifications & Reminders - Works Like a Mobile App!</p>
        </div>

        <!-- PWA Installation Section -->
        <div class="pwa-section">
            <h3>üì± Install as Mobile App</h3>
            <p>Make this a real app on your phone for better notifications!</p>
            <button class="install-button" id="installButton" onclick="installPWA()">
                üì≤ Install App on Home Screen
            </button>
            <div id="installInstructions" style="margin-top: 15px; font-size: 0.9rem;">
                <p><strong>Manual Installation:</strong></p>
                <p>‚Ä¢ On Android: Chrome menu ‚Üí "Add to Home screen"</p>
                <p>‚Ä¢ On iPhone: Safari Share button ‚Üí "Add to Home Screen"</p>
            </div>
        </div>

        <!-- Notification Setup Section -->
        <div class="notification-setup">
            <h3>üîî Smart Notification System</h3>
            <p>Enable different types of reminders:</p>
            
            <div>
                <button class="setup-button" onclick="enableBrowserNotifications()">
                    üîî Enable Browser Notifications
                </button>
                <button class="setup-button" onclick="setupWebReminders()">
                    ‚è∞ Setup Web Reminders
                </button>
                <button class="setup-button" onclick="downloadCalendar()">
                    üìÖ Download Calendar Events
                </button>
                <button class="setup-button" onclick="setupEmailReminders()">
                    üìß Email Reminders
                </button>
            </div>
            
            <div class="notification-status" id="notificationStatus">
                Click "Enable Browser Notifications" to get started!
            </div>
        </div>

        <!-- Voice Assistant Section -->
        <div class="voice-assistant">
            <h3>ü§ñ MediBot Voice Assistant</h3>
            <div>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    üé§
                </button>
                <button class="voice-button" onclick="stopSpeaking()" title="Stop Speaking">
                    üîá
                </button>
            </div>
            
            <div class="voice-status" id="voiceStatus">Click microphone to start listening</div>
            
            <div class="voice-transcript" id="voiceTranscript">
                Your speech will appear here...
            </div>
            
            <div class="voice-response" id="voiceResponse">
                MediBot's responses will appear here...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('father')">üë® Father</button>
            <button class="nav-tab" onclick="showTab('mother')">üë© Mother</button>
            <button class="nav-tab" onclick="showTab('alerts')">‚ö†Ô∏è Stock Alerts</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="current-time" id="currentTime"></div>
            
            <div class="alert">
                <span class="alert-icon">üí°</span>
                <div>
                    <strong>Pro Tip:</strong> Keep this tab open or install as an app for automatic reminders!
                    Next reminder: <span id="nextReminderTime">--</span>
                </div>
            </div>
        </div>

        <div id="father" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë®</div>
                    <div class="person-name">Father's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üåÖ</span>
                        Before Breakfast (8:00 AM)
                    </div>
                    <div id="fatherMorningBefore"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="fatherMorningAfter"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üïê</span>
                        4:00 PM
                    </div>
                    <div id="father4PM"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="fatherNight"></div>
                </div>
            </div>
        </div>

        <div id="mother" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë©</div>
                    <div class="person-name">Mother's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="motherMorning"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="motherNight"></div>
                </div>
            </div>
        </div>

        <div id="alerts" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üö® Stock Alerts & Warnings</h2>
            <div class="stock-alerts-container">
                <div id="stockAlerts"></div>
            </div>
        </div>
    </div>

    <!-- Custom Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <button class="close-btn" onclick="closeNotification()">&times;</button>
        <div id="notificationContent">
            <h4>üîî Medicine Reminder</h4>
            <p>It's time for your scheduled medicine!</p>
        </div>
    </div>

    <script>
        // PWA and Notification variables
        let deferredPrompt;
        let notificationPermission = Notification.permission;
        let reminderIntervals = [];

        // Medicine data structure with persistent storage keys
        const medicineData = {
            father: {
                morningBefore: [
                    { name: "Maxi PhD", dosage: "30 days tablets", stock: 30, originalStock: 30, storageKey: "father_morningBefore_0" }
                ],
                morningAfter: [
                    { name: "Metolol MF", dosage: "60mg - 30 days", stock: 30, originalStock: 30, storageKey: "father_morningAfter_0" },
                    { name: "Pilclop", dosage: "75mg - 30 days", stock: 30, originalStock: 30, storageKey: "father_morningAfter_1" },
                    { name: "Cordarone", dosage: "30 days", stock: 30, originalStock: 30, storageKey: "father_morningAfter_2" },
                    { name: "Orofer XT", dosage: "30 tablets", stock: 30, originalStock: 30, storageKey: "father_morningAfter_3" },
                    { name: "Hyqvit", dosage: "30 tablets", stock: 30, originalStock: 30, storageKey: "father_morningAfter_4" }
                ],
                afternoon: [
                    { name: "Acitrom", dosage: "1mg/2mg alternate days - 30 days", stock: 30, originalStock: 30, storageKey: "father_afternoon_0" }
                ],
                night: [
                    { name: "Rotin F", dosage: "30 tablets", stock: 30, originalStock: 30, storageKey: "father_night_0" },
                    { name: "Telmiford", dosage: "40mg - 30 tablets", stock: 30, originalStock: 30, storageKey: "father_night_1" }
                ]
            },
            mother: {
                morning: [
                    { name: "Telzox H", dosage: "30 tablets", stock: 30, originalStock: 30, storageKey: "mother_morning_0" },
                    { name: "Cinod", dosage: "10mg - 1 tablet (Morning dose)", stock: 60, originalStock: 60, storageKey: "mother_morning_1" },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Morning dose)", stock: 60, originalStock: 60, storageKey: "mother_morning_2" }
                ],
                night: [
                    { name: "Cinod", dosage: "10mg - 1 tablet (Evening dose)", stock: 60, originalStock: 60, storageKey: "mother_night_0" },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Evening dose)", stock: 60, originalStock: 60, storageKey: "mother_night_1" }
                ]
            }
        };

        // Medicine reminder times (24-hour format)
        const reminderTimes = [
            { time: '08:00', message: "Time for Father's morning medicine (before breakfast) - Maxi PhD", medicines: ["Maxi PhD"] },
            { time: '10:00', message: "Time for after-breakfast medicines", medicines: ["Metolol MF", "Pilclop", "Cordarone", "Orofer XT", "Hyqvit", "Telzox H", "Cinod", "Zavamet"] },
            { time: '16:00', message: "Time for Father's 4 PM medicine - Acitrom", medicines: ["Acitrom"] },
            { time: '22:00', message: "Time for evening medicines", medicines: ["Rotin F", "Telmiford", "Cinod", "Zavamet"] }
        ];

        // Storage functions using variables instead of localStorage
        let appStorage = {};

        function saveToStorage(key, value) {
            appStorage[key] = JSON.stringify(value);
        }

        function getFromStorage(key) {
            const value = appStorage[key];
            return value ? JSON.parse(value) : null;
        }

        function getTodayKey() {
            return new Date().toDateString();
        }

        // Load saved data
        function loadSavedData() {
            console.log("Loading saved data...");
            
            // Load stock levels
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine, index) => {
                        const savedStock = getFromStorage(medicine.storageKey + '_stock');
                        if (savedStock !== null) {
                            medicine.stock = savedStock;
                        }
                    });
                });
            });
        }

        // Check if medicine was taken today
        function wasTakenToday(storageKey) {
            const todayKey = getTodayKey();
            const takenData = getFromStorage(storageKey + '_taken_' + todayKey);
            return takenData === true;
        }

        // Mark medicine as taken today
        function markTakenToday(storageKey, taken = true) {
            const todayKey = getTodayKey();
            saveToStorage(storageKey + '_taken_' + todayKey, taken);
        }

        // Initialize the application
        function init() {
            console.log("Initializing MediBot system...");
            
            // Load saved data first
            loadSavedData();
            
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup PWA installation
            setupPWA();
            
            // Setup reminder system
            setupReminderSystem();
            
            // Update next reminder display
            updateNextReminder();
            setInterval(updateNextReminder, 60000);
            
            // Check for low stock reminders every 5 minutes
            setInterval(checkLowStockReminders, 5 * 60 * 1000);
            
            // Initialize voice if available
            initializeVoiceRecognition();
            
            // Populate medicine schedules
            console.log("Populating medicine schedules...");
            populateMedicineSchedules();
            
            // Generate stock alerts
            generateStockAlerts();
            
            // Auto-greet user
            setTimeout(() => {
                speak("Welcome to MediBot! All medicine schedules loaded successfully.");
                // Check for immediate low stock alerts
                checkLowStockReminders();
            }, 2000);
        }

        // Check for low stock reminders
        function checkLowStockReminders() {
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.stock <= 5 && !wasTakenToday('low_stock_' + medicine.storageKey)) {
                                const reminderMessage = `LOW STOCK ALERT: ${medicine.name} only has ${medicine.stock} tablets left. Please refill soon!`;
                                
                                // Show browser notification if permitted
                                if (notificationPermission === 'granted') {
                                    new Notification('üö® Low Stock Alert', {
                                        body: reminderMessage,
                                        icon: 'https://via.placeholder.com/64/ff6b6b/ffffff?text=üè•',
                                        requireInteraction: true
                                    });
                                }
                                
                                // Show custom notification
                                showCustomNotification('üö® Low Stock Alert', reminderMessage);
                                
                                // Speak the alert
                                speak(reminderMessage);
                                
                                // Mark as alerted today to avoid spam
                                markTakenToday('low_stock_' + medicine.storageKey, true);
                            }
                        });
                    });
                });
            };
        

        // PWA setup
        function setupPWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")');
            }

            // Listen for PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installButton').style.display = 'inline-block';
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                deferredPrompt = null;
            });
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('Add to Home Screen: Use your browser menu to add this app to your home screen');
            }
        }

        // Notification functions
        function enableBrowserNotifications() {
            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                updateNotificationStatus();
                if (permission === 'granted') {
                    new Notification('üéâ Notifications Enabled!', {
                        body: 'You will now receive medicine reminders',
                        icon: 'https://via.placeholder.com/64/28a745/ffffff?text=‚úì'
                    });
                }
            });
        }

        function updateNotificationStatus() {
            const statusDiv = document.getElementById('notificationStatus');
            if (notificationPermission === 'granted') {
                statusDiv.className = 'notification-status status-granted';
                statusDiv.innerHTML = '‚úÖ Browser notifications are enabled! You\'ll receive automatic reminders.';
            } else if (notificationPermission === 'denied') {
                statusDiv.className = 'notification-status status-denied';
                statusDiv.innerHTML = '‚ùå Notifications blocked. Please enable in browser settings.';
            } else {
                statusDiv.className = 'notification-status status-pending';
                statusDiv.innerHTML = '‚è≥ Click "Enable Browser Notifications" to get automatic reminders.';
            }
        }

        function showCustomNotification(title, message) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<h4>${title}</h4><p>${message}</p>`;
            popup.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                closeNotification();
            }, 10000);
        }

        function closeNotification() {
            document.getElementById('notificationPopup').classList.remove('show');
        }

        // Voice recognition functions
        let recognition;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('üé§ Listening... Speak now!');
                    document.getElementById('voiceButton').classList.add('listening');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voiceTranscript').textContent = transcript;
                    processVoiceCommand(transcript);
                };

                recognition.onerror = function(event) {
                    updateVoiceStatus('‚ùå Error: ' + event.error);
                    document.getElementById('voiceButton').classList.remove('listening');
                    isListening = false;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening');
                    updateVoiceStatus('Click microphone to start listening');
                };
            } else {
                updateVoiceStatus('‚ùå Voice recognition not supported in this browser');
                document.getElementById('voiceButton').disabled = true;
            }
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                alert('Voice recognition not available');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function updateVoiceStatus(message) {
            document.getElementById('voiceStatus').textContent = message;
        }

        / Enhanced Voice Command Processing with Health Knowledge
function processVoiceCommand(command) {
    const lowerCommand = command.toLowerCase();
    let response = '';

    // Medicine-specific queries (existing functionality enhanced)
    if (lowerCommand.includes('medicine') || lowerCommand.includes('medication')) {
        if (lowerCommand.includes('father')) {
            response = 'Father takes Maxi PhD before breakfast at 8 AM, then Metolol MF, Pilclop, Cordarone, Orofer XT and Hyqvit after breakfast at 10 AM. Acitrom at 4 PM, and Rotin F with Telmiford at night around 10 PM.';
        } else if (lowerCommand.includes('mother')) {
            response = 'Mother takes Telzox H, Cinod and Zavamet after breakfast at 10 AM. Then Cinod and Zavamet again at night around 10 PM.';
        } else if (lowerCommand.includes('schedule') || lowerCommand.includes('timing')) {
            response = 'Daily medicine schedule: 8 AM - Father\'s Maxi PhD before breakfast. 10 AM - After breakfast medicines for both parents. 4 PM - Father\'s Acitrom. 10 PM - Evening medicines for both parents.';
        } else {
            response = 'I can help with Father\'s or Mother\'s medicine schedule. Father takes heart medications and supplements, while Mother takes blood pressure and diabetes medications. Which specific information do you need?';
        }
    }
    
    // Stock and inventory queries
    else if (lowerCommand.includes('stock') || lowerCommand.includes('count') || lowerCommand.includes('inventory')) {
        response = 'Let me check the current stock levels...';
        let lowStockItems = [];
        let adequateStockItems = [];
        
        Object.keys(medicineData).forEach(person => {
            Object.keys(medicineData[person]).forEach(timeSlot => {
                medicineData[person][timeSlot].forEach(medicine => {
                    if (medicine.stock <= 5) {
                        lowStockItems.push(`${medicine.name} has only ${medicine.stock} tablets left`);
                    } else if (medicine.stock <= 10) {
                        adequateStockItems.push(`${medicine.name} has ${medicine.stock} tablets`);
                    }
                });
            });
        });
        
        if (lowStockItems.length > 0) {
            response += ` URGENT: ${lowStockItems.join(', ')}. Please refill these medicines soon.`;
        }
        if (adequateStockItems.length > 0) {
            response += ` Moderate stock: ${adequateStockItems.join(', ')}.`;
        }
        if (lowStockItems.length === 0 && adequateStockItems.length === 0) {
            response += ' All medicines have adequate stock levels above 10 tablets.';
        }
    }
    
    // Time and scheduling queries
    else if (lowerCommand.includes('time') || lowerCommand.includes('when') || lowerCommand.includes('schedule')) {
        if (lowerCommand.includes('next') || lowerCommand.includes('upcoming')) {
            const now = new Date();
            const currentTime = now.getHours() * 100 + now.getMinutes();
            const nextReminder = reminderTimes.find(r => {
                const [hours, minutes] = r.time.split(':').map(Number);
                return (hours * 100 + minutes) > currentTime;
            });
            
            if (nextReminder) {
                response = `Next medicine reminder is at ${nextReminder.time}. ${nextReminder.message}`;
            } else {
                response = 'Next medicine reminder is tomorrow at 8:00 AM for Father\'s morning medicine.';
            }
        } else {
            response = 'Daily medicine times: 8:00 AM - Father\'s before breakfast medicine, 10:00 AM - After breakfast medicines, 4:00 PM - Father\'s Acitrom, 10:00 PM - Evening medicines for both parents.';
        }
    }
    
    // Medicine taken/completion status
    else if (lowerCommand.includes('taken') || lowerCommand.includes('done') || lowerCommand.includes('completed')) {
        response = 'I understand you want to mark medicine as taken. Please use the checkboxes next to each medicine on the dashboard to mark them as completed. This will automatically update the stock count and track your daily progress.';
    }
    
    // Health and medical information queries
    else if (lowerCommand.includes('blood pressure') || lowerCommand.includes('hypertension')) {
        response = 'Blood pressure medications like Telzox H and Telmiford help control hypertension. Take them consistently at the same time daily. Monitor your blood pressure regularly, maintain a low-sodium diet, exercise regularly, and avoid stress. Normal blood pressure is below 120/80 mmHg.';
    }
    
    else if (lowerCommand.includes('diabetes') || lowerCommand.includes('blood sugar')) {
        response = 'Diabetes medications like Zavamet and Cinod help control blood sugar levels. Take them with meals as prescribed. Monitor blood glucose regularly, follow a balanced diet, exercise daily, stay hydrated, and watch for symptoms like excessive thirst, frequent urination, or fatigue.';
    }
    
    else if (lowerCommand.includes('heart') || lowerCommand.includes('cardiac')) {
        response = 'Heart medications include Metolol MF for blood pressure, Cordarone for heart rhythm, and Pilclop as a blood thinner. Take them exactly as prescribed. Maintain a heart-healthy diet low in saturated fats, exercise regularly, avoid smoking, limit alcohol, and manage stress.';
    }
    
    else if (lowerCommand.includes('side effect') || lowerCommand.includes('adverse')) {
        response = 'Common medication side effects may include dizziness, nausea, or fatigue. If you experience unusual symptoms, consult your doctor immediately. Never stop medications suddenly without medical advice. Keep a list of all medicines and inform healthcare providers about any allergies or reactions.';
    }
    
    else if (lowerCommand.includes('dose') || lowerCommand.includes('dosage')) {
        response = 'Always take medications exactly as prescribed by your doctor. Never increase or decrease doses without medical supervision. If you miss a dose, take it as soon as you remember unless it\'s close to the next scheduled dose. Set reminders to maintain consistency.';
    }
    
    else if (lowerCommand.includes('food') || lowerCommand.includes('meal')) {
        response = 'Some medicines should be taken with food to reduce stomach irritation, while others work better on an empty stomach. Your current schedule includes medicines after breakfast and dinner. Always follow specific food instructions provided by your pharmacist or doctor.';
    }
    
    else if (lowerCommand.includes('emergency') || lowerCommand.includes('urgent')) {
        response = 'In medical emergencies, call emergency services immediately. For medication-related emergencies like allergic reactions, severe side effects, or accidental overdose, seek immediate medical attention. Keep emergency contacts handy and inform medical staff about all current medications.';
    }
    
    else if (lowerCommand.includes('doctor') || lowerCommand.includes('appointment')) {
        response = 'Regular doctor visits are important for medication management. Bring your medicine list, discuss any concerns or side effects, ask about generic alternatives, and ensure prescriptions are up to date. Schedule follow-ups as recommended and never hesitate to ask questions.';
    }
    
    else if (lowerCommand.includes('reminder') || lowerCommand.includes('notification')) {
        response = 'Medicine reminders are set for 8 AM, 10 AM, 4 PM, and 10 PM daily. You can enable browser notifications, install this as a mobile app, or download calendar events. Consistent timing helps maintain medication effectiveness and builds healthy habits.';
    }
    
    else if (lowerCommand.includes('storage') || lowerCommand.includes('store')) {
        response = 'Store medicines in a cool, dry place away from direct sunlight and moisture. Keep them in original containers with labels. Some may require refrigeration. Check expiration dates regularly and dispose of expired medicines safely at pharmacy take-back programs.';
    }
    
    else if (lowerCommand.includes('travel') || lowerCommand.includes('vacation')) {
        response = 'When traveling, bring extra medication in carry-on luggage, keep medicines in original containers, carry prescriptions or doctor\'s notes, research medicine availability at your destination, and adjust timing for different time zones gradually.';
    }
    
    else if (lowerCommand.includes('cost') || lowerCommand.includes('price') || lowerCommand.includes('expensive')) {
        response = 'To reduce medication costs, ask about generic alternatives, use pharmacy discount programs, compare prices at different pharmacies, look for manufacturer coupons, consider 90-day supplies for better pricing, and discuss financial concerns with your doctor.';
    }
    
    // General health and wellness
    else if (lowerCommand.includes('diet') || lowerCommand.includes('nutrition')) {
        response = 'A healthy diet supports medication effectiveness. Focus on fruits, vegetables, whole grains, lean proteins, and healthy fats. Limit processed foods, excess sodium, and added sugars. Stay hydrated, eat regular meals, and consider how foods interact with your medications.';
    }
    
    else if (lowerCommand.includes('exercise') || lowerCommand.includes('physical activity')) {
        response = 'Regular exercise improves medication effectiveness, especially for heart and diabetes medicines. Start with light activities like walking, gradually increase intensity, aim for 150 minutes weekly, check with your doctor before starting new routines, and monitor how exercise affects your condition.';
    }
    
    else if (lowerCommand.includes('sleep') || lowerCommand.includes('rest')) {
        response = 'Quality sleep is crucial for medication effectiveness and overall health. Aim for 7-9 hours nightly, maintain consistent sleep schedules, create a relaxing bedtime routine, avoid screens before bed, and discuss sleep issues with your healthcare provider.';
    }
    
    // Help and general queries
    else if (lowerCommand.includes('help') || lowerCommand.includes('what can you do')) {
        response = 'I\'m MediBot, your health assistant! I can help with medicine schedules, stock levels, health information about blood pressure, diabetes, heart conditions, medication side effects, proper dosing, storage tips, and general wellness advice. Ask me about specific medicines, health conditions, or general health topics!';
    }
    
    else if (lowerCommand.includes('thank') || lowerCommand.includes('thanks')) {
        response = 'You\'re very welcome! I\'m here to help with all your health and medicine questions. Stay consistent with your medications and don\'t hesitate to ask if you need any assistance. Your health is important!';
    }
    
    // Default response for unrecognized commands
    else {
        response = 'I\'m your health assistant and can help with various topics including: medicine schedules and stock levels, blood pressure and heart health, diabetes management, medication side effects and dosing, proper medicine storage, health and nutrition advice, exercise recommendations, and general wellness tips. What would you like to know about?';
    }

    document.getElementById('voiceResponse').textContent = response;
    speak(response);
}

        function speak(text) {
            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // Medicine schedule functions
        function populateMedicineSchedules() {
            // Father's schedules
            populateTimeSlot('fatherMorningBefore', medicineData.father.morningBefore, 'father');
            populateTimeSlot('fatherMorningAfter', medicineData.father.morningAfter, 'father');
            populateTimeSlot('father4PM', medicineData.father.afternoon, 'father');
            populateTimeSlot('fatherNight', medicineData.father.night, 'father');

            // Mother's schedules
            populateTimeSlot('motherMorning', medicineData.mother.morning, 'mother');
            populateTimeSlot('motherNight', medicineData.mother.night, 'mother');
        }

        function populateTimeSlot(elementId, medicines, person) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            medicines.forEach((medicine, index) => {
                const medicineDiv = document.createElement('div');
                const isTakenToday = wasTakenToday(medicine.storageKey);
                const isLowStock = medicine.stock <= 5;
                
                let className = 'medicine-item';
                if (isLowStock) className += ' low-stock';
                if (isTakenToday) className += ' taken-today';
                
                medicineDiv.className = className;
                
                medicineDiv.innerHTML = `
                    <div class="medicine-info">
                        <div class="medicine-name">${medicine.name}</div>
                        <div class="medicine-details">${medicine.dosage}</div>
                        <div class="control-buttons">
                            <input type="checkbox" class="dose-checkbox" 
                                   id="dose_${medicine.storageKey}" 
                                   ${isTakenToday ? 'checked' : ''}
                                   onchange="toggleDoseTaken('${medicine.storageKey}', this.checked)">
                            <label for="dose_${medicine.storageKey}" class="dose-label">
                                ${isTakenToday ? '‚úÖ Taken today' : '‚è≥ Not taken today'}
                            </label>
                        </div>
                        ${isTakenToday ? '<div class="today-status">‚úÖ Completed for today</div>' : ''}
                    </div>
                    <div class="medicine-stock">
                        <div class="stock-count ${isLowStock ? 'low' : ''}">${medicine.stock}</div>
                        <div class="stock-label">tablets left</div>
                        <button class="btn btn-add" onclick="addStock('${medicine.storageKey}')">+ Add Stock</button>
                    </div>
                `;
                
                container.appendChild(medicineDiv);
            });
        }

        // Dose tracking functions
        function toggleDoseTaken(storageKey, taken) {
            markTakenToday(storageKey, taken);
            
            // Update the medicine display
            populateMedicineSchedules();
            
            if (taken) {
                // Reduce stock count
                reduceMedicineStock(storageKey);
                speak("Dose marked as taken. Stock updated.");
            } else {
                // Increase stock count back
                increaseMedicineStock(storageKey);
                speak("Dose unmarked. Stock restored.");
            }
            
            // Refresh displays
            generateStockAlerts();
        }

        function reduceMedicineStock(storageKey) {
            // Find and reduce stock
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.storageKey === storageKey && medicine.stock > 0) {
                            medicine.stock--;
                            saveToStorage(medicine.storageKey + '_stock', medicine.stock);
                        }
                    });
                });
            });
        }

        function increaseMedicineStock(storageKey) {
            // Find and increase stock
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.storageKey === storageKey && medicine.stock < medicine.originalStock) {
                            medicine.stock++;
                            saveToStorage(medicine.storageKey + '_stock', medicine.stock);
                        }
                    });
                });
            });
        }

        function addStock(storageKey, amount = 10) {
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.storageKey === storageKey) {
                            medicine.stock += amount;
                            saveToStorage(medicine.storageKey + '_stock', medicine.stock);
                            populateMedicineSchedules();
                            generateStockAlerts();
                            speak(`Added ${amount} tablets to ${medicine.name}. New stock: ${medicine.stock}`);
                        }
                    });
                });
            });
        }

        // Stock alert functions
        function generateStockAlerts() {
            const container = document.getElementById('stockAlerts');
            container.innerHTML = '';
            
            let hasLowStock = false;
            
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.stock <= 10) { // Show alerts for stocks <= 10
                            hasLowStock = true;
                            const alertDiv = document.createElement('div');
                            
                            let alertClass = 'alert';
                            let alertIcon = '‚ö†Ô∏è';
                            let alertTitle = 'Low Stock Warning';
                            
                            if (medicine.stock <= 2) {
                                alertClass += ' urgent-alert';
                                alertIcon = 'üö®';
                                alertTitle = 'URGENT: Critical Stock';
                            }
                            
                            alertDiv.className = alertClass;
                            alertDiv.innerHTML = `
                                <span class="alert-icon">${alertIcon}</span>
                                <div>
                                    <strong>${alertTitle}</strong><br>
                                    <strong>${medicine.name}</strong> - Only ${medicine.stock} tablets remaining!<br>
                                    <small>Person: ${person.charAt(0).toUpperCase() + person.slice(1)} | 
                                    Dosage: ${medicine.dosage}</small><br>
                                    <button class="btn btn-add" onclick="addStock('${medicine.storageKey}', 30)" 
                                            style="margin-top: 10px;">
                                        üì¶ Refill Stock (+30)
                                    </button>
                                </div>
                            `;
                            
                            container.appendChild(alertDiv);
                        }
                    });
                });
            });
            
            if (!hasLowStock) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #28a745;">
                        <h3>‚úÖ All Good!</h3>
                        <p>All medicines have adequate stock levels.</p>
                    </div>
                `;
            }
        }

        // Time and reminder functions
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `üïê Current Time: ${now.toLocaleTimeString()} | ${now.toLocaleDateString()}`;
        }

        function updateNextReminder() {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            let nextReminder = null;
            let nextReminderTime = null;
            
            for (const reminder of reminderTimes) {
                if (reminder.time > currentTime) {
                    nextReminder = reminder;
                    nextReminderTime = reminder.time;
                    break;
                }
            }
            
            // If no reminder found for today, show first reminder of tomorrow
            if (!nextReminder) {
                nextReminder = reminderTimes[0];
                nextReminderTime = reminderTimes[0].time + ' (Tomorrow)';
            }
            
            document.getElementById('nextReminderTime').textContent = nextReminderTime;
        }

        function setupReminderSystem() {
            // Clear existing intervals
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];
            
            // Set up new reminder intervals
            reminderTimes.forEach(reminder => {
                const [hours, minutes] = reminder.time.split(':').map(Number);
                
                const interval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === hours && now.getMinutes() === minutes && now.getSeconds() === 0) {
                        triggerReminder(reminder);
                    }
                }, 1000);
                
                reminderIntervals.push(interval);
            });
        }

        function triggerReminder(reminder) {
            const message = reminder.message;
            
            // Show browser notification
            if (notificationPermission === 'granted') {
                new Notification('üîî Medicine Reminder', {
                    body: message,
                    icon: 'https://via.placeholder.com/64/667eea/ffffff?text=üíä',
                    requireInteraction: true
                });
            }
            
            // Show custom notification
            showCustomNotification('üîî Medicine Reminder', message);
            
            // Speak reminder
            speak(`Medicine reminder: ${message}`);
        }

        // Additional utility functions
        function setupWebReminders() {
            alert('Web reminders are already active! Keep this tab open or install as an app for notifications.');
        }

        function downloadCalendar() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
            // Helper function to format date for ICS
            function formatDateForICS(date) {
                return date.getFullYear() + 
                    String(date.getMonth() + 1).padStart(2, '0') + 
                    String(date.getDate()).padStart(2, '0') + 'T' +
                    String(date.getHours()).padStart(2, '0') + 
                    String(date.getMinutes()).padStart(2, '0') + 
                    String(date.getSeconds()).padStart(2, '0');
        }
    
        let icsContent = 'BEGIN:VCALENDAR\r\n';
        icsContent += 'VERSION:2.0\r\n';
        icsContent += 'PRODID:-//MediBot//Medicine Reminders//EN\r\n';
        icsContent += 'CALSCALE:GREGORIAN\r\n';
    
        reminderTimes.forEach((reminder, index) => {
            const [hours, minutes] = reminder.time.split(':').map(Number);
            const eventDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
        
            icsContent += 'BEGIN:VEVENT\r\n';
            icsContent += `UID:medireminder-${index}-${Date.now()}@medibot.app\r\n`;
            icsContent += `DTSTART:${formatDateForICS(eventDate)}\r\n`;
            icsContent += `DTEND:${formatDateForICS(new Date(eventDate.getTime() + 15 * 60000))}\r\n`; // 15 min duration
            icsContent += `SUMMARY:üíä ${reminder.message}\r\n`;
            icsContent += `DESCRIPTION:Medicine Reminder\\n\\nMedicines: ${reminder.medicines.join(', ')}\\n\\nGenerated by MediBot Voice Assistant\r\n`;
            icsContent += `RRULE:FREQ=DAILY\r\n`;
            icsContent += `CATEGORIES:Health,Medicine,Reminder\r\n`;
            icsContent += `PRIORITY:1\r\n`;
            icsContent += `STATUS:CONFIRMED\r\n`;
            icsContent += `TRANSP:OPAQUE\r\n`;
            icsContent += 'END:VEVENT\r\n';
        });
    
        icsContent += 'END:VCALENDAR\r\n';
    
        try {
            const blob = new Blob([icsContent], { 
                type: 'text/calendar;charset=utf-8' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'medicine-reminders.ics';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        
            // Show success message
            showCustomNotification('‚úÖ Calendar Export Successful', 'Medicine reminders have been downloaded! Import the .ics file to your calendar app.');
            speak('Calendar file downloaded successfully. Import it to your calendar app to get daily reminders.');
        
        } catch (error) {
            console.error('Calendar download failed:', error);
            showCustomNotification('‚ùå Calendar Export Failed', 'Unable to download calendar file. Please try again.');
            speak('Sorry, calendar download failed. Please try again.');
        }
    }

        function setupEmailReminders() {
            const subject = 'Medicine Reminder Schedule';
            const body = encodeURIComponent(`
Hello,

Here are your daily medicine reminders:

${reminderTimes.map(r => `${r.time} - ${r.message}`).join('\n')}

Best regards,
MediBot System
            `);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing app...");
            init();
            updateNotificationStatus();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                populateMedicineSchedules();
                generateStockAlerts();
                checkLowStockReminders();
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Activated Medicine Reminder & Stock Alert System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                margin: 0 10px;
            }
        }

        /* Notification Setup Panel */
        .notification-setup {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .setup-button {
            background: #fff;
            color: #17a2b8;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-button:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .notification-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-granted {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #155724;
        }

        .status-denied {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }

        /* PWA Installation */
        .pwa-section {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
        }

        .install-button {
            background: #fff;
            color: #6f42c1;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            text-align: center;
            color: white;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: #28a745;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-status {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 50px;
            font-style: italic;
        }

        .voice-response {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Mobile responsive tabs */
        @media (max-width: 768px) {
            .tab-content {
                padding: 15px;
                max-height: 70vh;
            }
        }

        .person-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .person-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .person-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .person-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .time-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .medicine-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .medicine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .medicine-item.low-stock {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .medicine-item.taken-today {
            border-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #c3e6cb 100%);
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .medicine-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .medicine-stock {
            text-align: right;
            margin-left: 15px;
        }

        .stock-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }

        .stock-count.low {
            color: #dc3545;
        }

        .stock-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            align-items: center;
        }

        .dose-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .dose-label {
            font-size: 0.9rem;
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .alert {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            color: #721c24;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .alert-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .current-time {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Scrollable stock alerts container */
        .stock-alerts-container {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar for webkit browsers */
        .stock-alerts-container::-webkit-scrollbar {
            width: 8px;
        }

        .stock-alerts-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .urgent-alert {
            animation: pulse 2s infinite;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom notification popup */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Mobile responsive notification */
        @media (max-width: 768px) {
            .notification-popup {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-400px);
            }

            .notification-popup.show {
                transform: translateY(0);
            }
        }

        .today-status {
            font-size: 0.8rem;
            color: #28a745;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice-Activated Medicine System</h1>
            <p>Real Notifications & Reminders - Works Like a Mobile App!</p>
        </div>

        <!-- PWA Installation Section -->
        <div class="pwa-section">
            <h3>üì± Install as Mobile App</h3>
            <p>Make this a real app on your phone for better notifications!</p>
            <button class="install-button" id="installButton" onclick="installPWA()">
                üì≤ Install App on Home Screen
            </button>
            <div id="installInstructions" style="margin-top: 15px; font-size: 0.9rem;">
                <p><strong>Manual Installation:</strong></p>
                <p>‚Ä¢ On Android: Chrome menu ‚Üí "Add to Home screen"</p>
                <p>‚Ä¢ On iPhone: Safari Share button ‚Üí "Add to Home Screen"</p>
            </div>
        </div>

        <!-- Notification Setup Section -->
        <div class="notification-setup">
            <h3>üîî Smart Notification System</h3>
            <p>Enable different types of reminders:</p>
            
            <div>
                <button class="setup-button" onclick="enableBrowserNotifications()">
                    üîî Enable Browser Notifications
                </button>
                <button class="setup-button" onclick="setupWebReminders()">
                    ‚è∞ Setup Web Reminders
                </button>
                <button class="setup-button" onclick="downloadCalendar()">
                    üìÖ Download Calendar Events
                </button>
                <button class="setup-button" onclick="setupEmailReminders()">
                    üìß Email Reminders
                </button>
            </div>
            
            <div class="notification-status" id="notificationStatus">
                Click "Enable Browser Notifications" to get started!
            </div>
        </div>

        <!-- Voice Assistant Section -->
        <div class="voice-assistant">
            <h3>ü§ñ MediBot Voice Assistant</h3>
            <div>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    üé§
                </button>
                <button class="voice-button" onclick="stopSpeaking()" title="Stop Speaking">
                    üîá
                </button>
            </div>
            
            <div class="voice-status" id="voiceStatus">Click microphone to start listening</div>
            
            <div class="voice-transcript" id="voiceTranscript">
                Your speech will appear here...
            </div>
            
            <div class="voice-response" id="voiceResponse">
                MediBot's responses will appear here...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('father')">üë® Father</button>
            <button class="nav-tab" onclick="showTab('mother')">üë© Mother</button>
            <button class="nav-tab" onclick="showTab('alerts')">‚ö†Ô∏è Stock Alerts</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="current-time" id="currentTime"></div>
            
            <div class="alert">
                <span class="alert-icon">üí°</span>
                <div>
                    <strong>Pro Tip:</strong> Keep this tab open or install as an app for automatic reminders!
                    Next reminder: <span id="nextReminderTime">--</span>
                </div>
            </div>
<div class="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; border-color: #ffc107;">
    <span class="alert-icon">üîÑ</span>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
            <strong>Reset Medicine Data:</strong> Click to reset all medicine stocks to their original values.
            <br><small>Use this if you want to start fresh with full stock counts.</small>
        </div>
        <button class="setup-button" onclick="resetAllMedicineData()" style="margin-left: 15px; background: #ffc107; color: #212529;">
            üîÑ Reset All Stocks
        </button>
    </div>
</div>
        </div>
            
        <div id="father" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë®</div>
                    <div class="person-name">Father's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üåÖ</span>
                        Before Breakfast (8:00 AM)
                    </div>
                    <div id="fatherMorningBefore"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="fatherMorningAfter"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üïê</span>
                        4:00 PM
                    </div>
                    <div id="father4PM"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="fatherNight"></div>
                </div>
            </div>
        </div>

        <div id="mother" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë©</div>
                    <div class="person-name">Mother's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="motherMorning"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="motherNight"></div>
                </div>
            </div>
        </div>

        <div id="alerts" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üö® Stock Alerts & Warnings</h2>
            <div class="stock-alerts-container">
                <div id="stockAlerts"></div>
            </div>
        </div>
    </div>

    <!-- Custom Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <button class="close-btn" onclick="closeNotification()">&times;</button>
        <div id="notificationContent">
            <h4>üîî Medicine Reminder</h4>
            <p>It's time for your scheduled medicine!</p>
        </div>
    </div>

    <script>
        // PWA and Notification variables
        let deferredPrompt;
        let notificationPermission = Notification.permission;
        let reminderIntervals = [];

        // Medicine data structure with persistent storage keys
let medicineData = loadMedicineData() || {
    father: {
        morningBefore: [
            { name: "Maxi PhD", dosage: "30 days tablets", stock: 30, originalStock: 30 }
        ],
        morningAfter: [
            { name: "Metolol MF", dosage: "60mg - 30 days", stock: 30, originalStock: 30 },
            { name: "Pilclop", dosage: "75mg - 30 days", stock: 30, originalStock: 30 },
            { name: "Cordarone", dosage: "30 days", stock: 30, originalStock: 30 },
            { name: "Orofer XT", dosage: "30 tablets", stock: 30, originalStock: 30 },
            { name: "Hyqvit", dosage: "30 tablets", stock: 30, originalStock: 30 }
        ],
        afternoon: [
            { name: "Acitrom", dosage: "1mg/2mg alternate days - 30 days", stock: 30, originalStock: 30 }
        ],
        night: [
            { name: "Rotin F", dosage: "30 tablets", stock: 30, originalStock: 30 },
            { name: "Telmiford", dosage: "40mg - 30 tablets", stock: 30, originalStock: 30 }
        ]
    },
    mother: {
        morning: [
            { name: "Telzox H", dosage: "30 tablets", stock: 30, originalStock: 30 },
            { name: "Cinod", dosage: "10mg - 1 tablet (Morning dose)", stock: 60, originalStock: 60 },
            { name: "Zavamet", dosage: "50/500 - 1 tablet (Morning dose)", stock: 60, originalStock: 60 }
        ],
        night: [
            { name: "Cinod", dosage: "10mg - 1 tablet (Evening dose)", stock: 60, originalStock: 60 },
            { name: "Zavamet", dosage: "50/500 - 1 tablet (Evening dose)", stock: 60, originalStock: 60 }
        ]
    }
};

// Enhanced storage system for persistent medicine data
let appStorage = {
    medicineData: null,
    dailyTracking: {}
};

// Load medicine data from memory with persistent stock levels
function loadMedicineData() {
    try {
        const saved = window.medicineDataStore;
        if (saved) {
            console.log("Loading saved medicine data with persistent stock levels");
            return saved;
        }
    } catch (error) {
        console.error("Error loading medicine data:", error);
    }
    return null;
}

// Save medicine data to memory - Enhanced for persistence
function saveMedicineData() {
    try {
        window.medicineDataStore = JSON.parse(JSON.stringify(medicineData));
        console.log("Medicine data saved with current stock levels");
    } catch (error) {
        console.error("Error saving medicine data:", error);
    }
}

// Enhanced reset function - Only this should reset stock levels
function resetAllMedicineData() {
    if (confirm("Are you sure you want to reset ALL medicine stocks to their original values? This cannot be undone.")) {
        // Reset stock levels to original
        Object.keys(medicineData).forEach(person => {
            Object.keys(medicineData[person]).forEach(timeSlot => {
                medicineData[person][timeSlot].forEach(medicine => {
                    medicine.stock = medicine.originalStock;
                });
            });
        });
        
        // Clear all daily tracking data
        appStorage.dailyTracking = {};
        
        // Save the reset data
        saveMedicineData();
        
        // Refresh displays
        populateMedicineSchedules();
        generateStockAlerts();
        
        showNotification("‚úÖ All medicine stocks have been reset to original values!");
        speak("All medicine stocks have been reset to their original values.");
        
        console.log("All medicine data reset to original values");
    }
}


        // Medicine reminder times (24-hour format)
        const reminderTimes = [
            { time: '08:00', message: "Time for Father's morning medicine (before breakfast) - Maxi PhD", medicines: ["Maxi PhD"] },
            { time: '10:00', message: "Time for after-breakfast medicines", medicines: ["Metolol MF", "Pilclop", "Cordarone", "Orofer XT", "Hyqvit", "Telzox H", "Cinod", "Zavamet"] },
            { time: '16:00', message: "Time for Father's 4 PM medicine - Acitrom", medicines: ["Acitrom"] },
            { time: '22:00', message: "Time for evening medicines", medicines: ["Rotin F", "Telmiford", "Cinod", "Zavamet"] }
        ];
        //storage function for daily tracking
        function saveToStorage(key, value) {
            appStorage[key] = JSON.stringify(value);
        }

        function getFromStorage(key) {
            const value = appStorage[key];
            return value ? JSON.parse(value) : null;
        }

        function getTodayKey() {
            return new Date().toDateString();
        }

        // Enhanced function to check if medicine was taken today
function wasTakenToday(storageKey) {
    const todayKey = getTodayKey();
    const takenData = getFromStorage(storageKey + '_taken_' + todayKey);
    return takenData === true;
}

// Enhanced function to mark medicine as taken with stock management
function markTakenToday(storageKey, taken = true) {
    const todayKey = getTodayKey();
    const previouslyTaken = wasTakenToday(storageKey);
    
    // Save the daily tracking data
    saveToStorage(storageKey + '_taken_' + todayKey, taken);
    
    // Handle stock changes based on taken status
    if (taken && !previouslyTaken) {
        // Medicine was just marked as taken - reduce stock
        reduceMedicineStock(storageKey);
    } else if (!taken && previouslyTaken) {
        // Medicine was unmarked as taken - increase stock back
        increaseMedicineStock(storageKey);
    }
}
       // Enhanced initialization function
function init() {
    console.log("Initializing MediBot system with persistent stock management...");
    
    // Load saved data first (this maintains persistent stock levels)
    loadSavedData();
    
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    
    // Setup PWA installation
    setupPWA();
    
    // Setup reminder system
    setupReminderSystem();
    
    // Update next reminder display
    updateNextReminder();
    setInterval(updateNextReminder, 60000);
    
    // Check for low stock reminders every 5 minutes
    setInterval(checkLowStockReminders, 5 * 60 * 1000);
    
    // Initialize voice if available
    initializeVoiceRecognition();
    
    // Populate medicine schedules with current stock levels
    console.log("Populating medicine schedules with persistent stock data...");
    populateMedicineSchedules();
    
    // Generate stock alerts
    generateStockAlerts();
    
    // Auto-greet user with stock status
    setTimeout(() => {
        let stockSummary = getStockSummary();
        speak(`Welcome to MediBot! Medicine schedules loaded. ${stockSummary}`);
        checkLowStockReminders();
    }, 2000);
}
// New function to get stock summary
function getStockSummary() {
    let lowStockCount = 0;
    let totalMedicines = 0;
    
    Object.keys(medicineData).forEach(person => {
        Object.keys(medicineData[person]).forEach(timeSlot => {
            medicineData[person][timeSlot].forEach(medicine => {
                totalMedicines++;
                if (medicine.stock <= 5) {
                    lowStockCount++;
                }
            });
        });
    });
    
    if (lowStockCount > 0) {
        return `Warning: ${lowStockCount} medicine${lowStockCount > 1 ? 's' : ''} running low on stock.`;
    }
    return `All ${totalMedicines} medicines have adequate stock levels.`;
}

// Enhanced page visibility handler to maintain persistence
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Page became visible - refresh displays but maintain stock levels
        console.log("Page visible - refreshing displays with persistent data");
        populateMedicineSchedules();
        generateStockAlerts();
        checkLowStockReminders();
    }
});

// Auto-save mechanism (backup save every 5 minutes)
setInterval(() => {
    saveMedicineData();
    console.log("Auto-save: Medicine data backed up");
}, 5 * 60 * 1000);

        // Enhanced load saved data function
function loadSavedData() {
    console.log("Loading saved data with persistent stock management...");
    // Load daily tracking data for today's status
    Object.keys(medicineData).forEach(person => {
        Object.keys(medicineData[person]).forEach(timeSlot => {
            medicineData[person][timeSlot].forEach((medicine, index) => {
                if (!medicine.storageKey) {
                    medicine.storageKey = `${person}_${timeSlot}_${index}_${medicine.name.replace(/\s+/g, '_')}`;
                }
            });
        });
    });
    
    console.log("Persistent stock levels maintained successfully");
}

        // PWA setup
        function setupPWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")');
            }

            // Listen for PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installButton').style.display = 'inline-block';
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                deferredPrompt = null;
            });
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('Add to Home Screen: Use your browser menu to add this app to your home screen');
            }
        }

        // Notification functions
        function enableBrowserNotifications() {
            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                updateNotificationStatus();
                if (permission === 'granted') {
                    new Notification('üéâ Notifications Enabled!', {
                        body: 'You will now receive medicine reminders',
                        icon: 'https://via.placeholder.com/64/28a745/ffffff?text=‚úì'
                    });
                }
            });
        }

        function updateNotificationStatus() {
            const statusDiv = document.getElementById('notificationStatus');
            if (notificationPermission === 'granted') {
                statusDiv.className = 'notification-status status-granted';
                statusDiv.innerHTML = '‚úÖ Browser notifications are enabled! You\'ll receive automatic reminders.';
            } else if (notificationPermission === 'denied') {
                statusDiv.className = 'notification-status status-denied';
                statusDiv.innerHTML = '‚ùå Notifications blocked. Please enable in browser settings.';
            } else {
                statusDiv.className = 'notification-status status-pending';
                statusDiv.innerHTML = '‚è≥ Click "Enable Browser Notifications" to get automatic reminders.';
            }
        }

        function showCustomNotification(title, message) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `<h4>${title}</h4><p>${message}</p>`;
            popup.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                closeNotification();
            }, 10000);
        }

        function closeNotification() {
            document.getElementById('notificationPopup').classList.remove('show');
        }

        // Voice recognition functions
        let recognition;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('üé§ Listening... Speak now!');
                    document.getElementById('voiceButton').classList.add('listening');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voiceTranscript').textContent = transcript;
                    processVoiceCommand(transcript);
                };

                recognition.onerror = function(event) {
                    updateVoiceStatus('‚ùå Error: ' + event.error);
                    document.getElementById('voiceButton').classList.remove('listening');
                    isListening = false;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening');
                    updateVoiceStatus('Click microphone to start listening');
                };
            } else {
                updateVoiceStatus('‚ùå Voice recognition not supported in this browser');
                document.getElementById('voiceButton').disabled = true;
            }
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                alert('Voice recognition not available');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function updateVoiceStatus(message) {
            document.getElementById('voiceStatus').textContent = message;
        }

        
// Enhanced Voice Command Processing with Web Search Integration
async function processVoiceCommand(command) {
    const lowerCommand = command.toLowerCase();
    let response = '';
    
    // Check if it's about the existing medicine schedule first
    if (lowerCommand.includes('father') && (lowerCommand.includes('medicine') || lowerCommand.includes('medication'))) {
        response = 'Father takes Maxi PhD before breakfast, then Metolol, Pilclop, Cordarone, Orofer and Hyqvit after breakfast. Acitrom at 4 PM, and Rotin F with Telmiford at night.';
    } else if (lowerCommand.includes('mother') && (lowerCommand.includes('medicine') || lowerCommand.includes('medication'))) {
        response = 'Mother takes Telzox H, Cinod and Zavamet after breakfast. Then Cinod and Zavamet again at night.';
    } else if (lowerCommand.includes('stock') || lowerCommand.includes('count')) {
        response = 'Let me check the stock levels...';
        let lowStockItems = [];
        Object.keys(medicineData).forEach(person => {
            Object.keys(medicineData[person]).forEach(timeSlot => {
                medicineData[person][timeSlot].forEach(medicine => {
                    if (medicine.stock <= 5) {
                        lowStockItems.push(`${medicine.name} has ${medicine.stock} left`);
                    }
                });
            });
        });
        if (lowStockItems.length > 0) {
            response += ' Warning: ' + lowStockItems.join(', ');
        } else {
            response += ' All medicines have adequate stock levels.';
        }
    } 
    // Enhanced medicine information queries
    else if (lowerCommand.includes('paracetamol') || lowerCommand.includes('acetaminophen')) {
        response = 'Paracetamol (Acetaminophen): Take 500-1000mg every 4-6 hours as needed for pain or fever. Maximum 4000mg per day. Can be taken with or without food. Wait at least 4 hours between doses.';
    } else if (lowerCommand.includes('ibuprofen')) {
        response = 'Ibuprofen: Take 200-400mg every 4-6 hours as needed for pain, fever, or inflammation. Maximum 1200mg per day without doctor supervision. Take with food to avoid stomach upset. Not recommended if you have stomach ulcers or kidney problems.';
    } else if (lowerCommand.includes('aspirin')) {
        response = 'Aspirin: For pain/fever: 325-650mg every 4 hours. For heart protection: 81mg daily (consult doctor first). Take with food to reduce stomach irritation. Avoid if allergic to aspirin or if you have bleeding disorders.';
    } else if (lowerCommand.includes('vitamin d')) {
        response = 'Vitamin D: Typical dose is 1000-2000 IU daily with a meal containing fat for better absorption. Best taken in morning. Get blood levels checked annually to ensure optimal range.';
    } else if (lowerCommand.includes('vitamin c')) {
        response = 'Vitamin C: Typical dose is 500-1000mg daily. Take with food to reduce stomach upset. Divide large doses throughout the day for better absorption. Excess is usually excreted safely.';
    } else if (lowerCommand.includes('calcium')) {
        response = 'Calcium: Take 500-600mg at a time with food for best absorption. Don\'t take with iron supplements. Best absorbed when taken separately from high-fiber meals. Include vitamin D for better absorption.';
    } else if (lowerCommand.includes('iron')) {
        response = 'Iron: Take on empty stomach for best absorption, or with vitamin C. If stomach upset occurs, take with small amount of food. Avoid with tea, coffee, or calcium. Take 2 hours apart from other medications.';
    } else if (lowerCommand.includes('antibiotic')) {
        response = 'Antibiotics: Always complete the full course even if feeling better. Take at evenly spaced intervals. Some need food, others need empty stomach - check your specific medication. Don\'t share with others or save leftover pills.';
    } else if (lowerCommand.includes('blood pressure') || lowerCommand.includes('bp medicine')) {
        response = 'Blood pressure medications: Take at the same time daily, usually morning. Don\'t skip doses. Monitor BP regularly. Don\'t stop suddenly without doctor consultation. Common types include ACE inhibitors, beta-blockers, and diuretics.';
    } else if (lowerCommand.includes('diabetes') || lowerCommand.includes('metformin')) {
        response = 'Diabetes medications: Take with meals to reduce stomach upset. Monitor blood sugar as directed. Metformin is usually taken twice daily with breakfast and dinner. Always carry glucose tablets for low blood sugar emergencies.';
    }
    // General medicine timing queries
    else if (lowerCommand.includes('when') && lowerCommand.includes('take')) {
        if (lowerCommand.includes('morning')) {
            response = 'Morning medicines are typically taken: Before breakfast (7-8 AM) or After breakfast (9-10 AM). Check your specific medication instructions for "with food" or "empty stomach" requirements.';
        } else if (lowerCommand.includes('night') || lowerCommand.includes('evening')) {
            response = 'Evening medicines are typically taken: After dinner (8-10 PM) or Before bedtime (10-11 PM). Some medications work better at night, like certain blood pressure medicines and cholesterol medications.';
        } else {
            response = 'Medicine timing depends on the specific medication. Generally: Morning medicines after breakfast, afternoon medicines before lunch, and evening medicines after dinner. Always follow your doctor\'s specific instructions.';
        }
    }
    // Side effects queries
    else if (lowerCommand.includes('side effect')) {
        response = 'Common medicine side effects include nausea, dizziness, drowsiness, or stomach upset. Always read the medication leaflet. Contact your doctor if you experience severe side effects, allergic reactions, or if side effects persist. Never stop prescribed medications without consulting your healthcare provider.';
    }
    // Food interactions
    else if (lowerCommand.includes('food') || lowerCommand.includes('eat')) {
        response = 'Medicine and food interactions: Some medicines need food to prevent stomach upset, others need empty stomach for absorption. Avoid alcohol with most medications. Grapefruit can interact with many medicines. High-fiber foods can reduce absorption of some drugs. Always check your specific medication instructions.';
    }
    // Emergency situations
    else if (lowerCommand.includes('overdose') || lowerCommand.includes('too much')) {
        response = 'If you suspect overdose: Call emergency services immediately or contact poison control. Don\'t wait for symptoms. Bring the medication bottle with you. Never induce vomiting unless specifically told by medical professionals.';
    } else if (lowerCommand.includes('missed dose') || lowerCommand.includes('forgot')) {
        response = 'For missed doses: Take as soon as you remember unless it\'s almost time for the next dose. Never double dose. For critical medications like heart or seizure medicines, contact your doctor. Set alarms or use pill organizers to prevent missed doses.';
    }
    // General health queries
    else if (lowerCommand.includes('how often') || lowerCommand.includes('how many times')) {
        response = 'Medication frequency varies: Once daily (every 24 hours), Twice daily (every 12 hours), Three times daily (every 8 hours), Four times daily (every 6 hours). "As needed" means only when symptoms occur, not on a schedule. Always follow your prescription label.';
    } else if (lowerCommand.includes('storage') || lowerCommand.includes('store')) {
        response = 'Medicine storage: Keep in cool, dry place away from light. Bathroom medicine cabinets are too humid. Don\'t freeze unless specified. Keep in original containers with labels. Dispose of expired medicines safely at pharmacy take-back programs.';
    }
    // If no specific medicine info found, provide general guidance
    else if (lowerCommand.includes('medicine') || lowerCommand.includes('medication') || lowerCommand.includes('drug') || lowerCommand.includes('pill') || lowerCommand.includes('tablet')) {
        response = 'I can help with general medicine information, timing, and the family schedule. For specific medications, always consult your doctor or pharmacist. Ask me about common medicines like paracetamol, ibuprofen, or about medicine timing, side effects, or interactions.';
    } 
    // System-specific queries
    else if (lowerCommand.includes('schedule') || lowerCommand.includes('reminder')) {
        response = 'Current reminders are set for: 8 AM (Father\'s morning medicine), 10 AM (after-breakfast medicines), 4 PM (Acitrom), and 10 PM (evening medicines). I can also provide general medicine timing advice.';
    } else {
        response = 'I\'m MediBot, your medicine assistant! I can help with: Family medicine schedules, stock levels, general medicine information (paracetamol, ibuprofen, etc.), timing advice, side effects, and medication safety. What would you like to know?';
    }
    
    document.getElementById('voiceResponse').textContent = response;
    speak(response);
}


        function speak(text) {
            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // Medicine schedule functions
        function populateMedicineSchedules() {
            // Father's schedules
            populateTimeSlot('fatherMorningBefore', medicineData.father.morningBefore, 'father');
            populateTimeSlot('fatherMorningAfter', medicineData.father.morningAfter, 'father');
            populateTimeSlot('father4PM', medicineData.father.afternoon, 'father');
            populateTimeSlot('fatherNight', medicineData.father.night, 'father');

            // Mother's schedules
            populateTimeSlot('motherMorning', medicineData.mother.morning, 'mother');
            populateTimeSlot('motherNight', medicineData.mother.night, 'mother');
        }

        function populateTimeSlot(elementId, medicines, person) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            medicines.forEach((medicine, index) => {
                if (!medicine.storageKey) {
                    medicine.storageKey = `${person}_${elementId}_${index}_${medicine.name.replace(/\s+/g, '_')}`;
        }
                const medicineDiv = document.createElement('div');
                const isTakenToday = wasTakenToday(medicine.storageKey);
                const isLowStock = medicine.stock <= 5;
                
                let className = 'medicine-item';
                if (isLowStock) className += ' low-stock';
                if (isTakenToday) className += ' taken-today';
                
                medicineDiv.className = className;
                
                medicineDiv.innerHTML = `
                    <div class="medicine-info">
                        <div class="medicine-name">${medicine.name}</div>
                        <div class="medicine-details">${medicine.dosage}</div>
                        <div class="control-buttons">
                            <input type="checkbox" class="dose-checkbox" 
                                   id="dose_${medicine.storageKey}" 
                                   ${isTakenToday ? 'checked' : ''}
                                   onchange="toggleDoseTaken('${medicine.storageKey}', this.checked)">
                            <label for="dose_${medicine.storageKey}" class="dose-label">
                                ${isTakenToday ? '‚úÖ Taken today' : '‚è≥ Not taken today'}
                            </label>
                        </div>
                        ${isTakenToday ? '<div class="today-status">‚úÖ Completed for today</div>' : ''}
                    </div>
                    <div class="medicine-stock">
                        <div class="stock-count ${isLowStock ? 'low' : ''}">${medicine.stock}</div>
                        <div class="stock-label">tablets left</div>
                        <button class="btn btn-add" onclick="addStock('${medicine.storageKey}')">+ Add Stock</button>
                    </div>
                `;
                
                container.appendChild(medicineDiv);
            });
        }

        // Enhanced dose tracking function
function toggleDoseTaken(storageKey, taken) {
    const previouslyTaken = wasTakenToday(storageKey);
    
    // Mark as taken/untaken for today
    markTakenToday(storageKey, taken);
    
    // Update displays
    populateMedicineSchedules();
    generateStockAlerts();
    
    // Provide feedback
    if (taken && !previouslyTaken) {
        speak("Medicine marked as taken. Stock updated.");
    } else if (!taken && previouslyTaken) {
        speak("Medicine unmarked. Stock restored.");
    }
}

        // Enhanced stock reduction function
function reduceMedicineStock(storageKey) {
    Object.keys(medicineData).forEach(person => {
        Object.keys(medicineData[person]).forEach(timeSlot => {
            medicineData[person][timeSlot].forEach((medicine) => {
                if (medicine.storageKey === storageKey && medicine.stock > 0) {
                    medicine.stock--;
                    console.log(`Reduced stock for ${medicine.name}: ${medicine.stock + 1} ‚Üí ${medicine.stock}`);
                    saveMedicineData(); // Save immediately after stock change
                }
            });
        });
    });
}

        // Enhanced stock increase function
function increaseMedicineStock(storageKey) {
    Object.keys(medicineData).forEach(person => {
        Object.keys(medicineData[person]).forEach(timeSlot => {
            medicineData[person][timeSlot].forEach((medicine) => {
                if (medicine.storageKey === storageKey) {
                    medicine.stock++;
                    console.log(`Increased stock for ${medicine.name}: ${medicine.stock - 1} ‚Üí ${medicine.stock}`);
                    saveMedicineData(); // Save immediately after stock change
                }
            });
        });
    });
}
  // Enhanced add stock function
function addStock(storageKey, amount = 10) {
    Object.keys(medicineData).forEach(person => {
        Object.keys(medicineData[person]).forEach(timeSlot => {
            medicineData[person][timeSlot].forEach((medicine) => {
                if (medicine.storageKey === storageKey) {
                    const oldStock = medicine.stock;
                    medicine.stock += amount;
                    saveMedicineData(); // Save immediately
                    
                    populateMedicineSchedules();
                    generateStockAlerts();
                    
                    console.log(`Stock added: ${medicine.name} ${oldStock} ‚Üí ${medicine.stock}`);
                    speak(`Added ${amount} tablets to ${medicine.name}. New stock: ${medicine.stock}`);
                }
            });
        });
    });
}

        // Stock alert functions
        function generateStockAlerts() {
            const container = document.getElementById('stockAlerts');
            container.innerHTML = '';
            
            let hasLowStock = false;
            
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine) => {
                        if (medicine.stock <= 10) { // Show alerts for stocks <= 10
                            hasLowStock = true;
                            const alertDiv = document.createElement('div');
                            
                            let alertClass = 'alert';
                            let alertTitle = 'Low Stock Warning';
                            
                            if (medicine.stock <= 2) {
                                alertClass += ' urgent-alert';
                                alertTitle = 'URGENT: Critical Stock';
                            }
                            
                            alertDiv.className = alertClass;
                            alertDiv.innerHTML = `
                                <span class="alert-icon">${alertIcon}</span>
                                <div>
                                    <strong>${alertTitle}</strong><br>
                                    <strong>${medicine.name}</strong> - Only ${medicine.stock} tablets remaining!<br>
                                    <small>Person: ${person.charAt(0).toUpperCase() + person.slice(1)} | 
                                    Dosage: ${medicine.dosage}</small><br>
                                    <button class="btn btn-add" onclick="addStock('${medicine.storageKey}', 30)" 
                                            style="margin-top: 10px;">
                                        üì¶ Refill Stock (+30)
                                    </button>
                                </div>
                            `;
                            
                            container.appendChild(alertDiv);
                        }
                    });
                });
            });
            
            if (!hasLowStock) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #28a745;">
                        <h3>‚úÖ All Good!</h3>
                        <p>All medicines have adequate stock levels.</p>
                    </div>
                `;
            }
        }

        // Time and reminder functions
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                `üïê Current Time: ${now.toLocaleTimeString()} | ${now.toLocaleDateString()}`;
        }

        function updateNextReminder() {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            let nextReminder = null;
            let nextReminderTime = null;
            
            for (const reminder of reminderTimes) {
                if (reminder.time > currentTime) {
                    nextReminder = reminder;
                    nextReminderTime = reminder.time;
                    break;
                }
            }
            
            // If no reminder found for today, show first reminder of tomorrow
            if (!nextReminder) {
                nextReminder = reminderTimes[0];
                nextReminderTime = reminderTimes[0].time + ' (Tomorrow)';
            }
            
            document.getElementById('nextReminderTime').textContent = nextReminderTime;
        }

        function setupReminderSystem() {
            // Clear existing intervals
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];
            
            // Set up new reminder intervals
            reminderTimes.forEach(reminder => {
                const [hours, minutes] = reminder.time.split(':').map(Number);
                
                const interval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === hours && now.getMinutes() === minutes && now.getSeconds() === 0) {
                        triggerReminder(reminder);
                    }
                }, 1000);
                
                reminderIntervals.push(interval);
            });
        }

        function triggerReminder(reminder) {
            const message = reminder.message;
            
            // Show browser notification
            if (notificationPermission === 'granted') {
                new Notification('üîî Medicine Reminder', {
                    body: message,
                    icon: 'https://via.placeholder.com/64/667eea/ffffff?text=üíä',
                    requireInteraction: true
                });
            }
            
            // Show custom notification
            showCustomNotification('üîî Medicine Reminder', message);
            
            // Speak reminder
            speak(`Medicine reminder: ${message}`);
        }

        // Additional utility functions
        function setupWebReminders() {
            alert('Web reminders are already active! Keep this tab open or install as an app for notifications.');
        }

function downloadCalendar() {
    // Try to use Web Calendar API if available
    if ('calendar' in navigator) {
        // Future API - not widely supported yet
        alert('Calendar API integration coming soon. For now, please manually add these reminders to your calendar:\n\n' +
              reminderTimes.map(r => `${r.time} - ${r.message}`).join('\n'));
        return;
    }
    
    // Create Google Calendar links for each reminder
    const calendarLinks = [];
    const baseGoogleCalendarUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
    
    reminderTimes.forEach((reminder, index) => {
        const [hours, minutes] = reminder.time.split(':');
        const now = new Date();
        const eventDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        
        // Format date for Google Calendar (YYYYMMDDTHHMMSSZ)
        const startTime = eventDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const endTime = new Date(eventDate.getTime() + 15 * 60000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        
        const params = new URLSearchParams({
            text: `Medicine Reminder: ${reminder.message}`,
            dates: `${startTime}/${endTime}`,
            details: `Medicine Reminder - ${reminder.medicines.join(', ')}`,
            recur: 'RRULE:FREQ=DAILY',
            ctz: Intl.DateTimeFormat().resolvedOptions().timeZone
        });
        
        calendarLinks.push({
            time: reminder.time,
            message: reminder.message,
            url: `${baseGoogleCalendarUrl}&${params.toString()}`
        });
    });
    
    // Create a popup window with calendar options
    const calendarWindow = window.open('', 'calendar', 'width=600,height=800,scrollbars=yes');
    calendarWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Add Medicine Reminders to Calendar</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .reminder-item { 
                    background: #f5f5f5; 
                    padding: 15px; 
                    margin: 10px 0; 
                    border-radius: 5px; 
                    border-left: 4px solid #007bff;
                }
                .calendar-btn {
                    background: #4285f4;
                    color: white;
                    padding: 10px 15px;
                    text-decoration: none;
                    border-radius: 5px;
                    margin: 5px;
                    display: inline-block;
                }
                .calendar-btn:hover { background: #3367d6; }
                .instructions {
                    background: #e7f3ff;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                }
            </style>
        </head>
        <body>
            <h2>üìÖ Add Medicine Reminders to Your Calendar</h2>
            <div class="instructions">
                <strong>Instructions:</strong><br>
                ‚Ä¢ Click the "Add to Google Calendar" button for each reminder<br>
                ‚Ä¢ Each link will open in a new tab with the event pre-filled<br>
                ‚Ä¢ Click "Save" in Google Calendar to add the recurring reminder<br>
                ‚Ä¢ For other calendar apps, manually create recurring events with the times shown
            </div>
            
            ${calendarLinks.map(link => `
                <div class="reminder-item">
                    <strong>‚è∞ ${link.time}</strong><br>
                    ${link.message}<br><br>
                    <a href="${link.url}" target="_blank" class="calendar-btn">
                        üìÖ Add to Google Calendar
                    </a>
                </div>
            `).join('')}
            
            <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                <strong>üí° Alternative Methods:</strong><br>
                ‚Ä¢ <strong>iPhone:</strong> Use Siri - "Hey Siri, remind me to take medicine at [time] every day"<br>
                ‚Ä¢ <strong>Android:</strong> Use Google Assistant - "Hey Google, set a daily reminder for [time] to take medicine"<br>
                ‚Ä¢ <strong>Manual:</strong> Create recurring events in your preferred calendar app
            </div>
            
            <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px;">
                Close
            </button>
        </body>
        </html>
    `);
}

        function setupEmailReminders() {
            const subject = 'Medicine Reminder Schedule';
            const body = encodeURIComponent(`
Hello,

Here are your daily medicine reminders:

${reminderTimes.map(r => `${r.time} - ${r.message}`).join('\n')}

Best regards,
MediBot System
            `);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing app...");
            init();
            updateNotificationStatus();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                populateMedicineSchedules();
                generateStockAlerts();
                checkLowStockReminders();
            }
        });
    </script>
</body>
</html>
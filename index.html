<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Activated Medicine Reminder & Stock Alert System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Notification Setup Panel */
        .notification-setup {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .setup-button {
            background: #fff;
            color: #17a2b8;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-button:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .notification-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-granted {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #155724;
        }

        .status-denied {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }

        /* PWA Installation */
        .pwa-section {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
        }

        .install-button {
            background: #fff;
            color: #6f42c1;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            text-align: center;
            color: white;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: #28a745;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-status {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 50px;
            font-style: italic;
        }

        .voice-response {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .person-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .person-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .person-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .person-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .time-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .medicine-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .medicine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .medicine-item.low-stock {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .medicine-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .medicine-stock {
            text-align: right;
            margin-left: 15px;
        }

        .stock-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }

        .stock-count.low {
            color: #dc3545;
        }

        .stock-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-take {
            background: #28a745;
            color: white;
        }

        .btn-take:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .alert {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            color: #721c24;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .alert-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .current-time {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .urgent-alert {
            animation: pulse 2s infinite;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom notification popup */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 Voice-Activated Medicine System</h1>
            <p>Real Notifications & Reminders - Works Like a Mobile App!</p>
        </div>

        <!-- PWA Installation Section -->
        <div class="pwa-section">
            <h3>📱 Install as Mobile App</h3>
            <p>Make this a real app on your phone for better notifications!</p>
            <button class="install-button" id="installButton" onclick="installPWA()">
                📲 Install App on Home Screen
            </button>
            <div id="installInstructions" style="margin-top: 15px; font-size: 0.9rem;">
                <p><strong>Manual Installation:</strong></p>
                <p>• On Android: Chrome menu → "Add to Home screen"</p>
                <p>• On iPhone: Safari Share button → "Add to Home Screen"</p>
            </div>
        </div>

        <!-- Notification Setup Section -->
        <div class="notification-setup">
            <h3>🔔 Smart Notification System</h3>
            <p>Enable different types of reminders:</p>
            
            <div>
                <button class="setup-button" onclick="enableBrowserNotifications()">
                    🔔 Enable Browser Notifications
                </button>
                <button class="setup-button" onclick="setupWebReminders()">
                    ⏰ Setup Web Reminders
                </button>
                <button class="setup-button" onclick="downloadCalendar()">
                    📅 Download Calendar Events
                </button>
                <button class="setup-button" onclick="setupEmailReminders()">
                    📧 Email Reminders
                </button>
            </div>
            
            <div class="notification-status" id="notificationStatus">
                Click "Enable Browser Notifications" to get started!
            </div>
        </div>

        <!-- Voice Assistant Section -->
        <div class="voice-assistant">
            <h3>🤖 MediBot Voice Assistant</h3>
            <div>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    🎤
                </button>
                <button class="voice-button" onclick="stopSpeaking()" title="Stop Speaking">
                    🔇
                </button>
            </div>
            
            <div class="voice-status" id="voiceStatus">Click microphone to start listening</div>
            
            <div class="voice-transcript" id="voiceTranscript">
                Your speech will appear here...
            </div>
            
            <div class="voice-response" id="voiceResponse">
                MediBot's responses will appear here...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showTab('father')">👨 Father's Medicines</button>
            <button class="nav-tab" onclick="showTab('mother')">👩 Mother's Medicines</button>
            <button class="nav-tab" onclick="showTab('alerts')">⚠️ Stock Alerts</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="current-time" id="currentTime"></div>
            
            <div class="alert">
                <span class="alert-icon">💡</span>
                <div>
                    <strong>Pro Tip:</strong> Keep this tab open or install as an app for automatic reminders!
                    Next reminder: <span id="nextReminderTime">--</span>
                </div>
            </div>
        </div>

        <div id="father" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">👨</div>
                    <div class="person-name">Father's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🌅</span>
                        Before Breakfast (Morning)
                    </div>
                    <div id="fatherMorningBefore"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍳</span>
                        After Breakfast
                    </div>
                    <div id="fatherMorningAfter"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🕐</span>
                        4 PM
                    </div>
                    <div id="father4PM"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍽️</span>
                        After Dinner
                    </div>
                    <div id="fatherNight"></div>
                </div>
            </div>
        </div>

        <div id="mother" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">👩</div>
                    <div class="person-name">Mother's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍳</span>
                        After Breakfast
                    </div>
                    <div id="motherMorning"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍽️</span>
                        After Dinner
                    </div>
                    <div id="motherNight"></div>
                </div>
            </div>
        </div>

        <div id="alerts" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">🚨 Stock Alerts & Warnings</h2>
            <div id="stockAlerts"></div>
        </div>
    </div>

    <!-- Custom Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <button class="close-btn" onclick="closeNotification()">&times;</button>
        <div id="notificationContent">
            <h4>🔔 Medicine Reminder</h4>
            <p>It's time for your scheduled medicine!</p>
        </div>
    </div>

    <script>
        // PWA and Notification variables
        let deferredPrompt;
        let notificationPermission = Notification.permission;
        let reminderIntervals = [];

        // Medicine data structure
        const medicineData = {
            father: {
                morningBefore: [
                    { name: "Maxi PhD", dosage: "30 days tablets", stock: 30, originalStock: 30 }
                ],
                morningAfter: [
                    { name: "Metolol MF", dosage: "60mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Pilclop", dosage: "75mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Cordarone", dosage: "30 days", stock: 30, originalStock: 30 },
                    { name: "Orofer XT", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Hyqvit", dosage: "30 tablets", stock: 30, originalStock: 30 }
                ],
                afternoon: [
                    { name: "Acitrom", dosage: "1mg/2mg alternate days - 30 days", stock: 30, originalStock: 30 }
                ],
                night: [
                    { name: "Rotin F", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Telmiford", dosage: "40mg - 30 tablets", stock: 30, originalStock: 30 }
                ]
            },
            mother: {
                morning: [
                    { name: "Telzox H", dosage: "30 tablets", stock: 30, originalStock: 30 }
                ],
                night: [
                    { name: "Cinod", dosage: "10mg - 60 tablets (2x daily)", stock: 60, originalStock: 60 },
                    { name: "Zavamet", dosage: "50/500 - 60 tablets (2x daily)", stock: 60, originalStock: 60 }
                ]
            }
        };

        // Medicine reminder times (24-hour format)
        const reminderTimes = [
            { time: '08:00', message: "Time for Father's morning medicine (before breakfast) - Maxi PhD" },
            { time: '09:00', message: "Time for after-breakfast medicines for Father and Mother" },
            { time: '16:00', message: "Time for Father's 4 PM medicine (Acitrom)" },
            { time: '21:00', message: "Time for evening medicines for both parents" }
        ];

        // Initialize the application
        function init() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup PWA installation
            setupPWA();
            
            // Setup reminder system
            setupReminderSystem();
            
            // Update next reminder display
            updateNextReminder();
            setInterval(updateNextReminder, 60000);
            
            // Initialize voice if available
            initializeVoiceRecognition();
            
            // Populate medicine schedules
            populateMedicineSchedules();
            
            // Generate stock alerts
            generateStockAlerts();
            
            // Auto-greet user
            setTimeout(() => {
                speak("Welcome to MediBot! Enable notifications for automatic medicine reminders.");
            }, 3000);
        }

        // Populate medicine schedules in the UI
        function populateMedicineSchedules() {
            // Father's medicines
            populateTimeSection('fatherMorningBefore', medicineData.father.morningBefore, 'father');
            populateTimeSection('fatherMorningAfter', medicineData.father.morningAfter, 'father');
            populateTimeSection('father4PM', medicineData.father.afternoon, 'father');
            populateTimeSection('fatherNight', medicineData.father.night, 'father');
            
            // Mother's medicines
            populateTimeSection('motherMorning', medicineData.mother.morning, 'mother');
            populateTimeSection('motherNight', medicineData.mother.night, 'mother');
        }

        // Populate a specific time section with medicines
        function populateTimeSection(sectionId, medicines, person) {
            const section = document.getElementById(sectionId);
            if (!section || !medicines) return;
            
            section.innerHTML = '';
            
            medicines.forEach((medicine, index) => {
                const medicineElement = createMedicineElement(medicine, person, sectionId, index);
                section.appendChild(medicineElement);
            });
        }

        // Create a medicine element
        function createMedicineElement(medicine, person, sectionId, index) {
            const div = document.createElement('div');
            div.className = `medicine-item ${medicine.stock <= 5 ? 'low-stock' : ''}`;
            
            div.innerHTML = `
                <div class="medicine-info">
                    <div class="medicine-name">${medicine.name}</div>
                    <div class="medicine-details">${medicine.dosage}</div>
                    <div class="control-buttons">
                        <button class="btn btn-take" onclick="takeMedicine('${medicine.name}', '${person}', '${sectionId}', ${index})">
                            ✓ Take Dose
                        </button>
                        <button class="btn btn-add" onclick="addMedicineStock('${medicine.name}', '${person}', '${sectionId}', ${index})">
                            + Add Stock
                        </button>
                    </div>
                </div>
                <div class="medicine-stock">
                    <div class="stock-count ${medicine.stock <= 5 ? 'low' : ''}" id="stock-${person}-${sectionId}-${index}">
                        ${medicine.stock}
                    </div>
                    <div class="stock-label">doses left</div>
                </div>
            `;
            
            return div;
        }

        // Generate stock alerts
        function generateStockAlerts() {
            const alertsContainer = document.getElementById('stockAlerts');
            alertsContainer.innerHTML = '';
            
            let hasAlerts = false;
            
            // Check all medicines for low stock
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        if (medicine.stock <= 5) {
                            hasAlerts = true;
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert urgent-alert';
                            alertDiv.innerHTML = `
                                <span class="alert-icon">⚠️</span>
                                <div>
                                    <strong>LOW STOCK ALERT:</strong> ${medicine.name} 
                                    (${person.charAt(0).toUpperCase() + person.slice(1)}) 
                                    has only ${medicine.stock} doses remaining!
                                    <br><small>Please order more soon to avoid running out.</small>
                                </div>
                            `;
                            alertsContainer.appendChild(alertDiv);
                        }
                    });
                });
            });
            
            if (!hasAlerts) {
                alertsContainer.innerHTML = `
                    <div class="alert" style="background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%); color: #0c5460; border-color: #17a2b8;">
                        <span class="alert-icon">✅</span>
                        <div>
                            <strong>All Good!</strong> All medicines have adequate stock levels.
                            <br><small>Keep monitoring stock levels for timely refills.</small>
                        </div>
                    </div>
                `;
            }
        }

        // Setup PWA (Progressive Web App)
        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installButton').style.display = 'block';
            });
        }

        // Install PWA
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installation accepted');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('To install:\n• Android: Chrome menu → "Add to Home screen"\n• iPhone: Safari Share → "Add to Home Screen"');
            }
        }

        // Enable Browser Notifications
        async function enableBrowserNotifications() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                updateNotificationStatus(permission);
                
                if (permission === 'granted') {
                    // Test notification
                    new Notification('MediBot Notifications Enabled!', {
                        body: 'You will now receive medicine reminders.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">🔔</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">💊</text></svg>'
                    });
                    
                    // Start automatic reminders
                    startAutomaticReminders();
                }
            } else {
                alert('This browser does not support notifications');
            }
        }

        // Update notification status display
        function updateNotificationStatus(permission) {
            const statusEl = document.getElementById('notificationStatus');
            
            if (permission === 'granted') {
                statusEl.className = 'notification-status status-granted';
                statusEl.innerHTML = '✅ Notifications Enabled! You\'ll get automatic medicine reminders.';
            } else if (permission === 'denied') {
                statusEl.className = 'notification-status status-denied';
                statusEl.innerHTML = '❌ Notifications Blocked. Please enable in browser settings.';
            } else {
                statusEl.className = 'notification-status status-pending';
                statusEl.innerHTML = '⏳ Click "Enable Browser Notifications" to set up reminders.';
            }
        }

        // Start automatic reminders
        function startAutomaticReminders() {
            // Clear existing intervals
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];

            // Check every minute for reminder times
            const reminderInterval = setInterval(() => {
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                  now.getMinutes().toString().padStart(2, '0');

                reminderTimes.forEach(reminder => {
                    if (currentTime === reminder.time) {
                        sendNotification(reminder.message);
                        showCustomNotification(reminder.message);
                        speak(reminder.message);
                    }
                });
            }, 60000);

            reminderIntervals.push(reminderInterval);
        }

        // Send browser notification
        function sendNotification(message) {
            if (Notification.permission === 'granted') {
                const notification = new Notification('🔔 Medicine Reminder', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">💊</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">⏰</text></svg>',
                    requireInteraction: true,
                    tag: 'medicine-reminder'
                });

                // Auto-close after 10 seconds
                setTimeout(() => notification.close(), 10000);

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }

        // Show custom notification popup
        function showCustomNotification(message) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `
                <h4>🔔 Medicine Reminder</h4>
                <p>${message}</p>
                <small>Time: ${new Date().toLocaleTimeString()}</small>
            `;
            
            popup.classList.add('show');
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                popup.classList.remove('show');
            }, 8000);
        }

        // Close custom notification
        function closeNotification() {
            document.getElementById('notificationPopup').classList.remove('show');
        }

        // Setup Web Reminders (keeps page active)
        function setupWebReminders() {
            alert('Web reminders enabled! Keep this tab open in your browser for automatic alerts.');
            startAutomaticReminders();
            
            // Prevent page from sleeping (if supported)
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').then(() => {
                    console.log('Wake lock active');
                }).catch((err) => {
                    console.log('Wake lock failed:', err);
                });
            }
        }

        // Download Calendar Events
        function downloadCalendar() {
            const events = reminderTimes.map(reminder => {
                const now = new Date();
                const [hours, minutes] = reminder.time.split(':');
                const eventDate = new Date();
                eventDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return `BEGIN:VEVENT
SUMMARY:Medicine Reminder - ${reminder.message}
DTSTART:${formatDateForICS(eventDate)}
DTEND:${formatDateForICS(new Date(eventDate.getTime() + 15*60000))}
RRULE:FREQ=DAILY
DESCRIPTION:Automated medicine reminder
END:VEVENT`;
            });

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MediBot//Medicine Reminders//EN
${events.join('\n')}
END:VCALENDAR`;

            downloadFile('medicine-reminders.ics', icsContent);
            alert('Calendar file downloaded! Import it into your calendar app for reminders.');
        }

        // Format date for ICS file
        function formatDateForICS(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        // Setup Email Reminders
        function setupEmailReminders() {
            const email = prompt('Enter your email address for daily medicine reminders:');
            if (email && email.includes('@')) {
                // In a real app, this would send to a backend service
                alert(`Email reminders would be sent to ${email}. This feature requires a backend service to implement.`);
                
                // For now, create mailto links
                const subject = 'Daily Medicine Reminder Schedule';
                const body = reminderTimes.map(r => `${r.time} - ${r.message}`).join('\n');
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                window.open(mailtoLink);
            }
        }

        // Download file utility
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Update next reminder display
        function updateNextReminder() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            let nextReminder = null;
            let minDiff = Infinity;
            
            reminderTimes.forEach(reminder => {
                const [hours, minutes] = reminder.time.split(':');
                const reminderTime = parseInt(hours) * 60 + parseInt(minutes);
                
                let diff = reminderTime - currentTime;
                if (diff < 0) diff += 24 * 60; // Next day
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextReminder = reminder;
                }
            });
            
            if (nextReminder) {
                const nextTime = new Date();
                const [hours, minutes] = nextReminder.time.split(':');
                nextTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (nextTime <= now) {
                    nextTime.setDate(nextTime.getDate() + 1);
                }
                
                document.getElementById('nextReminderTime').textContent = 
                    nextTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = `Current Time: ${timeString}`;
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            const tabButtons = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Voice Recognition System
        let recognition = null;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('🎤 Listening... Speak now!');
                    document.getElementById('voiceButton').classList.add('listening');
                };

                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    
                    document.getElementById('voiceTranscript').textContent = transcript;
                    
                    if (event.results[event.results.length - 1].isFinal) {
                        processVoiceCommand(transcript);
                    }
                };

                recognition.onerror = function(event) {
                    updateVoiceStatus('❌ Error: ' + event.error);
                    stopListening();
                };

                recognition.onend = function() {
                    stopListening();
                };
            } else {
                updateVoiceStatus('❌ Voice recognition not supported in this browser');
            }
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                alert('Voice recognition not supported in this browser');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function stopListening() {
            isListening = false;
            updateVoiceStatus('🎤 Click microphone to start listening');
            document.getElementById('voiceButton').classList.remove('listening');
        }

        function updateVoiceStatus(status) {
            document.getElementById('voiceStatus').textContent = status;
        }

        function processVoiceCommand(command) {
            const lowerCommand = command.toLowerCase();
            let response = '';

            // Medicine-related commands
            if (lowerCommand.includes('medicine') || lowerCommand.includes('medication')) {
                if (lowerCommand.includes('time') || lowerCommand.includes('when')) {
                    response = 'Medicine times are: 8 AM before breakfast, 9 AM after breakfast, 4 PM for Acitrom, and 9 PM evening medicines.';
                } else if (lowerCommand.includes('take') || lowerCommand.includes('took')) {
                    response = 'Great! I\'ll mark that medicine as taken. Remember to maintain regular timing for best results.';
                } else {
                    response = 'I can help with medicine schedules, reminders, and tracking. What would you like to know?';
                }
            }
            // Stock-related commands
            else if (lowerCommand.includes('stock') || lowerCommand.includes('left') || lowerCommand.includes('remaining')) {
                response = 'Let me check the stock levels. Father\'s Maxi PhD has 30 doses left. I\'ll alert you when any medicine is running low.';
            }
            // Reminder commands
            else if (lowerCommand.includes('remind') || lowerCommand.includes('alert')) {
                response = 'Reminders are set for 8 AM, 9 AM, 4 PM, and 9 PM daily. Make sure notifications are enabled for automatic alerts.';
            }
            // Time commands
            else if (lowerCommand.includes('time') || lowerCommand.includes('clock')) {
                const now = new Date();
                response = `Current time is ${now.toLocaleTimeString()}. Next medicine reminder at ${getNextReminderTime()}.`;
            }
            // Greeting commands
            else if (lowerCommand.includes('hello') || lowerCommand.includes('hi') || lowerCommand.includes('hey')) {
                response = 'Hello! I\'m MediBot, your medicine reminder assistant. I can help with schedules, stock tracking, and reminders.';
            }
            // Help commands
            else if (lowerCommand.includes('help') || lowerCommand.includes('what can you do')) {
                response = 'I can help you with medicine schedules, set reminders, track stock levels, and answer questions about medications. Try saying "when is the next medicine time" or "check medicine stock".';
            }
            else {
                response = 'I understand you said "' + command + '". I can help with medicine schedules, reminders, and stock tracking. Try asking about medicine times or stock levels.';
            }

            document.getElementById('voiceResponse').textContent = response;
            speak(response);
        }

        function getNextReminderTime() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            for (let reminder of reminderTimes) {
                const [hours, minutes] = reminder.time.split(':');
                const reminderMinutes = parseInt(hours) * 60 + parseInt(minutes);
                
                if (reminderMinutes > currentMinutes) {
                    return reminder.time;
                }
            }
            
            return reminderTimes[0].time + ' (tomorrow)';
        }

        function speak(text) {
            if (speechSynthesis) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                // Try to use a female voice if available
                const voices = speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice => 
                    voice.name.toLowerCase().includes('female') || 
                    voice.name.toLowerCase().includes('woman') ||
                    voice.name.toLowerCase().includes('zira') ||
                    voice.name.toLowerCase().includes('susan')
                );
                
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // Medicine tracking functions
        function takeMedicine(medicineName, personType) {
            // In a real app, this would update a database
            speak(`Marked ${medicineName} as taken. Remember to take it at the same time daily for best results.`);
            
            // Update stock (simulate)
            updateMedicineStock(medicineName, -1);
        }

        function addMedicineStock(medicineName, amount = 30) {
            speak(`Added ${amount} doses to ${medicineName} stock.`);
            updateMedicineStock(medicineName, amount);
        }

        function updateMedicineStock(medicineName, change) {
            // This would connect to a real database in a production app
            console.log(`Updated ${medicineName} stock by ${change}`);
            
            // Show visual feedback
            showCustomNotification(`Stock updated: ${medicineName} ${change > 0 ? 'increased' : 'decreased'} by ${Math.abs(change)} doses`);
        }

        // Setup reminder system
        function setupReminderSystem() {
            // Check notification permission on load
            updateNotificationStatus(Notification.permission);
            
            // If already granted, start reminders
            if (Notification.permission === 'granted') {
                startAutomaticReminders();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
                console.log('ServiceWorker registration successful');
            }).catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        }

        // Handle page visibility for reminders
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Page became visible, check for missed reminders
                updateNextReminder();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'm':
                        event.preventDefault();
                        toggleVoiceRecognition();
                        break;
                    case '1':
                        event.preventDefault();
                        showTab('dashboard');
                        break;
                    case '2':
                        event.preventDefault();
                        showTab('father');
                        break;
                    case '3':
                        event.preventDefault();
                        showTab('mother');
                        break;
                    case '4':
                        event.preventDefault();
                        showTab('alerts');
                        break;
                }
            }
        });
    </script>
</body>
</html>
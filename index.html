<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Tracking System</title>
    <meta name="theme-color" content="#4F46E5">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVkaWNpbmUgUmVtaW5kZXIgU3lzdGVtIiwic2hvcnRfbmFtZSI6Ik1lZFJlbWluZGVyIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkZGRkYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2QwZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJelEyTmpreVJTSStQR05wY21Oc1pTQmplRDBpTVRJaUlHTjVQU0l4TWlJZ2NqMGlOU0lnWm1sc2JEMGlJekZHUXpjelFTSXZQand2YzNablBnPT0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .data-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .person-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .person-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-integration {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .calendar-integration h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .calendar-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .calendar-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .calendar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .calendar-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .time-slot {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .time-slot h3 {
            color: #4F46E5;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medicine-item {
            background: linear-gradient(45deg, #f8f9ff, #e8eeff);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4F46E5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medicine-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
        }

        .medicine-item.low-stock {
            border-left-color: #EF4444;
            background: linear-gradient(45deg, #fff5f5, #fee2e2);
            animation: pulse 2s infinite;
        }

        .medicine-item.taken-today {
            border-left-color: #10B981;
            background: linear-gradient(45deg, #f0fdf4, #dcfce7);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medicine-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1F2937;
        }

        .stock-count {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .stock-count.low {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            animation: shake 0.5s ease-in-out;
        }

        .stock-count.taken {
            background: linear-gradient(45deg, #10B981, #059669);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .medicine-details {
            color: #6B7280;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .last-taken {
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-take {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-take:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-take:disabled {
            background: linear-gradient(45deg, #9CA3AF, #6B7280);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-calendar {
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border-radius: 50%;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .voice-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .voice-assistant.listening {
            animation: pulse-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .reset-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(45deg, #EF4444, #DC2626);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .voice-output {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .install-prompt {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: white;
            color: #FF6B6B;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #EF4444, #DC2626);
        }

        .storage-status {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .storage-status.enabled {
            background: rgba(16, 185, 129, 0.2);
        }

        .storage-status.disabled {
            background: rgba(239, 68, 68, 0.2);
        }

        .calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .calendar-modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .reminder-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4F46E5;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .medicine-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .action-buttons { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { margin-bottom: 5px; }
            .calendar-buttons { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <h3>Add to Home Screen</h3>
            <p>Install this app on your phone for easy access!</p>
            <button class="install-btn" onclick="showInstallInstructions()">Show Instructions</button>
            <button class="install-btn" onclick="hideInstallPrompt()">Later</button>
        </div>

        <div class="header">
            <h1>Medicine Reminder System</h1>
            <p>Never miss your medication again!</p>
            <div class="data-info" id="dataInfo">
                Data persists across sessions • Last updated: <span id="lastUpdate">Never</span>
            </div>
            <div class="storage-status" id="storageStatus">
                <span id="storageIcon">💾</span>
                <span id="storageText">Checking storage...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('father')">Father</button>
            <button class="tab" onclick="switchTab('mother')">Mother</button>
            <button class="tab" onclick="switchTab('chat')">Voice Assistant</button>
        </div>

        <!-- Calendar Integration Section -->
        <div class="calendar-integration">
            <h3>Google Calendar Integration</h3>
            <p>Add medicine reminders directly to your Google Calendar for automatic notifications on your phone!</p>
            
            <div class="calendar-buttons">
                <a href="#" class="calendar-btn" onclick="addCustomReminder()">
                    ➕ Custom Reminder
                </a>
            </div>
            
            <div class="calendar-info">
                <strong>How it works:</strong><br>
                • Click on button above to create calendar events<br>
                • Set your preferred notification time (15min, 1hr, etc.)<br>
                • Reminders will repeat daily automatically<br>
                • Works offline once added to your calendar
            </div>
        </div>

        <div id="father" class="person-section active">
            <!-- Father's medicines populated by JavaScript -->
        </div>

        <div id="mother" class="person-section">
            <!-- Mother's medicines populated by JavaScript -->
        </div>

        <div id="chat" class="person-section">
            <div class="time-slot">
                <h3>Voice Assistant</h3>
                <p>Click the voice button to interact with your medicine assistant. You can:</p>
                <ul style="margin: 20px 0; color: #6B7280; line-height: 1.6;">
                    <li>Check medicine stock levels</li>
                    <li>Ask about dosage information</li>
                    <li>Get reminders for specific medicines</li>
                    <li>Inquire about medicine interactions</li>
                    <li>Get general medical advice</li>
                </ul>
                <div style="background: linear-gradient(45deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px;">Example Commands:</h4>
                    <p style="color: #6B7280; font-style: italic;">
                        "Check father's medicine stock"<br>
                        "What is Metolol used for?"<br>
                        "Remind me about evening medicines"<br>
                        "How many Acitrom tablets are left?"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Reminder Modal -->
    <div class="calendar-modal" id="customReminderModal">
        <div class="calendar-modal-content">
            <button class="close-modal" onclick="closeCustomReminderModal()">&times;</button>
            <h2>Create Custom Medicine Reminder</h2>
            <div class="reminder-form">
                <div class="form-group">
                    <label for="medicineName">Medicine Name:</label>
                    <input type="text" id="medicineName" placeholder="e.g., Aspirin 100mg">
                </div>
                <div class="form-group">
                    <label for="reminderTime">Time:</label>
                    <input type="time" id="reminderTime" value="08:00">
                </div>
                <div class="form-group">
                    <label for="dosage">Dosage Instructions:</label>
                    <input type="text" id="dosage" placeholder="e.g., Take 1 tablet with food">
                </div>
                <div class="form-group">
                    <label for="frequency">Frequency:</label>
                    <select id="frequency">
                        <option value="daily">Daily</option>
                        <option value="alternate">Alternate Days</option>
                        <option value="weekly">Weekly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-calendar" onclick="createCustomReminder()">
                        Add to Calendar
                    </button>
                    <button class="btn" onclick="closeCustomReminderModal()" style="background: #6B7280; color: white;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <button class="voice-assistant" onclick="toggleVoiceAssistant()" id="voiceBtn">🎤</button>
    <button class="reset-btn" onclick="resetAllStock()">Reset Stock</button>

    <div class="voice-output" id="voiceOutput">
        <h3>🎤 Voice Assistant</h3>
        <p id="voiceText">Listening...</p>
        <button onclick="closeVoiceOutput()" style="background: #4F46E5; color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-top: 15px; cursor: pointer;">Close</button>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Persistent storage key
        const STORAGE_KEY = 'medicine_tracker_data';
        const STORAGE_VERSION = '2.0';
        
        // Check localStorage availability
        let storageAvailable = false;
        
        function checkStorageAvailability() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, 'test');
                localStorage.removeItem(test);
                storageAvailable = true;
                return true;
            } catch(e) {
                storageAvailable = false;
                console.warn('localStorage is not available. Data will not persist across sessions.');
                return false;
            }
        }

        function updateStorageStatus() {
            const statusElement = document.getElementById('storageStatus');
            const iconElement = document.getElementById('storageIcon');
            const textElement = document.getElementById('storageText');
            
            if (storageAvailable) {
                statusElement.className = 'storage-status enabled';
                iconElement.textContent = '✅';
                textElement.textContent = 'Persistent storage enabled';
            } else {
                statusElement.className = 'storage-status disabled';
                iconElement.textContent = '⚠️';
                textElement.textContent = 'Persistent storage unavailable - data will reset on refresh';
            }
        }
        
        // Original medicine data structure
        const originalMedicineData = {
            father: {
                morning: [
                    { name: "Maxi PhD", dose: "30 tablets", timing: "Before breakfast", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterBreakfast: [
                    { name: "Metolol MF", dose: "60mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Pilclop", dose: "75mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cordarone", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Orofer XT", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Hyqvit", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afternoon: [
                    { name: "Acitrom", dose: "1mg/2mg alternate days", timing: "4pm", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Rotin F", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Telmiford", dose: "40mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null }
                ]
            },
            mother: {
                afterBreakfast: [
                    { name: "Telzox H", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ]
            }
        };

        // Current medicine data (will be loaded from storage or default to original)
        let medicineData = {};

        // Enhanced persistent storage functions
        function saveToStorage(data) {
            try {
                if (!storageAvailable) {
                    // Fallback to memory storage
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    return true;
                }
                
                const jsonData = JSON.stringify({
                    ...data,
                    lastUpdated: new Date().toISOString(),
                    version: STORAGE_VERSION
                });
                
                localStorage.setItem(STORAGE_KEY, jsonData);
                
                // Update UI to show last saved time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                
                // Show user-friendly error
                showNotification('⚠️ Unable to save data. Changes may be lost on refresh.', 'error');
                
                // Try fallback to memory
                try {
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback storage also failed:', fallbackError);
                    return false;
                }
            }
        }

        function loadFromStorage() {
            try {
                if (!storageAvailable) {
                    // Try to load from memory storage
                    if (window.persistentMedicineData) {
                        const data = JSON.parse(window.persistentMedicineData);
                        if (data.lastUpdated) {
                            document.getElementById('lastUpdate').textContent = new Date(data.lastUpdated).toLocaleString();
                        }
                        delete data.lastUpdated;
                        delete data.version;
                        return data;
                    }
                    return JSON.parse(JSON.stringify(originalMedicineData));
                }
                
                const savedData = localStorage.getItem(STORAGE_KEY);
                
                if (!savedData) {
                    // No saved data, use original data
                    return JSON.parse(JSON.stringify(originalMedicineData));
                }
                
                const parsed = JSON.parse(savedData);
                
                // Check version compatibility
                if (parsed.version !== STORAGE_VERSION) {
                    console.warn('Data version mismatch. Using original data.');
                    return JSON.parse(JSON.stringify(originalMedicineData));
                }
                
                // Update last loaded time in UI
                if (parsed.lastUpdated) {
                    document.getElementById('lastUpdate').textContent = new Date(parsed.lastUpdated).toLocaleString();
                }
                
                // Remove metadata before returning
                delete parsed.lastUpdated;
                delete parsed.version;
                
                return parsed;
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('⚠️ Error loading saved data. Using default settings.', 'error');
                return JSON.parse(JSON.stringify(originalMedicineData));
            }
        }

        // Initialize storage and data
        function initializeApp() {
            checkStorageAvailability();
            updateStorageStatus();
            medicineData = loadFromStorage();
            renderMedicines();
            checkInstallPrompt();
            
            // Auto-save every 5 minutes
            setInterval(() => {
                saveToStorage(medicineData);
            }, 5 * 60 * 1000);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function takeMedicine(person, timeSlot, medicineIndex) {
            const medicine = medicineData[person][timeSlot][medicineIndex];
            const today = new Date().toDateString();
            
            // Check if already taken today
            if (medicine.lastTaken === today) {
                showNotification(' Medicine already taken today!', 'error');
                return;
            }
            
            if (medicine.stock > 0) {
                medicine.stock--;
                medicine.lastTaken = today;
                
                saveToStorage(medicineData);
                renderMedicines();
                
                showNotification(`✅ ${medicine.name} taken successfully!`);
                
                // Check for low stock
                if (medicine.stock <= 5) {
                    setTimeout(() => {
                        showNotification(`⚠️ Low stock alert: ${medicine.name} has only ${medicine.stock} tablets left!`, 'error');
                    }, 2000);
                }
            } else {
                showNotification(`❌ No stock left for ${medicine.name}!`, 'error');
            }
        }

        function resetAllStock() {
            if (confirm('Are you sure you want to reset all medicine stock to original levels? This will also clear all "taken today" records.')) {
                // Deep clone original data to reset everything
                medicineData = JSON.parse(JSON.stringify(originalMedicineData));
                
                saveToStorage(medicineData);
                renderMedicines();
                
                showNotification(' All medicine stock has been reset to original levels!');
            }
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tab === 'father' ? '1' : tab === 'mother' ? '2' : '3'})`).classList.add('active');
            
            // Show selected section
            document.querySelectorAll('.person-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
        }

        function renderMedicines() {
            ['father', 'mother'].forEach(person => {
                const container = document.getElementById(person);
                container.innerHTML = '';
                
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    const timeSlotDiv = document.createElement('div');
                    timeSlotDiv.className = 'time-slot';
                    
                    const title = timeSlot.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    const timeEmoji = {
                        beforeBreakfast: '🌅',
                        afterBreakfast: '🥞',
                        afternoon: '☀️',
                        afterDinner: '🌙'
                    }[timeSlot] || '💊';
                    
                    timeSlotDiv.innerHTML = `<h3>${timeEmoji} ${title}</h3>`;
                    
                    medicineData[person][timeSlot].forEach((medicine, index) => {
                        const today = new Date().toDateString();
                        const isTakenToday = medicine.lastTaken === today;
                        const isLowStock = medicine.stock <= 5;
                        
                        const medicineDiv = document.createElement('div');
                        medicineDiv.className = `medicine-item ${isLowStock ? 'low-stock' : ''} ${isTakenToday ? 'taken-today' : ''}`;
                        
                        const stockClass = isLowStock ? 'low' : isTakenToday ? 'taken' : '';
                        const stockText = isTakenToday ? 'Taken Today' : `${medicine.stock} left`;
                        
                        medicineDiv.innerHTML = `
                            <div class="medicine-header">
                                <div class="medicine-name">${medicine.name}</div>
                                <div class="stock-count ${stockClass}">${stockText}</div>
                            </div>
                            <div class="medicine-details">
                                <strong>Dose:</strong> ${medicine.dose}<br>
                                ${medicine.timing ? `<strong>Timing:</strong> ${medicine.timing}<br>` : ''}
                                ${medicine.lastTaken ? `<div class="last-taken">Last taken: ${medicine.lastTaken}</div>` : ''}
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-take" onclick="takeMedicine('${person}', '${timeSlot}', ${index})" ${isTakenToday ? 'disabled' : ''}>
                                    💊 ${isTakenToday ? 'Taken Today' : 'Take Medicine'}
                                </button>
                                <button class="btn btn-calendar" onclick="addSingleReminder('${person}', '${timeSlot}', ${index})">
                                    📅 Add Reminder
                                </button>
                            </div>
                        `;
                        
                        timeSlotDiv.appendChild(medicineDiv);
                    });
                    
                    container.appendChild(timeSlotDiv);
                });
            });
        }

        // Calendar Integration Functions
        function createGoogleCalendarUrl(title, description, startTime, endTime, recurrence = 'DAILY') {
            const baseUrl = 'https://calendar.google.com/calendar/render';
            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: title,
                details: description,
                dates: `${startTime}/${endTime}`,
                recur: `RRULE:FREQ=${recurrence}`,
                sf: 'true',
                output: 'xml'
            });
            
            return `${baseUrl}?${params.toString()}`;
        }

        function formatDateTimeForCalendar(date, time) {
            const [hours, minutes] = time.split(':');
            const dateTime = new Date(date);
            dateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            return dateTime.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        function getDefaultTimeForSlot(timeSlot) {
            const times = {
                morning: '07:00',
                afterBreakfast: '09:30',
                afternoon: '16:00',
                afterDinner: '21:30'
            };
            return times[timeSlot] || '08:00';
        }

        function addSingleReminder(person, timeSlot, medicineIndex) {
            const medicine = medicineData[person][timeSlot][medicineIndex];
            const time = getDefaultTimeForSlot(timeSlot);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const startDateTime = formatDateTimeForCalendar(tomorrow, time);
            const endDate = new Date(tomorrow);
            endDate.setMinutes(endDate.getMinutes() + 15);
            const endDateTime = formatDateTimeForCalendar(endDate, time);
            
            const title = `💊 Take ${medicine.name}`;
            const description = `Medicine Reminder\n\nMedicine: ${medicine.name}\nDose: ${medicine.dose}\n${medicine.timing ? `Timing: ${medicine.timing}\n` : ''}Person: ${person.charAt(0).toUpperCase() + person.slice(1)}\n\nStock remaining: ${medicine.stock} tablets`;
            
            const calendarUrl = createGoogleCalendarUrl(title, description, startDateTime, endDateTime);
            
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(calendarUrl, '_blank');
            } else {
                window.open(calendarUrl, '_blank', 'width=600,height=600');
            }
            
            showNotification(`Calendar reminder created for ${medicine.name}!`);
        }

        function addAllReminders(person) {
            let reminderCount = 0;
            const baseUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
            
            Object.keys(medicineData[person]).forEach(timeSlot => {
                medicineData[person][timeSlot].forEach(medicine => {
                    const time = getDefaultTimeForSlot(timeSlot);
                    const today = new Date();
                    const tomorrow = new Date(today);
                    tomorrow.setDate(today.getDate() + 1);
                    
                    const startDateTime = formatDateTimeForCalendar(tomorrow, time);
                    const endDate = new Date(tomorrow);
                    endDate.setMinutes(endDate.getMinutes() + 15);
                    const endDateTime = formatDateTimeForCalendar(endDate, time);
                    
                    const title = `💊 Take ${medicine.name}`;
                    const description = `Medicine Reminder\n\nMedicine: ${medicine.name}\nDose: ${medicine.dose}\n${medicine.timing ? `Timing: ${medicine.timing}\n` : ''}Time Slot: ${timeSlot}\nPerson: ${person.charAt(0).toUpperCase() + person.slice(1)}\n\nStock remaining: ${medicine.stock} tablets`;
                    
                    const calendarUrl = createGoogleCalendarUrl(title, description, startDateTime, endDateTime);
                    
                    // Add a small delay between opening multiple calendar windows
                    setTimeout(() => {
                        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                            window.open(calendarUrl, '_blank');
                        } else {
                            window.open(calendarUrl, '_blank', 'width=600,height=600');
                        }
                    }, reminderCount * 500);
                    
                    reminderCount++;
                });
            });
            
            showNotification(`Opening ${reminderCount} calendar reminders for ${person}!`);
        }

        function addCustomReminder() {
            document.getElementById('customReminderModal').style.display = 'flex';
        }

        function closeCustomReminderModal() {
            document.getElementById('customReminderModal').style.display = 'none';
        }

        function createCustomReminder() {
            const medicineName = document.getElementById('medicineName').value;
            const reminderTime = document.getElementById('reminderTime').value;
            const dosage = document.getElementById('dosage').value;
            const frequency = document.getElementById('frequency').value;
            
            if (!medicineName || !reminderTime) {
                showNotification('Please fill in medicine name and time!', 'error');
                return;
            }
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const startDateTime = formatDateTimeForCalendar(tomorrow, reminderTime);
            const endDate = new Date(tomorrow);
            endDate.setMinutes(endDate.getMinutes() + 15);
            const endDateTime = formatDateTimeForCalendar(endDate, reminderTime);
            
            const title = `💊 Take ${medicineName}`;
            const description = `Custom Medicine Reminder\n\nMedicine: ${medicineName}\n${dosage ? `Dosage: ${dosage}\n` : ''}Frequency: ${frequency}\nTime: ${reminderTime}`;
            
            const recurrence = frequency === 'daily' ? 'DAILY' : frequency === 'weekly' ? 'WEEKLY' : 'DAILY';
            const calendarUrl = createGoogleCalendarUrl(title, description, startDateTime, endDateTime, recurrence);
            
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                window.open(calendarUrl, '_blank');
            } else {
                window.open(calendarUrl, '_blank', 'width=600,height=600');
            }
            
            showNotification(`Custom reminder created for ${medicineName}!`);
            closeCustomReminderModal();
            
            // Clear form
            document.getElementById('medicineName').value = '';
            document.getElementById('reminderTime').value = '08:00';
            document.getElementById('dosage').value = '';
            document.getElementById('frequency').value = 'daily';
        }

        function openGoogleCalendar() {
            const calendarUrl = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) 
                ? 'https://calendar.google.com/calendar/u/0/r'
                : 'https://calendar.google.com/calendar/u/0/r';
            
            window.open(calendarUrl, '_blank');
            showNotification('Opening Google Calendar...');
        }

        // Voice Assistant Functions
        let isListening = false;
        let recognition = null;

        function initializeVoiceAssistant() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('voiceOutput').style.display = 'block';
                    document.getElementById('voiceText').textContent = 'Listening... Speak now!';
                };
                
                recognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    processVoiceCommand(command);
                };
                
                recognition.onerror = function(event) {
                    showNotification('❌ Voice recognition error. Please try again.', 'error');
                    stopListening();
                };
                
                recognition.onend = function() {
                    stopListening();
                };
            }
        }

        function toggleVoiceAssistant() {
            if (!recognition) {
                showNotification('❌ Voice recognition not supported in this browser.', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
        }

        function processVoiceCommand(command) {
            document.getElementById('voiceText').innerHTML = `<strong>You said:</strong> "${command}"<br><br><strong>Response:</strong> `;
            
            let response = '';
            
            // Check stock commands
            if (command.includes('check') && command.includes('stock')) {
                if (command.includes('father')) {
                    response = getStockReport('father');
                } else if (command.includes('mother')) {
                    response = getStockReport('mother');
                } else {
                    response = getStockReport('father') + '<br><br>' + getStockReport('mother');
                }
            }
            // Medicine information commands
            else if (command.includes('what is') || command.includes('tell me about')) {
                const medicineMatch = findMentionedMedicine(command);
                if (medicineMatch) {
                    response = getMedicineInfo(medicineMatch);
                } else {
                    response = 'I couldn\'t identify which medicine you\'re asking about. Please be more specific.';
                }
            }
            // Low stock alerts
            else if (command.includes('low stock') || command.includes('running low')) {
                response = getLowStockAlert();
            }
            // Today's medicines
            else if (command.includes('today') && (command.includes('medicine') || command.includes('tablet'))) {
                response = getTodaysMedicineStatus();
            }
            // Default response
            else {
                response = 'I can help you with:<br>• "Check father\'s/mother\'s stock"<br>• "What is [medicine name] used for?"<br>• "Show low stock medicines"<br>• "What medicines for today?"';
            }
            
            document.getElementById('voiceText').innerHTML += response;
            
            // Text-to-speech response
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(response.replace(/<br>/g, '. ').replace(/<[^>]*>/g, ''));
                utterance.rate = 0.8;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }

        function findMentionedMedicine(command) {
            const allMedicines = [];
            
            ['father', 'mother'].forEach(person => {
                Object.values(medicineData[person]).forEach(timeSlot => {
                    timeSlot.forEach(medicine => {
                        allMedicines.push(medicine.name.toLowerCase());
                    });
                });
            });
            
            return allMedicines.find(medicine => 
                command.includes(medicine) || 
                medicine.split(' ').some(word => command.includes(word.toLowerCase()))
            );
        }

        function getStockReport(person) {
            let report = `${person.charAt(0).toUpperCase() + person.slice(1)}'s medicine stock:<br>`;
            
            Object.values(medicineData[person]).forEach(timeSlot => {
                timeSlot.forEach(medicine => {
                    const status = medicine.stock <= 5 ? ' ⚠️ LOW' : medicine.stock <= 10 ? ' 🔶 MEDIUM' : ' ✅ GOOD';
                    report += `• ${medicine.name}: ${medicine.stock} tablets${status}<br>`;
                });
            });
            
            return report;
        }

        function getMedicineInfo(medicineName) {
            const medicineInfo = {
                'metolol': 'Metolol is a beta-blocker used to treat high blood pressure and heart conditions.',
                'pilclop': 'Pilclop contains clopidogrel, used to prevent blood clots.',
                'acitrom': 'Acitrom is an anticoagulant that helps prevent blood clots.',
                'telzox': 'Telzox H is used to treat high blood pressure.',
                'cinod': 'Cinod is used to manage diabetes and blood sugar levels.',
                'zavamet': 'Zavamet is a combination medicine for diabetes management.'
            };
            
            const lowerName = medicineName.toLowerCase();
            const info = Object.keys(medicineInfo).find(key => lowerName.includes(key));
            
            return info ? medicineInfo[info] : `I don't have specific information about ${medicineName}. Please consult your doctor or pharmacist.`;
        }

        function getLowStockAlert() {
            const lowStockMeds = [];
            
            ['father', 'mother'].forEach(person => {
                Object.values(medicineData[person]).forEach(timeSlot => {
                    timeSlot.forEach(medicine => {
                        if (medicine.stock <= 5) {
                            lowStockMeds.push(`${medicine.name} (${person}): ${medicine.stock} left`);
                        }
                    });
                });
            });
            
            return lowStockMeds.length > 0 
                ? `⚠️ Low stock medicines:<br>• ${lowStockMeds.join('<br>• ')}`
                : '✅ All medicines have adequate stock levels.';
        }

        function getTodaysMedicineStatus() {
            const today = new Date().toDateString();
            let status = 'Today\'s medicine status:<br><br>';
            
            ['father', 'mother'].forEach(person => {
                status += `<strong>${person.charAt(0).toUpperCase() + person.slice(1)}:</strong><br>`;
                
                Object.entries(medicineData[person]).forEach(([timeSlot, medicines]) => {
                    medicines.forEach(medicine => {
                        const taken = medicine.lastTaken === today ? '✅ Taken' : '⭕ Not taken';
                        status += `• ${medicine.name}: ${taken}<br>`;
                    });
                });
                status += '<br>';
            });
            
            return status;
        }

        function closeVoiceOutput() {
            document.getElementById('voiceOutput').style.display = 'none';
            if (isListening) {
                recognition.stop();
            }
        }

        // PWA Installation
        let deferredPrompt;

        function checkInstallPrompt() {
            // Show custom install prompt after 30 seconds
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    document.getElementById('installPrompt').style.display = 'block';
                }
            }, 30000);
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function showInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = ' To install on iOS:\n\n1. Tap the Share button (⬆️)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right corner';
            } else if (isAndroid) {
                instructions = ' To install on Android:\n\n1. Tap the menu (⋮) in your browser\n2. Tap "Add to Home screen" or "Install app"\n3. Tap "Add" or "Install"';
            } else {
                instructions = 'To install on Desktop:\n\n1. Look for the install icon (⬇️) in your browser\'s address bar\n2. Click it and follow the prompts\n3. Or use browser menu > "Install Medicine Reminder"';
            }
            
            alert(instructions);
        }

        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            initializeVoiceAssistant();
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(err => {
                    console.log('Service worker registration failed:', err);
                });
            }
        });

        // Handle page visibility changes to save data
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveToStorage(medicineData);
            }
        });

        // Auto-save before page unload
        window.addEventListener('beforeunload', function() {
            saveToStorage(medicineData);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicines Tracking System</title>
    <meta name="theme-color" content="#4F46E5">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVkaWNpbmUgUmVtaW5kZXIgU3lzdGVtIiwic2hvcnRfbmFtZSI6Ik1lZFJlbWluZGVyIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkZGRkYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2QwZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJelEyTmpreVJTSStQR05wY21Oc1pTQmplRDBpTVRJaUlHTjVQU0l4TWlJZ2NqMGlOU0lnWm1sc2JEMGlJekZHUXpjelFTSXZQand2YzNablBnPT0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .data-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .person-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .person-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .time-slot {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .time-slot h3 {
            color: #4F46E5;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medicine-item {
            background: linear-gradient(45deg, #f8f9ff, #e8eeff);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4F46E5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medicine-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
        }

        .medicine-item.low-stock {
            border-left-color: #EF4444;
            background: linear-gradient(45deg, #fff5f5, #fee2e2);
            animation: pulse 2s infinite;
        }

        .medicine-item.taken-today {
            border-left-color: #10B981;
            background: linear-gradient(45deg, #f0fdf4, #dcfce7);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medicine-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1F2937;
        }

        .stock-count {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .stock-count.low {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            animation: shake 0.5s ease-in-out;
        }

        .stock-count.taken {
            background: linear-gradient(45deg, #10B981, #059669);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .medicine-details {
            color: #6B7280;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .last-taken {
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-take {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-take:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-take:disabled {
            background: linear-gradient(45deg, #9CA3AF, #6B7280);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-calendar {
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border-radius: 50%;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .voice-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .voice-assistant.listening {
            animation: pulse-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .reset-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(45deg, #EF4444, #DC2626);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .voice-output {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .install-prompt {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: white;
            color: #FF6B6B;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #EF4444, #DC2626);
        }

        .storage-status {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .storage-status.enabled {
            background: rgba(16, 185, 129, 0.2);
        }

        .storage-status.disabled {
            background: rgba(239, 68, 68, 0.2);
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .medicine-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .action-buttons { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <h3>Add to Home Screen</h3>
            <p>Install this app on your phone for easy access!</p>
            <button class="install-btn" onclick="showInstallInstructions()">Show Instructions</button>
            <button class="install-btn" onclick="hideInstallPrompt()">Later</button>
        </div>

        <div class="header">
            <h1>Medicine Reminder System</h1>
            <p>Never miss your medication again!</p>
            <div class="data-info" id="dataInfo">
                Data persists across sessions ‚Ä¢ Last updated: <span id="lastUpdate">Never</span>
            </div>
            <div class="storage-status" id="storageStatus">
                <span id="storageIcon">üíæ</span>
                <span id="storageText">Checking storage...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('father')">Father</button>
            <button class="tab" onclick="switchTab('mother')">Mother</button>
            <button class="tab" onclick="switchTab('chat')">Voice Assistant</button>
        </div>

        <div id="father" class="person-section active">
            <!-- Father's medicines populated by JavaScript -->
        </div>

        <div id="mother" class="person-section">
            <!-- Mother's medicines populated by JavaScript -->
        </div>

        <div id="chat" class="person-section">
            <div class="time-slot">
                <h3>Voice Assistant</h3>
                <p>Click the voice button to interact with your medicine assistant. You can:</p>
                <ul style="margin: 20px 0; color: #6B7280; line-height: 1.6;">
                    <li>Check medicine stock levels</li>
                    <li>Ask about dosage information</li>
                    <li>Get reminders for specific medicines</li>
                    <li>Inquire about medicine interactions</li>
                    <li>Get general medical advice</li>
                </ul>
                <div style="background: linear-gradient(45deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px;">Example Commands:</h4>
                    <p style="color: #6B7280; font-style: italic;">
                        "Check father's medicine stock"<br>
                        "What is Metolol used for?"<br>
                        "Remind me about evening medicines"<br>
                        "How many Acitrom tablets are left?"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <button class="voice-assistant" onclick="toggleVoiceAssistant()" id="voiceBtn">üé§</button>
    <button class="reset-btn" onclick="resetAllStock()">Reset Stock</button>

    <div class="voice-output" id="voiceOutput">
        <h3>üé§ Voice Assistant</h3>
        <p id="voiceText">Listening...</p>
        <button onclick="closeVoiceOutput()" style="background: #4F46E5; color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-top: 15px; cursor: pointer;">Close</button>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Persistent storage key
        const STORAGE_KEY = 'medicine_tracker_data';
        const STORAGE_VERSION = '2.0';
        
        // Checking localStorage availability
        let storageAvailable = false;
        
        function checkStorageAvailability() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, 'test');
                localStorage.removeItem(test);
                storageAvailable = true;
                return true;
            } catch(e) {
                storageAvailable = false;
                console.warn('localStorage is not available. Data will not persist across sessions.');
                return false;
            }
        }

        function updateStorageStatus() {
            const statusElement = document.getElementById('storageStatus');
            const iconElement = document.getElementById('storageIcon');
            const textElement = document.getElementById('storageText');
            
            if (storageAvailable) {
                statusElement.className = 'storage-status enabled';
                iconElement.textContent = '‚úÖ';
                textElement.textContent = 'Persistent storage enabled';
            } else {
                statusElement.className = 'storage-status disabled';
                iconElement.textContent = '‚ö†Ô∏è';
                textElement.textContent = 'Persistent storage unavailable - data will reset on refresh';
            }
        }
        
        // Original medicine data structure
        const originalMedicineData = {
            father: {
                morning: [
                    { name: "Maxi PhD", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterBreakfast: [
                    { name: "Metolol MF 60mg", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Pilclop 75mg", dose: "1 tablet at each timeslot",  stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cordarone", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Orofer XT", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Hyqvit", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afternoon: [
                    { name: "Acitrom", dose: "1mg/2mg alternate days", timing: "4pm", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Rotin F", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Telmiford 40mg", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null }
                ]
            },
            mother: {
                afterBreakfast: [
                    { name: "Telzox H", dose: "1 tablet at each timeslot", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cinod 10mg", dose: "1 tablet at each timeslot",  stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet 50/500", dose: "1 tablet at each timeslot", stock: 60, originalStock: 60, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Cinod 10mg", dose: "1 tablet at each timeslot", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet 50/500", dose: "1 tablet at each timeslot", stock: 60, originalStock: 60, lastTaken: null }
                ]
            }
        };

        // Current medicine data (will be loaded from storage or default to original)
        let medicineData = {};

        // Persistent storage functions
        function saveToStorage(data) {
            try {
                if (!storageAvailable) {
                    // Fallback to memory storage
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    return true;
                }
                
                const jsonData = JSON.stringify({
                    ...data,
                    lastUpdated: new Date().toISOString(),
                    version: STORAGE_VERSION
                });
                
                localStorage.setItem(STORAGE_KEY, jsonData);
                
                // Update UI to show last saved time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                
                // Show user-friendly error
                showNotification('‚ö†Ô∏è Unable to save data. Changes may be lost on refresh.', 'error');
                
                // Try fallback to memory
                try {
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback storage also failed:', fallbackError);
                    return false;
                }
            }
        }

        function loadFromStorage() {
            try {
                let data = null;
                
                if (storageAvailable) {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        data = JSON.parse(stored);
                    }
                } else {
                    // Fallback to memory storage
                    if (window.persistentMedicineData) {
                        data = JSON.parse(window.persistentMedicineData);
                    }
                }
                
                if (data) {
                    // Check version compatibility
                    if (data.version !== STORAGE_VERSION) {
                        console.warn('Data version mismatch. Migrating data...');
                        // Could add migration logic here if needed
                    }
                    
                    // Update last updated time
                    if (data.lastUpdated) {
                        document.getElementById('lastUpdate').textContent = new Date(data.lastUpdated).toLocaleString();
                    }
                    
                    // Remove metadata and return actual data
                    delete data.lastUpdated;
                    delete data.version;
                    
                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('‚ö†Ô∏è Error loading saved data. Using default values.', 'error');
                return null;
            }
        }

        // Data validation function
        function validateMedicineData(data) {
            try {
                // Basic structure validation
                if (!data || typeof data !== 'object') return false;
                if (!data.father || !data.mother) return false;
                
                // Validating data structure for both
                for (const person of ['father', 'mother']) {
                    const personData = data[person];
                    if (!personData || typeof personData !== 'object') return false;
                    
                    // Check that each time slot is an array
                    for (const slot in personData) {
                        if (!Array.isArray(personData[slot])) return false;
                        
                        // Validate each medicine object
                        for (const medicine of personData[slot]) {
                            if (!medicine.name || typeof medicine.stock !== 'number') return false;
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Data validation error:', error);
                return false;
            }
        }

        // Initialize data on app start
        function initializeData() {
            const savedData = loadFromStorage();
            
            if (savedData && validateMedicineData(savedData)) {
                // Use saved data
                medicineData = savedData;
                showNotification('Previous data loaded successfully!');
                
                // Count total medicines tracked
                let totalMedicines = 0;
                Object.values(medicineData.father).flat().forEach(() => totalMedicines++);
                Object.values(medicineData.mother).flat().forEach(() => totalMedicines++);
                
                console.log(`Loaded data for ${totalMedicines} medicines`);
            } else {
                // Use original data for first time or if saved data is corrupted
                medicineData = JSON.parse(JSON.stringify(originalMedicineData));
                saveToStorage(medicineData);
                showNotification('Welcome to AI-powered medicines tracking!');
                console.log('Initialized with original data');
            }
        }

        // Save data after any changes
        function saveData() {
            if (validateMedicineData(medicineData)) {
                return saveToStorage(medicineData);
            } else {
                console.error('Invalid data structure, not saving');
                showNotification('‚ö†Ô∏è Data validation failed. Changes not saved.', 'error');
                return false;
            }
        }

        // Auto-save with error handling
        function autoSave() {
            try {
                if (saveData()) {
                    console.log('Auto-save successful');
                } else {
                    console.warn('Auto-save failed');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Check if medicine was taken today
        function wasTakenToday(lastTaken) {
            if (!lastTaken) return false;
            const today = new Date().toDateString();
            const takenDate = new Date(lastTaken).toDateString();
            return today === takenDate;
        }

        // Initialize the app
        function initApp() {
            // Check storage availability first
            checkStorageAvailability();
            updateStorageStatus();
            
            initializeData();
            initializeReminders();
            renderFatherMedicines();
            renderMotherMedicines();
    
            // Show install prompt on mobile
            if (isMobile() && !isAppInstalled()) {
                setTimeout(() => {
                    document.getElementById('installPrompt').style.display = 'block';
                }, 2000);
            }
            
            // Warn user if storage is not available
            if (!storageAvailable) {
                setTimeout(() => {
                    showNotification('‚ö†Ô∏è Browser storage unavailable. Data will reset on page refresh.', 'error');
                }, 1000);
            }
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches;
        }

        function switchTab(tab) {
            // Remove active class from all tabs and sections
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.person-section').forEach(s => s.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding section
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function renderFatherMedicines() {
            const fatherSection = document.getElementById('father');
            fatherSection.innerHTML = '';

            const timeSlots = [
                { key: 'morning', title: 'Morning (Before Breakfast)', icon: 'üåÖ' },
                { key: 'afterBreakfast', title: 'After Breakfast', icon: 'ü•û' },
                { key: 'afternoon', title: 'Afternoon (4 PM)', icon: '‚òÄÔ∏è' },
                { key: 'afterDinner', title: 'After Dinner', icon: 'üåô' }
            ];

            timeSlots.forEach(slot => {
                if (medicineData.father[slot.key] && medicineData.father[slot.key].length > 0) {
                const timeSlotDiv = document.createElement('div');
                timeSlotDiv.className = 'time-slot';
                
                const header = document.createElement('h3');
                header.innerHTML = `${slot.icon} ${slot.title}`;
                timeSlotDiv.appendChild(header);

                medicineData.father[slot.key].forEach((medicine, index) => {
                    const medicineDiv = document.createElement('div');
                    medicineDiv.className = 'medicine-item';
                    
                    // Add classes for styling based on stock and taken status
                    if (medicine.stock <= 5) {
                        medicineDiv.classList.add('low-stock');
                    }
                    if (wasTakenToday(medicine.lastTaken)) {
                        medicineDiv.classList.add('taken-today');
                    }

                    const takenToday = wasTakenToday(medicine.lastTaken);
                    const stockClass = medicine.stock <= 5 ? 'low' : (takenToday ? 'taken' : '');
                    
                    medicineDiv.innerHTML = `
                        <div class="medicine-header">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="stock-count ${stockClass}">
                                ${medicine.stock} left
                            </div>
                        </div>
                        <div class="medicine-details">
                            <strong>Dose:</strong> ${medicine.dose}<br>
                            ${medicine.timing ? `<strong>Timing:</strong> ${medicine.timing}<br>` : ''}
                        </div>
                        ${takenToday ? 
                            `<div class="last-taken">‚úÖ Taken today at ${new Date(medicine.lastTaken).toLocaleTimeString()}</div>` : 
                            ''
                        }
                        <div class="action-buttons">
                            <button class="btn btn-take ${takenToday ? 'disabled' : ''}" 
                                    ${takenToday ? 'disabled' : ''} 
                                    onclick="takeMedicine('father', '${slot.key}', ${index})">
                                ${takenToday ? '‚úÖ Taken Today' : 'üíä Take Medicine'}
                            </button>
                            <button class="btn btn-calendar" onclick="viewCalendar('father', '${medicine.name}')">
                                üìÖ Add reminder to Calendar
                            </button>
                        </div>
                    `;
                    
                    timeSlotDiv.appendChild(medicineDiv);
                });

                fatherSection.appendChild(timeSlotDiv);
            }
        });
    }

    function renderMotherMedicines() {
        const motherSection = document.getElementById('mother');
        motherSection.innerHTML = '';

        const timeSlots = [
            { key: 'afterBreakfast', title: 'After Breakfast', icon: 'ü•û' },
            { key: 'afterDinner', title: 'After Dinner', icon: 'üåô' }
        ];

        timeSlots.forEach(slot => {
            if (medicineData.mother[slot.key] && medicineData.mother[slot.key].length > 0) {
                const timeSlotDiv = document.createElement('div');
                timeSlotDiv.className = 'time-slot';
                
                const header = document.createElement('h3');
                header.innerHTML = `${slot.icon} ${slot.title}`;
                timeSlotDiv.appendChild(header);

                medicineData.mother[slot.key].forEach((medicine, index) => {
                    const medicineDiv = document.createElement('div');
                    medicineDiv.className = 'medicine-item';
                    
                    // Add classes for styling based on stock and taken status
                    if (medicine.stock <= 10) { // Higher threshold for mother's medicines as they're taken twice daily
                        medicineDiv.classList.add('low-stock');
                    }
                    if (wasTakenToday(medicine.lastTaken)) {
                        medicineDiv.classList.add('taken-today');
                    }

                    const takenToday = wasTakenToday(medicine.lastTaken);
                    const stockClass = medicine.stock <= 10 ? 'low' : (takenToday ? 'taken' : '');
                    
                    medicineDiv.innerHTML = `
                        <div class="medicine-header">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="stock-count ${stockClass}">
                                ${medicine.stock} left
                            </div>
                        </div>
                        <div class="medicine-details">
                            <strong>Dose:</strong> ${medicine.dose}<br>
                            ${medicine.timing ? `<strong>Timing:</strong> ${medicine.timing}<br>` : ''}
                        </div>
                        ${takenToday ? 
                            `<div class="last-taken">‚úÖ Taken today at ${new Date(medicine.lastTaken).toLocaleTimeString()}</div>` : 
                            ''
                        }
                        <div class="action-buttons">
                            <button class="btn btn-take ${takenToday ? 'disabled' : ''}" 
                                    ${takenToday ? 'disabled' : ''} 
                                    onclick="takeMedicine('mother', '${slot.key}', ${index})">
                                ${takenToday ? '‚úÖ Taken Today' : 'üíä Take Medicine'}
                            </button>
                            <button class="btn btn-calendar" onclick="viewCalendar('mother', '${medicine.name}')">
                                üìÖ Add reminder to Calendar
                            </button>
                        </div>
                    `;
                    
                    timeSlotDiv.appendChild(medicineDiv);
                });

                motherSection.appendChild(timeSlotDiv);
            }
        });
    }

    function takeMedicine(person, timeSlot, medicineIndex) {
        const medicine = medicineData[person][timeSlot][medicineIndex];
        
        // Check if already taken today
        if (wasTakenToday(medicine.lastTaken)) {
            showNotification(' This medicine was already taken today!', 'error');
            return;
        }
        
        // Check stock
        if (medicine.stock <= 0) {
            showNotification('Out of stock! Please refill this medicine.', 'error');
            return;
        }
        
        // Update medicine data
        medicine.stock--;
        medicine.lastTaken = new Date().toISOString();
        
        // Save data
        autoSave();
        
        // Re-render the appropriate section
        if (person === 'father') {
            renderFatherMedicines();
        } else {
            renderMotherMedicines();
        }
        
        // Show success notification
        showNotification(`‚úÖ ${medicine.name} taken successfully! ${medicine.stock} tablets remaining.`);
        
        // Check for low stock warning
        const threshold = person === 'mother' ? 10 : 5;
        if (medicine.stock <= threshold) {
            setTimeout(() => {
                showNotification(`‚ö†Ô∏è Low stock alert: Only ${medicine.stock} ${medicine.name} tablets left!`, 'error');
            }, 2000);
        }
    }
function viewCalendar(person, medicineName) {
    showCalendarModal(person, medicineName);
}
function showCalendarModal(person, medicineName) {
    // Create modal HTML
    const modalHTML = `
        <div id="calendarModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 20px; padding: 30px; max-width: 90%; max-height: 90%; overflow-y: auto; position: relative;">
                <button onclick="closeCalendarModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">√ó</button>
                
                <h2 style="color: #4F46E5; margin-bottom: 20px; text-align: center;">üìÖ Set Reminder for ${medicineName}</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Select Date:</label>
                    <input type="date" id="reminderDate" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 16px;" min="${new Date().toISOString().split('T')[0]}">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Select Time:</label>
                    <input type="time" id="reminderTime" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 16px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Reminder Message (Optional):</label>
                    <textarea id="reminderMessage" placeholder="e.g., Take with food, Check blood pressure first, etc." style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 16px; min-height: 80px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Repeat:</label>
                    <select id="reminderRepeat" style="width: 100%; padding: 12px; border: 2px solid #E5E7EB; border-radius: 10px; font-size: 16px;">
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button onclick="setReminder('${person}', '${medicineName}')" style="flex: 1; background: linear-gradient(45deg, #10B981, #059669); color: white; border: none; padding: 15px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 16px;">
                        üîî Set Reminder
                    </button>
                    <button onclick="closeCalendarModal()" style="flex: 1; background: linear-gradient(45deg, #6B7280, #4B5563); color: white; border: none; padding: 15px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 16px;">
                        Cancel
                    </button>
                </div>
                
                <div id="existingReminders" style="margin-top: 30px;">
                    <h3 style="color: #4F46E5; margin-bottom: 15px; border-top: 2px solid #E5E7EB; padding-top: 20px;">üìã Existing Reminders</h3>
                    <div id="remindersList"></div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load existing reminders
    loadExistingReminders(person, medicineName);
    
    // Set default time based on medicine schedule
    setDefaultReminderTime(person, medicineName);
}

function setDefaultReminderTime(person, medicineName) {
    const timeInput = document.getElementById('reminderTime');
    const dateInput = document.getElementById('reminderDate');
    
    // Set default date to today
    dateInput.value = new Date().toISOString().split('T')[0];
    
    // Set default time based on medicine schedule
    const defaultTimes = {
        'morning': '08:00',
        'afterBreakfast': '09:30',
        'afternoon': '16:00',
        'afterDinner': '21:00'
    };
    
    // Find the medicine and its time slot
    let defaultTime = '09:00';
    Object.entries(medicineData[person]).forEach(([timeSlot, medicines]) => {
        medicines.forEach(medicine => {
            if (medicine.name === medicineName) {
                defaultTime = defaultTimes[timeSlot] || '09:00';
            }
        });
    });
    
    timeInput.value = defaultTime;
}

function setReminder(person, medicineName) {
    const date = document.getElementById('reminderDate').value;
    const time = document.getElementById('reminderTime').value;
    const message = document.getElementById('reminderMessage').value;
    const repeat = document.getElementById('reminderRepeat').value;
    
    if (!date || !time) {
        showNotification('‚ö†Ô∏è Please select both date and time for the reminder', 'error');
        return;
    }
    
    const reminderDateTime = new Date(`${date}T${time}`);
    const now = new Date();
    
    if (reminderDateTime <= now) {
        showNotification('‚ö†Ô∏è Please select a future date and time', 'error');
        return;
    }
    
    // Create reminder object
    const reminder = {
        id: Date.now(),
        person: person,
        medicineName: medicineName,
        date: date,
        time: time,
        message: message,
        repeat: repeat,
        active: true,
        created: new Date().toISOString()
    };
    
    // Save reminder
    saveReminder(reminder);
    
    // Schedule notification
    scheduleNotification(reminder);
    
    // Add to device calendar
    addToCalendar(reminder);
    
    showNotification(`üîî Reminder set for ${medicineName} on ${formatDate(date)} at ${time}`);
    
    // Refresh reminder list
    loadExistingReminders(person, medicineName);
}


function addToCalendar(reminder) {
    try {
        const startDate = new Date(`${reminder.date}T${reminder.time}`);
        const endDate = new Date(startDate.getTime() + 15 * 60000); // 15 minutes duration
        
        // Create calendar event details
        const title = `üíä Medicine: ${reminder.medicineName}`;
        const description = `Time to take ${reminder.medicineName}${reminder.message ? '\n\nNote: ' + reminder.message : ''}`;
        
        if (isMobile()) {
            // Try native mobile calendar first
            tryNativeMobileCalendar(reminder, title, description, startDate, endDate);
        } else {
            // Desktop - show options
            showDesktopCalendarOptions(reminder, title, description, startDate, endDate);
        }
        
    } catch (error) {
        console.error('Error adding to calendar:', error);
        // Fallback to ICS file
        createICSFile(reminder);
        showNotification('üìÅ Calendar file downloaded as backup', 'success');
    }
}

function tryNativeMobileCalendar(reminder, title, description, startDate, endDate) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    // Format timestamps
    const startTimestamp = Math.floor(startDate.getTime());
    const endTimestamp = Math.floor(endDate.getTime());
    
    let calendarUrl = null;
    
    if (isIOS) {
        // iOS Calendar URL scheme
        calendarUrl = `calshow:${Math.floor(startTimestamp / 1000)}`;
    } else if (isAndroid) {
        // Android Calendar Intent
        const intentData = {
            action: 'android.intent.action.INSERT',
            type: 'vnd.android.cursor.item/event',
            extras: {
                'title': title,
                'description': description,
                'beginTime': startTimestamp,
                'endTime': endTimestamp,
                'allDay': false
            }
        };
        
        // Try Android calendar intent URL
        calendarUrl = `intent:#Intent;action=android.intent.action.INSERT;type=vnd.android.cursor.item/event;S.title=${encodeURIComponent(title)};S.description=${encodeURIComponent(description)};l.beginTime=${startTimestamp};l.endTime=${endTimestamp};B.allDay=false;end`;
    }
    
    if (calendarUrl) {
        // Try to open native calendar
        const success = attemptNativeCalendarOpen(calendarUrl, reminder);
        if (!success) {
            // Fallback to mobile options
            showMobileCalendarOptions(reminder, title, description, startDate, endDate);
        }
    } else {
        // Fallback for other mobile browsers
        showMobileCalendarOptions(reminder, title, description, startDate, endDate);
    }
}

function attemptNativeCalendarOpen(calendarUrl, reminder) {
    try {
        // Create a temporary link
        const link = document.createElement('a');
        link.href = calendarUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        
        // Track if user leaves the page (indicates app opened)
        let appOpened = false;
        let timeoutId;
        
        const cleanup = () => {
            if (link.parentNode) {
                document.body.removeChild(link);
            }
            window.removeEventListener('blur', onBlur);
            window.removeEventListener('focus', onFocus);
            if (timeoutId) clearTimeout(timeoutId);
        };
        
        const onBlur = () => {
            appOpened = true;
            setTimeout(() => {
                if (appOpened) {
                    showNotification('üì± Calendar app opened! Add the reminder if it didn\'t auto-populate.', 'success');
                    cleanup();
                }
            }, 100);
        };
        
        const onFocus = () => {
            setTimeout(() => {
                if (appOpened) {
                    appOpened = false; // Reset if user comes back quickly
                }
            }, 100);
        };
        
        // Set up event listeners
        window.addEventListener('blur', onBlur);
        window.addEventListener('focus', onFocus);
        
        // Set timeout for fallback
        timeoutId = setTimeout(() => {
            if (!appOpened) {
                cleanup();
                showMobileCalendarOptions(reminder, `üíä Medicine: ${reminder.medicineName}`, 
                    `Time to take ${reminder.medicineName}${reminder.message ? '\n\nNote: ' + reminder.message : ''}`,
                    new Date(`${reminder.date}T${reminder.time}`),
                    new Date(`${reminder.date}T${reminder.time}`).getTime() + 15 * 60000
                );
            }
        }, 2000);
        
        // Attempt to open the calendar app
        link.click();
        
        return true; // Assume success, will fallback if needed
        
    } catch (error) {
        console.error('Error opening native calendar:', error);
        return false;
    }
}

function showMobileCalendarOptions(reminder, title, description, startDate, endDate) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.9); z-index: 5000; 
        display: flex; align-items: center; justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 25px; max-width: 85%; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÖ</div>
            <h3 style="color: #1f2937; margin-bottom: 10px; font-size: 20px;">Add to Calendar</h3>
            <p style="color: #6b7280; margin-bottom: 25px; font-size: 14px;">${reminder.medicineName} ‚Ä¢ ${formatDate(reminder.date)} at ${reminder.time}</p>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openGoogleCalendarMobile('${reminder.id}')" 
                        style="background: linear-gradient(45deg, #4285f4, #34a853); color: white; border: none; padding: 16px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>üåê</span> Open Google Calendar
                </button>
                
                <button onclick="downloadICSMobile('${reminder.id}')" 
                        style="background: linear-gradient(45deg, #f59e0b, #d97706); color: white; border: none; padding: 16px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>üìÅ</span> Download Calendar File
                </button>
                
                <button onclick="copyCalendarDetailsMobile('${reminder.id}')" 
                        style="background: linear-gradient(45deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 16px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>üìã</span> Copy Details
                </button>
                
                <button onclick="closeMobileModal()" 
                        style="background: #6b7280; color: white; border: none; padding: 14px 20px; border-radius: 12px; cursor: pointer; font-weight: 500; margin-top: 10px;">
                    Cancel
                </button>
            </div>
            
            <p style="color: #9ca3af; font-size: 12px; margin-top: 15px; line-height: 1.4;">
                üí° Tip: Save to your phone's calendar app for the best reminder experience
            </p>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Store modal reference for cleanup
    window.currentCalendarModal = modal;
}

function showDesktopCalendarOptions(reminder, title, description, startDate, endDate) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 5000; 
        display: flex; align-items: center; justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 90%; max-width: 500px; text-align: center;">
            <h3 style="color: #4f46e5; margin-bottom: 20px;">üìÖ Add to Calendar</h3>
            <p style="margin-bottom: 25px; color: #6b7280;">${reminder.medicineName} ‚Ä¢ ${formatDate(reminder.date)} at ${reminder.time}</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <button onclick="downloadICSDesktop('${reminder.id}')" 
                        style="background: linear-gradient(45deg, #10b981, #059669); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    üìÅ Download .ics File
                </button>
                
                <button onclick="openGoogleCalendarDesktop('${reminder.id}')" 
                        style="background: linear-gradient(45deg, #3b82f6, #2563eb); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    üåê Google Calendar
                </button>
            </div>
            
            <button onclick="closeMobileModal()" 
                    style="background: #6b7280; color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; width: 100%;">
                Cancel
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.currentCalendarModal = modal;
}

// Helper functions for the modal buttons
function openGoogleCalendarMobile(reminderId) {
    const reminders = loadReminders();
    const reminder = reminders.find(r => r.id == reminderId);
    if (reminder) {
        openGoogleCalendarWeb(reminder);
    }
    closeMobileModal();
}

function downloadICSMobile(reminderId) {
    const reminders = loadReminders();
    const reminder = reminders.find(r => r.id == reminderId);
    if (reminder) {
        createICSFile(reminder);
        showNotification('üìÅ Calendar file downloaded! Check your downloads folder.', 'success');
    }
    closeMobileModal();
}

function copyCalendarDetailsMobile(reminderId) {
    const reminders = loadReminders();
    const reminder = reminders.find(r => r.id == reminderId);
    
    if (reminder) {
        const details = `Medicine Reminder: ${reminder.medicineName}
Date: ${formatDate(reminder.date)}
Time: ${reminder.time}
${reminder.message ? 'Note: ' + reminder.message : ''}
${reminder.repeat !== 'once' ? 'Repeat: ' + reminder.repeat : ''}`;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(details).then(() => {
                showNotification('üìã Details copied! Paste in your calendar app.', 'success');
            }).catch(() => {
                fallbackCopyText(details);
            });
        } else {
            fallbackCopyText(details);
        }
    }
    closeMobileModal();
}

function downloadICSDesktop(reminderId) {
    const reminders = loadReminders();
    const reminder = reminders.find(r => r.id == reminderId);
    if (reminder) {
        createICSFile(reminder);
    }
    closeMobileModal();
}

function openGoogleCalendarDesktop(reminderId) {
    const reminders = loadReminders();
    const reminder = reminders.find(r => r.id == reminderId);
    if (reminder) {
        openGoogleCalendarWeb(reminder);
    }
    closeMobileModal();
}

function openGoogleCalendarWeb(reminder) {
    const startDate = new Date(`${reminder.date}T${reminder.time}`);
    const endDate = new Date(startDate.getTime() + 15 * 60000);
    
    const formatDateForCalendar = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };
    
    const title = `üíä Medicine: ${reminder.medicineName}`;
    const description = `Time to take ${reminder.medicineName}${reminder.message ? '\n\nNote: ' + reminder.message : ''}`;
    
    const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE` +
        `&text=${encodeURIComponent(title)}` +
        `&dates=${formatDateForCalendar(startDate)}/${formatDateForCalendar(endDate)}` +
        `&details=${encodeURIComponent(description)}`;
    
    window.open(googleCalendarUrl, '_blank');
    showNotification('üåê Opening Google Calendar...', 'success');
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('üìã Details copied to clipboard!', 'success');
    } catch (err) {
        showNotification('‚ùå Unable to copy. Please copy manually.', 'error');
    }
    
    document.body.removeChild(textArea);
}

function closeMobileModal() {
    if (window.currentCalendarModal) {
        window.currentCalendarModal.remove();
        window.currentCalendarModal = null;
    }
}
 
function saveReminder(reminder) {
    try {
        let reminders = [];
        
        if (storageAvailable) {
            const stored = localStorage.getItem('medicine_reminders');
            if (stored) {
                reminders = JSON.parse(stored);
            }
        } else if (window.medicineReminders) {
            reminders = JSON.parse(window.medicineReminders);
        }
        
        reminders.push(reminder);
        
        if (storageAvailable) {
            localStorage.setItem('medicine_reminders', JSON.stringify(reminders));
        } else {
            window.medicineReminders = JSON.stringify(reminders);
        }
        
        return true;
    } catch (error) {
        console.error('Error saving reminder:', error);
        return false;
    }
}

function loadReminders() {
    try {
        if (storageAvailable) {
            const stored = localStorage.getItem('medicine_reminders');
            return stored ? JSON.parse(stored) : [];
        } else if (window.medicineReminders) {
            return JSON.parse(window.medicineReminders);
        }
        return [];
    } catch (error) {
        console.error('Error loading reminders:', error);
        return [];
    }
}

function loadExistingReminders(person, medicineName) {
    const remindersList = document.getElementById('remindersList');
    const allReminders = loadReminders();
    const medicineReminders = allReminders.filter(r => 
        r.person === person && 
        r.medicineName === medicineName && 
        r.active &&
        new Date(`${r.date}T${r.time}`) > new Date()
    );
    
    if (medicineReminders.length === 0) {
        remindersList.innerHTML = '<p style="color: #6B7280; text-align: center; padding: 20px;">No active reminders</p>';
        return;
    }
    
    remindersList.innerHTML = medicineReminders.map(reminder => `
        <div style="background: linear-gradient(45deg, #f0f9ff, #e0f2fe); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #0ea5e9;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: #0369a1;">üìÖ ${formatDate(reminder.date)} at ${reminder.time}</strong>
                    <p style="color: #64748b; margin: 5px 0;">${reminder.repeat !== 'once' ? `Repeats: ${reminder.repeat}` : 'One-time reminder'}</p>
                    ${reminder.message ? `<p style="color: #475569; font-style: italic;">"${reminder.message}"</p>` : ''}
                </div>
                <button onclick="deleteReminder(${reminder.id}, '${person}', '${medicineName}')" 
                        style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    `).join('');
}

function deleteReminder(reminderId, person, medicineName) {
    try {
        let reminders = loadReminders();
        reminders = reminders.filter(r => r.id !== reminderId);
        
        if (storageAvailable) {
            localStorage.setItem('medicine_reminders', JSON.stringify(reminders));
        } else {
            window.medicineReminders = JSON.stringify(reminders);
        }
        
        showNotification('üóëÔ∏è Reminder deleted successfully');
        loadExistingReminders(person, medicineName);
        
        return true;
    } catch (error) {
        console.error('Error deleting reminder:', error);
        showNotification('‚ö†Ô∏è Error deleting reminder', 'error');
        return false;
    }
}

function scheduleNotification(reminder) {
    const reminderTime = new Date(`${reminder.date}T${reminder.time}`);
    const now = new Date();
    const timeUntilReminder = reminderTime.getTime() - now.getTime();
    
    if (timeUntilReminder > 0) {
        setTimeout(() => {
            showReminderNotification(reminder);
            
            // Handle recurring reminders
            if (reminder.repeat !== 'once') {
                scheduleRecurringReminder(reminder);
            }
        }, timeUntilReminder);
    }
}

function scheduleRecurringReminder(reminder) {
    const nextDate = calculateNextReminderDate(reminder.date, reminder.repeat);
    const newReminder = {
        ...reminder,
        id: Date.now(),
        date: nextDate
    };
    
    saveReminder(newReminder);
    scheduleNotification(newReminder);
}

function calculateNextReminderDate(currentDate, repeat) {
    const date = new Date(currentDate);
    
    switch (repeat) {
        case 'daily':
            date.setDate(date.getDate() + 1);
            break;
        case 'weekly':
            date.setDate(date.getDate() + 7);
            break;
        case 'monthly':
            date.setMonth(date.getMonth() + 1);
            break;
    }
    
    return date.toISOString().split('T')[0];
}

function showReminderNotification(reminder) {
    const message = `üíä Medicine Reminder: ${reminder.medicineName}${reminder.message ? '\n' + reminder.message : ''}`;
    
    // Show in-app notification
    showNotification(message);
    
    // Try to show browser notification
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Medicine Reminder', {
            body: `Time to take ${reminder.medicineName}${reminder.message ? '\n' + reminder.message : ''}`,
            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzQ2OTJFNSI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNSIgZmlsbD0iIzFGQzc0MSIvPjwvc3ZnPg==',
            tag: `medicine-${reminder.id}`
        });
    }
    
    // Play notification sound if available
    if (window.AudioContext || window.webkitAudioContext) {
        playNotificationSound();
    }
}

function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (error) {
        console.error('Error playing notification sound:', error);
    }
}

function closeCalendarModal() {
    const modal = document.getElementById('calendarModal');
    if (modal) {
        modal.remove();
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function initializeReminders() {
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showNotification('üîî Notifications enabled! You will receive medicine reminders.');
            }
        });
    }
    
    // Load and schedule existing reminders
    const reminders = loadReminders();
    const activeReminders = reminders.filter(r => 
        r.active && 
        new Date(`${r.date}T${r.time}`) > new Date()
    );
    
    activeReminders.forEach(reminder => {
        scheduleNotification(reminder);
    });
    
    console.log(`Scheduled ${activeReminders.length} active reminders`);
}

    function resetAllStock() {
        if (confirm('Are you sure you want to reset all medicine stock to original levels? This action cannot be undone.')) {
            // Reset to original stock levels
            medicineData = JSON.parse(JSON.stringify(originalMedicineData));
            
            // Save the reset data
            autoSave();
            
            // Re-render both sections
            renderFatherMedicines();
            renderMotherMedicines();
            
            showNotification('üîÑ All medicine stock has been reset to original levels!');
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type === 'error' ? 'error' : ''}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }

    // Voice Assistant Functions
    let isListening = false;
    let recognition;

    function initializeVoiceRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('voiceOutput').style.display = 'block';
                document.getElementById('voiceText').textContent = 'Listening... Speak now!';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.toLowerCase();
                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                document.getElementById('voiceText').textContent = `Error: ${event.error}. Please try again.`;
                stopListening();
            };

            recognition.onend = function() {
                stopListening();
            };
        } else {
            console.warn('Speech recognition not supported in this browser');
        }
    }

    function toggleVoiceAssistant() {
        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    }

    function startListening() {
        if (recognition) {
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                showNotification('‚ùå Voice recognition failed to start', 'error');
            }
        } else {
            showNotification('‚ùå Voice recognition not supported in this browser', 'error');
        }
    }

    function stopListening() {
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        if (recognition) {
            recognition.stop();
        }
    }

    function processVoiceCommand(command) {
        let response = "I didn't understand that command. Please try again.";
        
        // Stock checking commands
        if (command.includes('stock') || command.includes('how many')) {
            response = getStockInfo(command);
        }
        // Medicine information commands
        else if (command.includes('what is') || command.includes('tell me about')) {
            response = getMedicineInfo(command);
        }
        // Taking medicine commands
        else if (command.includes('take') || command.includes('taken')) {
            response = handleTakeMedicineCommand(command);
        }
        // General help
        else if (command.includes('help')) {
            response = "I can help you check medicine stock, provide medicine information, and track when medicines are taken. Try saying 'check father's medicine stock' or 'what is Metolol used for?'";
        }
        
        document.getElementById('voiceText').textContent = response;
        
        // Use text-to-speech if available
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(response);
            speechSynthesis.speak(utterance);
        }
    }

    function getStockInfo(command) {
        let response = "";
        let lowStockMedicines = [];
        
        if (command.includes('father')) {
            Object.values(medicineData.father).flat().forEach(medicine => {
                if (medicine.stock <= 5) {
                    lowStockMedicines.push(`${medicine.name}: ${medicine.stock} left`);
                }
            });
            response = lowStockMedicines.length > 0 ? 
                `Father's low stock medicines: ${lowStockMedicines.join(', ')}` :
                "Father's medicines are well stocked.";
        } else if (command.includes('mother')) {
            Object.values(medicineData.mother).flat().forEach(medicine => {
                if (medicine.stock <= 10) {
                    lowStockMedicines.push(`${medicine.name}: ${medicine.stock} left`);
                }
            });
            response = lowStockMedicines.length > 0 ? 
                `Mother's low stock medicines: ${lowStockMedicines.join(', ')}` :
                "Mother's medicines are well stocked.";
        } else {
            // General stock check
            Object.values(medicineData.father).flat().forEach(medicine => {
                if (medicine.stock <= 5) lowStockMedicines.push(`Father's ${medicine.name}: ${medicine.stock} left`);
            });
            Object.values(medicineData.mother).flat().forEach(medicine => {
                if (medicine.stock <= 10) lowStockMedicines.push(`Mother's ${medicine.name}: ${medicine.stock} left`);
            });
            
            response = lowStockMedicines.length > 0 ? 
                `Low stock medicines: ${lowStockMedicines.join(', ')}` :
                "All medicines are well stocked.";
        }
        
        return response;
    }

    function getMedicineInfo(command) {
        const medicineInfo = {
            'metolol': 'Metolol MF is a beta-blocker used to treat high blood pressure and heart conditions.',
            'pilclop': 'Pilclop contains clopidogrel, used to prevent blood clots.',
            'cordarone': 'Cordarone contains amiodarone, used to treat irregular heartbeats.',
            'acitrom': 'Acitrom is an anticoagulant used to prevent blood clots.',
            'telzox': 'Telzox H is used to treat high blood pressure.',
            'cinod': 'Cinod is used to manage diabetes.',
            'zavamet': 'Zavamet is used to control blood sugar in diabetes.'
        };
        
        for (const [med, info] of Object.entries(medicineInfo)) {
            if (command.includes(med)) {
                return info;
            }
        }
        
        return "I don't have specific information about that medicine. Please consult with a healthcare provider.";
    }

    function handleTakeMedicineCommand(command) {
        return "Please use the app interface to mark medicines as taken for accurate tracking.";
    }

    function closeVoiceOutput() {
        document.getElementById('voiceOutput').style.display = 'none';
        stopListening();
    }

    // Install prompt functions
    function showInstallInstructions() {
        const instructions = isMobile() ? 
            "On mobile: Tap the menu button in your browser and select 'Add to Home Screen' or 'Install App'" :
            "On desktop: Look for the install icon in your browser's address bar or use the browser menu";
        
        alert(instructions);
        hideInstallPrompt();
    }

    function hideInstallPrompt() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Initialize the application when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        initializeVoiceRecognition();
    });

    // Cleanup function for when page is about to unload
    window.addEventListener('beforeunload', function() {
        autoSave();
    });

    // Auto-save every 5 minutes as backup
    setInterval(autoSave, 5 * 60 * 1000);
    </script>
</body>
</html>
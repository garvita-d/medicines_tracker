<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Activated Medicine Reminder & Stock Alert System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Notification Setup Panel */
        .notification-setup {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .setup-button {
            background: #fff;
            color: #17a2b8;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-button:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .notification-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-granted {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #155724;
        }

        .status-denied {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }

        /* PWA Installation */
        .pwa-section {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
        }

        .install-button {
            background: #fff;
            color: #6f42c1;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            text-align: center;
            color: white;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: #28a745;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-status {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 50px;
            font-style: italic;
        }

        .voice-response {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .person-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .person-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .person-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .person-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .time-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .medicine-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .medicine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .medicine-item.low-stock {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .medicine-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .medicine-stock {
            text-align: right;
            margin-left: 15px;
        }

        .stock-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }

        .stock-count.low {
            color: #dc3545;
        }

        .stock-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-take {
            background: #28a745;
            color: white;
        }

        .btn-take:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .alert {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            color: #721c24;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .alert-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .current-time {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .urgent-alert {
            animation: pulse 2s infinite;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom notification popup */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice-Activated Medicine System</h1>
            <p>Real Notifications & Reminders - Works Like a Mobile App!</p>
        </div>

        <!-- PWA Installation Section -->
        <div class="pwa-section">
            <h3>üì± Install as Mobile App</h3>
            <p>Make this a real app on your phone for better notifications!</p>
            <button class="install-button" id="installButton" onclick="installPWA()">
                üì≤ Install App on Home Screen
            </button>
            <div id="installInstructions" style="margin-top: 15px; font-size: 0.9rem;">
                <p><strong>Manual Installation:</strong></p>
                <p>‚Ä¢ On Android: Chrome menu ‚Üí "Add to Home screen"</p>
                <p>‚Ä¢ On iPhone: Safari Share button ‚Üí "Add to Home Screen"</p>
            </div>
        </div>

        <!-- Notification Setup Section -->
        <div class="notification-setup">
            <h3>üîî Smart Notification System</h3>
            <p>Enable different types of reminders:</p>
            
            <div>
                <button class="setup-button" onclick="enableBrowserNotifications()">
                    üîî Enable Browser Notifications
                </button>
                <button class="setup-button" onclick="setupWebReminders()">
                    ‚è∞ Setup Web Reminders
                </button>
                <button class="setup-button" onclick="downloadCalendar()">
                    üìÖ Download Calendar Events
                </button>
                <button class="setup-button" onclick="setupEmailReminders()">
                    üìß Email Reminders
                </button>
            </div>
            
            <div class="notification-status" id="notificationStatus">
                Click "Enable Browser Notifications" to get started!
            </div>
        </div>

        <!-- Voice Assistant Section -->
        <div class="voice-assistant">
            <h3>ü§ñ MediBot Voice Assistant</h3>
            <div>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    üé§
                </button>
                <button class="voice-button" onclick="stopSpeaking()" title="Stop Speaking">
                    üîá
                </button>
            </div>
            
            <div class="voice-status" id="voiceStatus">Click microphone to start listening</div>
            
            <div class="voice-transcript" id="voiceTranscript">
                Your speech will appear here...
            </div>
            
            <div class="voice-response" id="voiceResponse">
                MediBot's responses will appear here...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('father')">üë® Father's Medicines</button>
            <button class="nav-tab" onclick="showTab('mother')">üë© Mother's Medicines</button>
            <button class="nav-tab" onclick="showTab('alerts')">‚ö†Ô∏è Stock Alerts</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="current-time" id="currentTime"></div>
            
            <div class="alert">
                <span class="alert-icon">üí°</span>
                <div>
                    <strong>Pro Tip:</strong> Keep this tab open or install as an app for automatic reminders!
                    Next reminder: <span id="nextReminderTime">--</span>
                </div>
            </div>
        </div>

        <div id="father" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë®</div>
                    <div class="person-name">Father's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üåÖ</span>
                        Before Breakfast (Morning)
                    </div>
                    <div id="fatherMorningBefore"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast
                    </div>
                    <div id="fatherMorningAfter"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üïê</span>
                        4 PM
                    </div>
                    <div id="father4PM"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner
                    </div>
                    <div id="fatherNight"></div>
                </div>
            </div>
        </div>

        <div id="mother" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">üë©</div>
                    <div class="person-name">Mother's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üç≥</span>
                        After Breakfast
                    </div>
                    <div id="motherMorning"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">üçΩÔ∏è</span>
                        After Dinner
                    </div>
                    <div id="motherNight"></div>
                </div>
            </div>
        </div>

        <div id="alerts" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">üö® Stock Alerts & Warnings</h2>
            <div id="stockAlerts"></div>
        </div>
    </div>

    <!-- Custom Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <button class="close-btn" onclick="closeNotification()">&times;</button>
        <div id="notificationContent">
            <h4>üîî Medicine Reminder</h4>
            <p>It's time for your scheduled medicine!</p>
        </div>
    </div>

    <script>
        // PWA and Notification variables
        let deferredPrompt;
        let notificationPermission = Notification.permission;
        let reminderIntervals = [];

        // Medicine data structure - FIXED with proper structure
        const medicineData = {
            father: {
                morningBefore: [
                    { name: "Maxi PhD", dosage: "30 days tablets", stock: 30, originalStock: 30 }
                ],
                morningAfter: [
                    { name: "Metolol MF", dosage: "60mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Pilclop", dosage: "75mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Cordarone", dosage: "30 days", stock: 30, originalStock: 30 },
                    { name: "Orofer XT", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Hyqvit", dosage: "30 tablets", stock: 30, originalStock: 30 }
                ],
                afternoon: [
                    { name: "Acitrom", dosage: "1mg/2mg alternate days - 30 days", stock: 30, originalStock: 30 }
                ],
                night: [
                    { name: "Rotin F", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Telmiford", dosage: "40mg - 30 tablets", stock: 30, originalStock: 30 }
                ]
            },
            mother: {
                morning: [
                    { name: "Telzox H", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Cinod", dosage: "10mg - 1 tablet (Morning dose)", stock: 60, originalStock: 60 },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Morning dose)", stock: 60, originalStock: 60 }
                ],
                night: [
                    { name: "Cinod", dosage: "10mg - 1 tablet (Evening dose)", stock: 60, originalStock: 60 },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Evening dose)", stock: 60, originalStock: 60 }
                ]
            }
        };

        // Medicine reminder times (24-hour format)
        const reminderTimes = [
            { time: '08:00', message: "Time for Father's morning medicine (before breakfast) - Maxi PhD" },
            { time: '10:00', message: "Time for after-breakfast medicines for Father and Mother (including Cinod and Zavamet)" },
            { time: '16:00', message: "Time for Father's 4 PM medicine (Acitrom)" },
            { time: '22:00', message: "Time for evening medicines for both parents (including Cinod and Zavamet for Mother)" }
        ];

        // Initialize the application
        function init() {
            console.log("Initializing MediBot system...");
            
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup PWA installation
            setupPWA();
            
            // Setup reminder system
            setupReminderSystem();
            
            // Update next reminder display
            updateNextReminder();
            setInterval(updateNextReminder, 60000);
            
            // Initialize voice if available
            initializeVoiceRecognition();
            
            // Populate medicine schedules
            console.log("Populating medicine schedules...");
            populateMedicineSchedules();
            
            // Generate stock alerts
            generateStockAlerts();
            
            // Auto-greet user
            setTimeout(() => {
                speak("Welcome to MediBot! All medicine schedules loaded successfully.");
            }, 2000);
        }

        // Populate medicine schedules in the UI
        function populateMedicineSchedules() {
            console.log("Starting to populate medicine schedules...");
            console.log("Medicine data:", medicineData);
            
            // Father's medicines
            console.log("Populating father's medicines...");
            populateTimeSection('fatherMorningBefore', medicineData.father.morningBefore, 'father', 'morningBefore');
            populateTimeSection('fatherMorningAfter', medicineData.father.morningAfter, 'father', 'morningAfter');
            populateTimeSection('father4PM', medicineData.father.afternoon, 'father', 'afternoon');
            populateTimeSection('fatherNight', medicineData.father.night, 'father', 'night');
            
            // Mother's medicines
            console.log("Populating mother's medicines...");
            populateTimeSection('motherMorning', medicineData.mother.morning, 'mother', 'morning');
            populateTimeSection('motherNight', medicineData.mother.night, 'mother', 'night');
            
            console.log("Medicine schedules populated successfully!");
        }

        // Populate a specific time section with medicines
        function populateTimeSection(sectionId, medicines, person, timeSlot) {
            console.log(`Populating section: ${sectionId}, person: ${person}, timeSlot: ${timeSlot}`);
            console.log("Medicines:", medicines);
            
            const section = document.getElementById(sectionId);
            if (!section) {
                console.error(`Section element not found: ${sectionId}`);
                return;
            }
            
            if (!medicines || medicines.length === 0) {
                console.log(`No medicines found for ${sectionId}`);
                section.innerHTML = '<p style="color: #6c757d; font-style: italic;">No medicines scheduled for this time.</p>';
                return;
            }
            
            section.innerHTML = '';
            
            medicines.forEach((medicine, index) => {
                console.log(`Creating medicine element for: ${medicine.name} (index: ${index})`);
                const medicineElement = createMedicineElement(medicine, person, timeSlot, index);
                section.appendChild(medicineElement);
            });
            
            console.log(`Section ${sectionId} populated with ${medicines.length} medicines`);
        }

        // Create a medicine element
        function createMedicineElement(medicine, person, timeSlot, index) {
            const div = document.createElement('div');
            div.className = `medicine-item ${medicine.stock <= 5 ? 'low-stock' : ''}`;
            
            // Create unique IDs for this medicine
            const uniqueId = `${person}-${timeSlot}-${index}`;
            
            div.innerHTML = `
                <div class="medicine-info">
                    <div class="medicine-name">${medicine.name}</div>
                    <div class="medicine-details">${medicine.dosage}</div>
                    <div class="control-buttons">
                        <button class="btn btn-take" onclick="takeMedicine('${medicine.name}', '${person}', '${timeSlot}', ${index})">
                            ‚úì Take Dose
                        </button>
                        <button class="btn btn-add" onclick="addMedicineStock('${medicine.name}', '${person}', '${timeSlot}', ${index})">
                            + Add Stock
                        </button>
                    </div>
                </div>
                <div class="medicine-stock">
                    <div class="stock-count ${medicine.stock <= 5 ? 'low' : ''}" id="stock-${uniqueId}">
                        ${medicine.stock}
                    </div>
                    <div class="stock-label">doses left</div>
                </div>
            `;
            
            return div;
        }

        // Generate stock alerts
        function generateStockAlerts() {
            const alertsContainer = document.getElementById('stockAlerts');
            if (!alertsContainer) return;
            
            alertsContainer.innerHTML = '';
            
            let hasAlerts = false;
            
            // Check all medicines for low stock
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        if (medicine.stock <= 5) {
                            hasAlerts = true;
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert urgent-alert';
                            alertDiv.innerHTML = `
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <div>
                                    <strong>LOW STOCK ALERT:</strong> ${medicine.name} 
                                    (${person.charAt(0).toUpperCase() + person.slice(1)}) 
                                    has only ${medicine.stock} doses remaining!
                                    <br><small>Please order more soon to avoid running out.</small>
                                </div>
                            `;
                            alertsContainer.appendChild(alertDiv);
                        }
                    });
                });
            });
            
            if (!hasAlerts) {
                alertsContainer.innerHTML = `
                    <div class="alert" style="background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%); color: #0c5460; border-color: #17a2b8;">
                        <span class="alert-icon">‚úÖ</span>
                        <div>
                            <strong>All Good!</strong> All medicines have adequate stock levels.
                            <br><small>Keep monitoring stock levels for timely refills.</small>
                        </div>
                        </div>
                `;
            }
        }

        // Take medicine function
        function takeMedicine(medicineName, person, timeSlot, index) {
            console.log(`Taking medicine: ${medicineName} for ${person} at ${timeSlot}, index: ${index}`);
            
            // Find and update the medicine stock
            const medicine = medicineData[person][timeSlot][index];
            if (medicine && medicine.stock > 0) {
                medicine.stock--;
                
                // Update the display
                const uniqueId = `${person}-${timeSlot}-${index}`;
                const stockElement = document.getElementById(`stock-${uniqueId}`);
                if (stockElement) {
                    stockElement.textContent = medicine.stock;
                    stockElement.className = `stock-count ${medicine.stock <= 5 ? 'low' : ''}`;
                }
                
                // Update the medicine item styling if low stock
                const medicineElement = stockElement.closest('.medicine-item');
                if (medicine.stock <= 5) {
                    medicineElement.classList.add('low-stock');
                } else {
                    medicineElement.classList.remove('low-stock');
                }
                
                // Show notification
                showNotification(`‚úÖ ${medicineName} taken! ${medicine.stock} doses remaining.`);
                speak(`${medicineName} dose recorded. ${medicine.stock} doses remaining.`);
                
                // Regenerate stock alerts
                generateStockAlerts();
            } else {
                showNotification(`‚ö†Ô∏è No stock remaining for ${medicineName}!`);
                speak(`Warning: No stock remaining for ${medicineName}. Please refill immediately.`);
            }
        }

        // Add medicine stock function
        function addMedicineStock(medicineName, person, timeSlot, index) {
            const amount = prompt(`How many doses of ${medicineName} would you like to add?`, '30');
            if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                const addAmount = parseInt(amount);
                const medicine = medicineData[person][timeSlot][index];
                
                if (medicine) {
                    medicine.stock += addAmount;
                    
                    // Update the display
                    const uniqueId = `${person}-${timeSlot}-${index}`;
                    const stockElement = document.getElementById(`stock-${uniqueId}`);
                    if (stockElement) {
                        stockElement.textContent = medicine.stock;
                        stockElement.className = `stock-count ${medicine.stock <= 5 ? 'low' : ''}`;
                    }
                    
                    // Remove low stock styling if stock is now adequate
                    const medicineElement = stockElement.closest('.medicine-item');
                    if (medicine.stock > 5) {
                        medicineElement.classList.remove('low-stock');
                    }
                    
                    showNotification(`‚úÖ Added ${addAmount} doses to ${medicineName}. Total: ${medicine.stock} doses.`);
                    speak(`Added ${addAmount} doses to ${medicineName}. Total stock is now ${medicine.stock} doses.`);
                    
                    // Regenerate stock alerts
                    generateStockAlerts();
                }
            }
        }

        // PWA Setup
        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installButton').style.display = 'inline-block';
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                deferredPrompt = null;
                document.getElementById('installButton').style.display = 'none';
                showNotification('App installed successfully! You can now use it offline.');
            });
        }

        // Install PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('installButton').style.display = 'none';
            } else {
                showNotification('To install: Use browser menu ‚Üí "Add to Home screen" or "Install app"');
            }
        }

        // Notification functions
        function enableBrowserNotifications() {
            if (!("Notification" in window)) {
                alert("This browser does not support notifications");
                return;
            }

            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                updateNotificationStatus();
                if (permission === 'granted') {
                    showNotification('Notifications enabled! You will receive medicine reminders.');
                    setupReminderSystem();
                }
            });
        }

        function updateNotificationStatus() {
            const statusElement = document.getElementById('notificationStatus');
            if (notificationPermission === 'granted') {
                statusElement.innerHTML = '‚úÖ Notifications enabled! Reminders will appear automatically.';
                statusElement.className = 'notification-status status-granted';
            } else if (notificationPermission === 'denied') {
                statusElement.innerHTML = '‚ùå Notifications blocked. Please enable in browser settings.';
                statusElement.className = 'notification-status status-denied';
            } else {
                statusElement.innerHTML = '‚è≥ Click "Enable Browser Notifications" to get started!';
                statusElement.className = 'notification-status status-pending';
            }
        }

        function setupWebReminders() {
            clearAllReminders();
            reminderTimes.forEach(reminder => {
                const [hour, minute] = reminder.time.split(':').map(Number);
                scheduleReminder(hour, minute, reminder.message);
            });
            showNotification('Web reminders activated! Automatic alerts scheduled.');
        }

        function setupReminderSystem() {
            setupWebReminders();
            updateNotificationStatus();
        }

        function scheduleReminder(hour, minute, message) {
            const now = new Date();
            const reminderTime = new Date();
            reminderTime.setHours(hour, minute, 0, 0);
            
            if (reminderTime <= now) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            const timeUntilReminder = reminderTime.getTime() - now.getTime();
            
            const intervalId = setTimeout(() => {
                sendReminder(message);
                scheduleReminder(hour, minute, message); // Reschedule for next day
            }, timeUntilReminder);
            
            reminderIntervals.push(intervalId);
        }

        function sendReminder(message) {
            // Browser notification
            if (notificationPermission === 'granted') {
                new Notification('üîî Medicine Reminder', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üíä</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üîî</text></svg>',
                    requireInteraction: true
                });
            }
            
            // Custom popup notification
            showCustomNotification(message);
            
            // Voice announcement
            speak(message);
            
            // Log the reminder
            console.log('Reminder sent:', message);
        }

        function showCustomNotification(message) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `
                <h4>üîî Medicine Reminder</h4>
                <p>${message}</p>
                <div style="margin-top: 10px;">
                    <button onclick="closeNotification()" style="background: white; color: #667eea; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                        Got it!
                    </button>
                </div>
            `;
            
            popup.classList.add('show');
            
            // Auto-close after 30 seconds
            setTimeout(() => {
                closeNotification();
            }, 30000);
        }

        function closeNotification() {
            document.getElementById('notificationPopup').classList.remove('show');
        }

        function clearAllReminders() {
            reminderIntervals.forEach(clearTimeout);
            reminderIntervals = [];
        }

        function showNotification(message) {
            showCustomNotification(message);
        }

        // Calendar and Email functions
        function downloadCalendar() {
            const events = [];
            reminderTimes.forEach(reminder => {
                const eventText = `BEGIN:VEVENT
DTSTART:${getTodayDateString()}T${reminder.time.replace(':', '')}00
DTEND:${getTodayDateString()}T${getEndTime(reminder.time)}00
RRULE:FREQ=DAILY
SUMMARY:Medicine Reminder
DESCRIPTION:${reminder.message}
END:VEVENT`;
                events.push(eventText);
            });
            
            const calendar = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MediBot//Medicine Reminders//EN
${events.join('\n')}
END:VCALENDAR`;
            
            const blob = new Blob([calendar], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'medicine-reminders.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Calendar file downloaded! Import it to your calendar app.');
        }

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0].replace(/-/g, '');
        }

        function getEndTime(startTime) {
            const [hour, minute] = startTime.split(':').map(Number);
            const endHour = String(hour).padStart(2, '0');
            const endMinute = String(minute + 15).padStart(2, '0');
            return `${endHour}${endMinute}`;
        }

        function setupEmailReminders() {
            const subject = encodeURIComponent('Medicine Reminder Schedule');
            const body = encodeURIComponent(`Medicine Reminder Times:

${reminderTimes.map(r => `${r.time} - ${r.message}`).join('\n')}

Set up your email client to send you daily reminders at these times.`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
            showNotification('Email template opened! Send yourself reminders.');
        }

        // Voice Recognition
        let recognition;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log('Voice recognition started');
                    document.getElementById('voiceStatus').textContent = 'üé§ Listening...';
                    document.getElementById('voiceButton').classList.add('listening');
                    isListening = true;
                };
                
                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    
                    document.getElementById('voiceTranscript').textContent = transcript;
                    
                    if (event.results[event.results.length - 1].isFinal) {
                        processVoiceCommand(transcript);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Voice recognition error:', event.error);
                    document.getElementById('voiceStatus').textContent = `‚ùå Error: ${event.error}`;
                    resetVoiceButton();
                };
                
                recognition.onend = function() {
                    console.log('Voice recognition ended');
                    resetVoiceButton();
                };
            } else {
                document.getElementById('voiceStatus').textContent = '‚ùå Voice recognition not supported';
                document.getElementById('voiceButton').disabled = true;
            }
        }

        function toggleVoiceRecognition() {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function resetVoiceButton() {
            document.getElementById('voiceStatus').textContent = 'Click microphone to start listening';
            document.getElementById('voiceButton').classList.remove('listening');
            isListening = false;
        }

        function processVoiceCommand(transcript) {
            console.log('Processing command:', transcript);
            const command = transcript.toLowerCase();
            
            let response = '';
            
            // Medicine-related commands
            if (command.includes('stock') || command.includes('how many')) {
                response = getStockInfo(command);
            } else if (command.includes('take') || command.includes('taken')) {
                response = processTakeCommand(command);
            } else if (command.includes('remind') || command.includes('reminder')) {
                response = getNextReminder();
            } else if (command.includes('low stock') || command.includes('alert')) {
                response = getLowStockAlert();
            } else if (command.includes('schedule') || command.includes('medicine time')) {
                response = getMedicineSchedule();
            } else if (command.includes('help')) {
                response = getHelpInformation();
            } else {
                response = "I didn't understand that command. Try asking about stock levels, reminders, or say 'help' for available commands.";
            }
            
            document.getElementById('voiceResponse').textContent = response;
            speak(response);
        }

        function getStockInfo(command) {
            let response = '';
            let foundMedicine = false;
            
            // Search for specific medicine mentioned
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        if (command.includes(medicine.name.toLowerCase())) {
                            response += `${medicine.name} has ${medicine.stock} doses remaining. `;
                            foundMedicine = true;
                        }
                    });
                });
            });
            
            if (!foundMedicine) {
                // General stock overview
                response = 'Stock overview: ';
                let lowStockCount = 0;
                
                Object.keys(medicineData).forEach(person => {
                    Object.keys(medicineData[person]).forEach(timeSlot => {
                        medicineData[person][timeSlot].forEach(medicine => {
                            if (medicine.stock <= 5) {
                                response += `${medicine.name} is low with ${medicine.stock} doses. `;
                                lowStockCount++;
                            }
                        });
                    });
                });
                
                if (lowStockCount === 0) {
                    response += 'All medicines have adequate stock levels.';
                }
            }
            
            return response || 'No stock information found.';
        }

        function processTakeCommand(command) {
            // This would need more sophisticated parsing to identify specific medicines
            return "Please use the take dose buttons in the medicine schedule for accurate tracking.";
        }

        function getNextReminder() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            let nextReminder = null;
            let minDiff = Infinity;
            
            reminderTimes.forEach(reminder => {
                const [hour, minute] = reminder.time.split(':').map(Number);
                const reminderTime = hour * 60 + minute;
                
                let diff = reminderTime - currentTime;
                if (diff < 0) diff += 24 * 60; // Next day
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextReminder = reminder;
                }
            });
            
            if (nextReminder) {
                const hours = Math.floor(minDiff / 60);
                const minutes = minDiff % 60;
                return `Next reminder is at ${nextReminder.time} (in ${hours} hours and ${minutes} minutes): ${nextReminder.message}`;
            }
            
            return 'No upcoming reminders found.';
        }

        function getLowStockAlert() {
            let alerts = [];
            
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        if (medicine.stock <= 5) {
                            alerts.push(`${medicine.name} has only ${medicine.stock} doses left`);
                        }
                    });
                });
            });
            
            if (alerts.length === 0) {
                return 'All medicines have adequate stock levels.';
            }
            
            return `Low stock alerts: ${alerts.join('. ')}. Please reorder soon.`;
        }

        function getMedicineSchedule() {
            return `Medicine schedule: Morning before breakfast at 8 AM, after breakfast at 10 AM, afternoon at 4 PM, and evening after dinner at 10 PM. Check the medicine tabs for detailed schedules.`;
        }

        function getHelpInformation() {
            return `Available voice commands: Ask about stock levels, say 'take medicine' for instructions, ask for reminders, request low stock alerts, or ask about the schedule. You can also say specific medicine names to get their stock information.`;
        }

        function speak(text) {
            if (speechSynthesis && text) {
                speechSynthesis.cancel(); // Cancel any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // Time and reminder functions
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const element = document.getElementById('currentTime');
            if (element) {
                element.textContent = `Current Time: ${timeString}`;
            }
        }

        function updateNextReminder() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            let nextReminder = null;
            let minDiff = Infinity;
            
            reminderTimes.forEach(reminder => {
                const [hour, minute] = reminder.time.split(':').map(Number);
                const reminderTime = hour * 60 + minute;
                
                let diff = reminderTime - currentTime;
                if (diff < 0) diff += 24 * 60; // Next day
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextReminder = reminder;
                }
            });
            
            const element = document.getElementById('nextReminderTime');
            if (element && nextReminder) {
                const hours = Math.floor(minDiff / 60);
                const minutes = minDiff % 60;
                element.textContent = `${nextReminder.time} (in ${hours}h ${minutes}m)`;
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const selectedContent = document.getElementById(tabName);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1lZGljaW5lIFJlbWluZGVyIFN5c3RlbSIsCiAgInNob3J0X25hbWUiOiAiTWVkaUJvdCIsCiAgImRlc2NyaXB0aW9uIjogIlZvaWNlLWFjdGl2YXRlZCBtZWRpY2luZSByZW1pbmRlciBhbmQgc3RvY2sgYWxlcnQgc3lzdGVtIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM2NjdlZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzY3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJTNlJTNjdGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJTNlJUYwJTlGJTkyJThBJTNjL3RleHQlM2UlM2Mvc3ZnJTNlIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Activated Medicine Reminder & Stock Alert System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                margin: 10px;
                padding: 0;
            }
            
            body {
                padding: 10px;
            }
        }

        /* Notification Setup Panel */
        .notification-setup {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
        }

        .setup-button {
            background: #fff;
            color: #17a2b8;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .setup-button:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .notification-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-granted {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #155724;
        }

        .status-denied {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #856404;
        }

        /* PWA Installation */
        .pwa-section {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
        }

        .install-button {
            background: #fff;
            color: #6f42c1;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Voice Assistant Styles */
        .voice-assistant {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
            text-align: center;
            color: white;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border: none;
            cursor: pointer;
            font-size: 2rem;
            color: #28a745;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .voice-status {
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 50px;
            font-style: italic;
        }

        .voice-response {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tab-content {
                padding: 15px;
            }
        }

        .person-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .person-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .person-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .person-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            .person-name {
                font-size: 1.4rem;
            }
            
            .person-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .time-header {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .medicine-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .medicine-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .medicine-item.low-stock {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        @media (max-width: 768px) {
            .medicine-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .medicine-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .medicine-stock {
            text-align: right;
            margin-left: 15px;
        }

        @media (max-width: 768px) {
            .medicine-stock {
                text-align: left;
                margin-left: 0;
                margin-top: 10px;
                display: flex;
                align-items: center;
                gap: 15px;
                width: 100%;
            }
        }

        .stock-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }

        .stock-count.low {
            color: #dc3545;
        }

        .stock-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 2px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .control-buttons {
                flex-wrap: wrap;
                width: 100%;
            }
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-take {
            background: #28a745;
            color: white;
        }

        .btn-take:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        /* Dose taken checkbox styles */
        .dose-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .dose-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #28a745;
        }

        .dose-checkbox-label {
            font-size: 0.85rem;
            color: #495057;
            cursor: pointer;
        }

        .dose-taken {
            background: #d4edda !important;
            border-color: #28a745 !important;
        }

        .dose-taken .medicine-name {
            text-decoration: line-through;
            color: #6c757d;
        }

        .alert {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            color: #721c24;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        }

        .alert-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        /* Fixed scrollable stock alerts for mobile */
        .stock-alerts-container {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        @media (max-width: 768px) {
            .stock-alerts-container {
                max-height: 60vh;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Scrollbar styling */
        .stock-alerts-container::-webkit-scrollbar {
            width: 8px;
        }

        .stock-alerts-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .stock-alerts-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .current-time {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .urgent-alert {
            animation: pulse 2s infinite;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom notification popup */
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
        }

        .notification-popup.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .notification-popup {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-200px);
            }
            
            .notification-popup.show {
                transform: translateY(0);
            }
        }

        .notification-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Low stock warning styles */
        .low-stock-warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px;
            text-align: center;
            animation: pulse 2s infinite;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .reset-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 5px;
        }

        .reset-button:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 Voice-Activated Medicine System</h1>
            <p>Real Notifications & Reminders - Works Like a Mobile App!</p>
        </div>

        <!-- PWA Installation Section -->
        <div class="pwa-section">
            <h3>📱 Install as Mobile App</h3>
            <p>Make this a real app on your phone for better notifications!</p>
            <button class="install-button" id="installButton" onclick="installPWA()">
                📲 Install App on Home Screen
            </button>
            <div id="installInstructions" style="margin-top: 15px; font-size: 0.9rem;">
                <p><strong>Manual Installation:</strong></p>
                <p>• On Android: Chrome menu → "Add to Home screen"</p>
                <p>• On iPhone: Safari Share button → "Add to Home Screen"</p>
            </div>
        </div>

        <!-- Low Stock Warning Banner -->
        <div id="lowStockWarning" class="low-stock-warning" style="display: none;">
            <h3>⚠️ LOW STOCK ALERT!</h3>
            <p id="lowStockMessage"></p>
            <button onclick="checkLowStockAlerts()" class="btn" style="background: white; color: #ff6b6b; margin-top: 10px;">
                📊 View Stock Details
            </button>
        </div>

        <!-- Notification Setup Section -->
        <div class="notification-setup">
            <h3>🔔 Smart Notification System</h3>
            <p>Enable different types of reminders:</p>
            
            <div>
                <button class="setup-button" onclick="enableBrowserNotifications()">
                    🔔 Enable Browser Notifications
                </button>
                <button class="setup-button" onclick="setupWebReminders()">
                    ⏰ Setup Web Reminders
                </button>
                <button class="setup-button" onclick="downloadCalendar()">
                    📅 Download Calendar Events
                </button>
                <button class="setup-button" onclick="setupEmailReminders()">
                    📧 Email Reminders
                </button>
                <button class="reset-button" onclick="resetAllData()">
                    🔄 Reset All Data
                </button>
            </div>
            
            <div class="notification-status" id="notificationStatus">
                Click "Enable Browser Notifications" to get started!
            </div>
        </div>

        <!-- Voice Assistant Section -->
        <div class="voice-assistant">
            <h3>🤖 MediBot Voice Assistant</h3>
            <div>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceRecognition()">
                    🎤
                </button>
                <button class="voice-button" onclick="stopSpeaking()" title="Stop Speaking">
                    🔇
                </button>
            </div>
            
            <div class="voice-status" id="voiceStatus">Click microphone to start listening</div>
            
            <div class="voice-transcript" id="voiceTranscript">
                Your speech will appear here...
            </div>
            
            <div class="voice-response" id="voiceResponse">
                MediBot's responses will appear here...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showTab('father')">👨 Father</button>
            <button class="nav-tab" onclick="showTab('mother')">👩 Mother</button>
            <button class="nav-tab" onclick="showTab('alerts')">⚠️ Alerts</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="current-time" id="currentTime"></div>
            
            <div class="alert">
                <span class="alert-icon">💡</span>
                <div>
                    <strong>Pro Tip:</strong> Keep this tab open or install as an app for automatic reminders!
                    Next reminder: <span id="nextReminderTime">--</span>
                </div>
            </div>
        </div>

        <div id="father" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">👨</div>
                    <div class="person-name">Father's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🌅</span>
                        Before Breakfast (Morning - 8:00 AM)
                    </div>
                    <div id="fatherMorningBefore"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍳</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="fatherMorningAfter"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🕐</span>
                        Afternoon (4:00 PM)
                    </div>
                    <div id="father4PM"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍽️</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="fatherNight"></div>
                </div>
            </div>
        </div>

        <div id="mother" class="tab-content">
            <div class="person-section">
                <div class="person-header">
                    <div class="person-icon">👩</div>
                    <div class="person-name">Mother's Medicine Schedule</div>
                </div>
                
                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍳</span>
                        After Breakfast (10:00 AM)
                    </div>
                    <div id="motherMorning"></div>
                </div>

                <div class="time-section">
                    <div class="time-header">
                        <span class="time-icon">🍽️</span>
                        After Dinner (10:00 PM)
                    </div>
                    <div id="motherNight"></div>
                </div>
            </div>
        </div>

        <div id="alerts" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">🚨 Stock Alerts & Warnings</h2>
            <div class="stock-alerts-container">
                <div id="stockAlerts"></div>
            </div>
        </div>
    </div>

    <!-- Custom Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <button class="close-btn" onclick="closeNotification()">&times;</button>
        <div id="notificationContent">
            <h4>🔔 Medicine Reminder</h4>
            <p>It's time for your scheduled medicine!</p>
        </div>
    </div>

    <script>
        // PWA and Notification variables
        let deferredPrompt;
        let notificationPermission = Notification.permission;
        let reminderIntervals = [];

        // Storage key for persistent data
        const STORAGE_KEY = 'medicineData';
        const DOSES_TAKEN_KEY = 'dosesTakenToday';

        // Get today's date string for dose tracking
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // Default medicine data - only used for initialization
        const defaultMedicineData = {
            father: {
                morningBefore: [
                    { name: "Maxi PhD", dosage: "30 days tablets", stock: 30, originalStock: 30 }
                ],
                morningAfter: [
                    { name: "Metolol MF", dosage: "60mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Pilclop", dosage: "75mg - 30 days", stock: 30, originalStock: 30 },
                    { name: "Cordarone", dosage: "30 days", stock: 30, originalStock: 30 },
                    { name: "Orofer XT", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Hyqvit", dosage: "30 tablets", stock: 30, originalStock: 30 }
                ],
                afternoon: [
                    { name: "Acitrom", dosage: "1mg/2mg alternate days - 30 days", stock: 30, originalStock: 30 }
                ],
                night: [
                    { name: "Rotin F", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Telmiford", dosage: "40mg - 30 tablets", stock: 30, originalStock: 30 }
                ]
            },
            mother: {
                morning: [
                    { name: "Telzox H", dosage: "30 tablets", stock: 30, originalStock: 30 },
                    { name: "Cinod", dosage: "10mg - 1 tablet (Morning dose)", stock: 60, originalStock: 60 },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Morning dose)", stock: 60, originalStock: 60 }
                ],
                night: [
                    { name: "Cinod", dosage: "10mg - 1 tablet (Evening dose)", stock: 60, originalStock: 60 },
                    { name: "Zavamet", dosage: "50/500 - 1 tablet (Evening dose)", stock: 60, originalStock: 60 }
                ]
            }
        };

        // Load or initialize medicine data
        function loadMedicineData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading saved data, using default:', e);
                    return JSON.parse(JSON.stringify(defaultMedicineData));
                }
            }
            return JSON.parse(JSON.stringify(defaultMedicineData));
        }

        // Save medicine data
        function saveMedicineData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(medicineData));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Load doses taken today
        function loadDosesTakenToday() {
            const today = getTodayDateString();
            const saved = localStorage.getItem(DOSES_TAKEN_KEY);
            if (saved) {
                try {
                    const allDoses = JSON.parse(saved);
                    return allDoses[today] || {};
                } catch (e) {
                    return {};
                }
            }
            return {};
        }

        // Save doses taken today
        function saveDosesTakenToday(dosesTaken) {
            const today = getTodayDateString();
            try {
                const saved = localStorage.getItem(DOSES_TAKEN_KEY);
                const allDoses = saved ? JSON.parse(saved) : {};
                allDoses[today] = dosesTaken;
                localStorage.setItem(DOSES_TAKEN_KEY, JSON.stringify(allDoses));
            } catch (e) {
                console.error('Error saving doses taken:', e);
            }
        }

        // Initialize medicine data and doses taken
        let medicineData = loadMedicineData();
        let dosesTakenToday = loadDosesTakenToday();

        // Voice Recognition variables
        let recognition = null;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;

        // Check browser support
        function checkBrowserSupport() {
            const features = {
                notifications: 'Notification' in window,
                speechRecognition: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                speechSynthesis: 'speechSynthesis' in window
            };
            return features;
        }

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('Add to Home Screen: Use your browser menu to add this app to your home screen!');
            }
        }

        // Notification Functions
        function updateNotificationStatus() {
            const statusDiv = document.getElementById('notificationStatus');
            if (Notification.permission === 'granted') {
                statusDiv.className = 'notification-status status-granted';
                statusDiv.textContent = '✅ Notifications enabled! You\'ll get medicine reminders.';
            } else if (Notification.permission === 'denied') {
                statusDiv.className = 'notification-status status-denied';
                statusDiv.textContent = '❌ Notifications blocked. Please enable in browser settings.';
            } else {
                statusDiv.className = 'notification-status status-pending';
                statusDiv.textContent = '⏳ Click "Enable Browser Notifications" to get started!';
            }
        }

        function enableBrowserNotifications() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }

            Notification.requestPermission().then(permission => {
                updateNotificationStatus();
                if (permission === 'granted') {
                    showCustomNotification('Success!', 'Notifications are now enabled. You\'ll get medicine reminders.');
                    setupAutomaticReminders();
                }
            });
        }

        function showCustomNotification(title, message, urgent = false) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            content.innerHTML = `
                <h4>🔔 ${title}</h4>
                <p>${message}</p>
            `;
            
            if (urgent) {
                popup.classList.add('urgent-alert');
            }
            
            popup.classList.add('show');
            
            // Auto close after 10 seconds
            setTimeout(() => {
                closeNotification();
            }, 10000);

            // Also try browser notification
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTYiIGZpbGw9IiM2NjdlZWEiLz4KPHR2ZSB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+'
                });
            }
        }

        function closeNotification() {
            const popup = document.getElementById('notificationPopup');
            popup.classList.remove('show', 'urgent-alert');
        }

        // Medicine Management Functions
        function takeMedicine(person, timeSlot, index) {
            const medicine = medicineData[person][timeSlot][index];
            if (medicine.stock > 0) {
                medicine.stock--;
                saveMedicineData();
                
                // Mark dose as taken
                const doseKey = `${person}_${timeSlot}_${index}`;
                dosesTakenToday[doseKey] = true;
                saveDosesTakenToday(dosesTakenToday);
                
                renderMedicineSchedule();
                checkStockAlerts();
                
                speak(`${medicine.name} taken. ${medicine.stock} tablets remaining.`);
                
                if (medicine.stock <= 5) {
                    showCustomNotification('Low Stock Warning!', `${medicine.name} is running low. Only ${medicine.stock} left!`, true);
                }
            }
        }

        function addStock(person, timeSlot, index, amount = 30) {
            medicineData[person][timeSlot][index].stock += amount;
            saveMedicineData();
            renderMedicineSchedule();
            checkStockAlerts();
            
            const medicine = medicineData[person][timeSlot][index];
            speak(`Added ${amount} tablets to ${medicine.name}. Total: ${medicine.stock}.`);
        }

        function isDoseTaken(person, timeSlot, index) {
            const doseKey = `${person}_${timeSlot}_${index}`;
            return dosesTakenToday[doseKey] || false;
        }

        function toggleDose(person, timeSlot, index, checkbox) {
            const doseKey = `${person}_${timeSlot}_${index}`;
            if (checkbox.checked) {
                dosesTakenToday[doseKey] = true;
                takeMedicine(person, timeSlot, index);
            } else {
                delete dosesTakenToday[doseKey];
                saveDosesTakenToday(dosesTakenToday);
                renderMedicineSchedule();
            }
        }

        function renderMedicineItem(medicine, person, timeSlot, index) {
            const isLowStock = medicine.stock <= 5;
            const doseTaken = isDoseTaken(person, timeSlot, index);
            
            return `
                <div class="medicine-item ${isLowStock ? 'low-stock' : ''} ${doseTaken ? 'dose-taken' : ''}">
                    <div class="medicine-info">
                        <div class="medicine-name">${medicine.name}</div>
                        <div class="medicine-details">${medicine.dosage}</div>
                        <div class="dose-checkbox-container">
                            <input type="checkbox" class="dose-checkbox" 
                                   ${doseTaken ? 'checked' : ''} 
                                   onchange="toggleDose('${person}', '${timeSlot}', ${index}, this)"
                                   id="dose_${person}_${timeSlot}_${index}">
                            <label class="dose-checkbox-label" for="dose_${person}_${timeSlot}_${index}">
                                Dose taken today
                            </label>
                        </div>
                    </div>
                    <div class="medicine-stock">
                        <div class="stock-count ${isLowStock ? 'low' : ''}">${medicine.stock}</div>
                        <div class="stock-label">tablets left</div>
                        <div class="control-buttons">
                            <button class="btn btn-take" onclick="takeMedicine('${person}', '${timeSlot}', ${index})" ${doseTaken ? 'disabled' : ''}>
                                💊 Take
                            </button>
                            <button class="btn btn-add" onclick="addStock('${person}', '${timeSlot}', ${index})">
                                ➕ Add 30
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMedicineSchedule() {
            // Father's medicine
            document.getElementById('fatherMorningBefore').innerHTML = 
                medicineData.father.morningBefore.map((med, idx) => 
                    renderMedicineItem(med, 'father', 'morningBefore', idx)).join('');
            
            document.getElementById('fatherMorningAfter').innerHTML = 
                medicineData.father.morningAfter.map((med, idx) => 
                    renderMedicineItem(med, 'father', 'morningAfter', idx)).join('');
            
            document.getElementById('father4PM').innerHTML = 
                medicineData.father.afternoon.map((med, idx) => 
                    renderMedicineItem(med, 'father', 'afternoon', idx)).join('');
            
            document.getElementById('fatherNight').innerHTML = 
                medicineData.father.night.map((med, idx) => 
                    renderMedicineItem(med, 'father', 'night', idx)).join('');

            // Mother's medicine
            document.getElementById('motherMorning').innerHTML = 
                medicineData.mother.morning.map((med, idx) => 
                    renderMedicineItem(med, 'mother', 'morning', idx)).join('');
            
            document.getElementById('motherNight').innerHTML = 
                medicineData.mother.night.map((med, idx) => 
                    renderMedicineItem(med, 'mother', 'night', idx)).join('');
        }

        // Stock Alert Functions
        function checkStockAlerts() {
            const alertsDiv = document.getElementById('stockAlerts');
            const warningDiv = document.getElementById('lowStockWarning');
            const warningMessage = document.getElementById('lowStockMessage');
            
            let alerts = [];
            let lowStockCount = 0;

            // Check all medicines for low stock
            Object.keys(medicineData).forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine, index) => {
                        if (medicine.stock <= 5) {
                            lowStockCount++;
                            alerts.push({
                                person: person.charAt(0).toUpperCase() + person.slice(1),
                                medicine: medicine.name,
                                stock: medicine.stock,
                                timeSlot: timeSlot,
                                urgent: medicine.stock <= 2
                            });
                        }
                    });
                });
            });

            // Update warning banner
            if (lowStockCount > 0) {
                warningDiv.style.display = 'block';
                warningMessage.textContent = `${lowStockCount} medicine${lowStockCount > 1 ? 's' : ''} running low!`;
            } else {
                warningDiv.style.display = 'none';
            }

            // Update alerts tab
            if (alerts.length > 0) {
                alertsDiv.innerHTML = alerts.map(alert => `
                    <div class="alert ${alert.urgent ? 'urgent-alert' : ''}">
                        <span class="alert-icon">${alert.urgent ? '🚨' : '⚠️'}</span>
                        <div>
                            <strong>${alert.person}'s ${alert.medicine}</strong><br>
                            Only ${alert.stock} tablet${alert.stock !== 1 ? 's' : ''} left!
                            ${alert.urgent ? '<br><span style="color: #dc3545; font-weight: bold;">URGENT: Restock needed!</span>' : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                alertsDiv.innerHTML = `
                    <div class="alert" style="background: #d4edda; border-color: #c3e6cb; color: #155724;">
                        <span class="alert-icon">✅</span>
                        <div>
                            <strong>All Good!</strong><br>
                            All medicines are well stocked.
                        </div>
                    </div>
                `;
            }
        }

        function checkLowStockAlerts() {
            showTab('alerts');
        }

        // Voice Recognition Functions
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                document.getElementById('voiceStatus').textContent = 'Voice recognition not supported in this browser';
                return;
            }

            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('voiceButton').classList.add('listening');
                document.getElementById('voiceStatus').textContent = 'Listening... Speak now!';
                document.getElementById('voiceTranscript').textContent = 'Listening...';
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = 0; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                document.getElementById('voiceTranscript').textContent = transcript;
                
                if (event.results[event.results.length - 1].isFinal) {
                    processVoiceCommand(transcript.toLowerCase());
                }
            };

            recognition.onerror = (event) => {
                document.getElementById('voiceStatus').textContent = `Error: ${event.error}`;
                stopListening();
            };

            recognition.onend = () => {
                stopListening();
            };
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                initializeVoiceRecognition();
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('voiceButton').classList.remove('listening');
            document.getElementById('voiceStatus').textContent = 'Click microphone to start listening';
        }

        function processVoiceCommand(command) {
            let response = '';
            const responseDiv = document.getElementById('voiceResponse');

            // Medicine taking commands
            if (command.includes('take') || command.includes('took')) {
                if (command.includes('father')) {
                    response = handleMedicineCommand(command, 'father');
                } else if (command.includes('mother')) {
                    response = handleMedicineCommand(command, 'mother');
                } else {
                    response = 'Please specify if this is for father or mother.';
                }
            }
            // Stock checking commands
            else if (command.includes('stock') || command.includes('how many')) {
                response = checkMedicineStock(command);
            }
            // Status commands
            else if (command.includes('status') || command.includes('summary')) {
                response = getMedicineStatus();
            }
            // Low stock alerts
            else if (command.includes('low stock') || command.includes('running low')) {
                response = getLowStockReport();
            }
            // Time-based commands
            else if (command.includes('morning') || command.includes('evening') || command.includes('night')) {
                response = getTimeBasedMedicine(command);
            }
            // General help
            else if (command.includes('help')) {
                response = getHelpMessage();
            }
            else {
                response = `I heard: "${command}". Try commands like "take father's morning medicine" or "check stock status".`;
            }

            responseDiv.textContent = response;
            speak(response);
        }

        function handleMedicineCommand(command, person) {
            if (command.includes('morning') && command.includes('before')) {
                return takeMedicineByTime(person, 'morningBefore', 'before breakfast');
            } else if (command.includes('morning') || command.includes('breakfast')) {
                return takeMedicineByTime(person, 'morningAfter', 'after breakfast');
            } else if (command.includes('afternoon') || command.includes('4') || command.includes('four')) {
                return takeMedicineByTime(person, 'afternoon', 'afternoon');
            } else if (command.includes('night') || command.includes('evening') || command.includes('dinner')) {
                return takeMedicineByTime(person, 'night', 'after dinner');
            } else {
                return `Please specify the time: morning, afternoon, or night for ${person}.`;
            }
        }

        function takeMedicineByTime(person, timeSlot, timeDescription) {
            const medicines = medicineData[person][timeSlot];
            let response = `Taking ${person}'s ${timeDescription} medicines:\n`;
            
            medicines.forEach((medicine, index) => {
                const doseKey = `${person}_${timeSlot}_${index}`;
                if (!dosesTakenToday[doseKey] && medicine.stock > 0) {
                    medicine.stock--;
                    dosesTakenToday[doseKey] = true;
                    response += `✓ ${medicine.name} - ${medicine.stock} left\n`;
                } else if (dosesTakenToday[doseKey]) {
                    response += `⚠ ${medicine.name} already taken today\n`;
                } else {
                    response += `❌ ${medicine.name} - out of stock!\n`;
                }
            });
            
            saveMedicineData();
            saveDosesTakenToday(dosesTakenToday);
            renderMedicineSchedule();
            checkStockAlerts();
            
            return response;
        }

        function checkMedicineStock(command) {
            let response = 'Medicine Stock Report:\n\n';
            
            ['father', 'mother'].forEach(person => {
                response += `${person.charAt(0).toUpperCase() + person.slice(1)}:\n`;
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        response += `• ${medicine.name}: ${medicine.stock} tablets\n`;
                    });
                });
                response += '\n';
            });
            
            return response;
        }

        function getMedicineStatus() {
            let totalMedicines = 0;
            let lowStockCount = 0;
            let takenToday = Object.keys(dosesTakenToday).length;
            
            ['father', 'mother'].forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        totalMedicines++;
                        if (medicine.stock <= 5) lowStockCount++;
                    });
                });
            });
            
            return `Medicine Status: ${takenToday} doses taken today. ${lowStockCount} medicines running low out of ${totalMedicines} total.`;
        }

        function getLowStockReport() {
            let lowStockMeds = [];
            
            ['father', 'mother'].forEach(person => {
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach(medicine => {
                        if (medicine.stock <= 5) {
                            lowStockMeds.push(`${medicine.name}: ${medicine.stock} left`);
                        }
                    });
                });
            });
            
            if (lowStockMeds.length === 0) {
                return 'All medicines are well stocked!';
            } else {
                return `Low stock alert! ${lowStockMeds.join(', ')}`;
            }
        }

        function getTimeBasedMedicine(command) {
            const currentHour = new Date().getHours();
            let timeSlot = '';
            
            if (command.includes('morning') || currentHour < 12) {
                timeSlot = 'morning';
            } else if (command.includes('afternoon') || (currentHour >= 12 && currentHour < 18)) {
                timeSlot = 'afternoon';
            } else {
                timeSlot = 'evening/night';
            }
            
            return `Current time medicines for ${timeSlot}. Use "take father's ${timeSlot} medicine" or "take mother's ${timeSlot} medicine" to record doses.`;
        }

        function getHelpMessage() {
            return `Voice commands available:
            • "Take father's morning medicine"
            • "Take mother's evening medicine"  
            • "Check stock status"
            • "Show low stock medicines"
            • "Medicine summary"
            
            You can also specify times like breakfast, afternoon, or dinner.`;
        }

        function speak(text) {
            if (speechSynthesis) {
                speechSynthesis.cancel(); // Stop any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        }

        // Reminder System
        function setupAutomaticReminders() {
            // Clear existing reminders
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];

            if (Notification.permission !== 'granted') return;

            // Set up reminders for different times
            const reminderTimes = [
                { hour: 8, minute: 0, message: 'Time for Father\'s morning medicine (before breakfast)!' },
                { hour: 10, minute: 0, message: 'Time for morning medicines after breakfast!' },
                { hour: 16, minute: 0, message: 'Time for Father\'s afternoon medicine!' },
                { hour: 22, minute: 0, message: 'Time for evening medicines after dinner!' }
            ];

            reminderTimes.forEach(reminder => {
                const interval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === reminder.hour && now.getMinutes() === reminder.minute) {
                        showCustomNotification('Medicine Reminder', reminder.message, true);
                    }
                }, 60000); // Check every minute
                
                reminderIntervals.push(interval);
            });
        }

        function setupWebReminders() {
            if (Notification.permission === 'granted') {
                setupAutomaticReminders();
                showCustomNotification('Web Reminders Active!', 'You\'ll get automatic reminders at medicine times.');
            } else {
                alert('Please enable notifications first!');
            }
        }

        function downloadCalendar() {
            const events = [];
            const today = new Date();
            
            // Generate 30 days of events
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0].replace(/-/g, '');
                
                events.push(
                    `BEGIN:VEVENT`,
                    `DTSTART:${dateStr}T080000`,
                    `DTEND:${dateStr}T081500`,
                    `SUMMARY:Father's Morning Medicine (Before Breakfast)`,
                    `DESCRIPTION:Maxi PhD`,
                    `END:VEVENT`
                );
                
                events.push(
                    `BEGIN:VEVENT`,
                    `DTSTART:${dateStr}T100000`,
                    `DTEND:${dateStr}T101500`,
                    `SUMMARY:Morning Medicine (After Breakfast)`,
                    `DESCRIPTION:Father: Metolol MF, Pilclop, Cordarone, Orofer XT, Hyqvit\\nMother: Telzox H, Cinod, Zavamet`,
                    `END:VEVENT`
                );
                
                events.push(
                    `BEGIN:VEVENT`,
                    `DTSTART:${dateStr}T160000`,
                    `DTEND:${dateStr}T161500`,
                    `SUMMARY:Father's Afternoon Medicine`,
                    `DESCRIPTION:Acitrom`,
                    `END:VEVENT`
                );
                
                events.push(
                    `BEGIN:VEVENT`,
                    `DTSTART:${dateStr}T220000`,
                    `DTEND:${dateStr}T221500`,
                    `SUMMARY:Evening Medicine (After Dinner)`,
                    `DESCRIPTION:Father: Rotin F, Telmiford\\nMother: Cinod, Zavamet`,
                    `END:VEVENT`
                );
            }
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Medicine Reminder//EN',
                ...events,
                'END:VCALENDAR'
            ].join('\n');
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'medicine-reminders.ics';
            a.click();
            URL.revokeObjectURL(url);
            
            showCustomNotification('Calendar Downloaded!', 'Import the .ics file to your calendar app for reminders.');
        }

        function setupEmailReminders() {
            const subject = 'Medicine Reminder Schedule';
            const body = `
Daily Medicine Schedule:

FATHER:
🌅 8:00 AM (Before Breakfast): Maxi PhD
🍳 10:00 AM (After Breakfast): Metolol MF, Pilclop, Cordarone, Orofer XT, Hyqvit
🕐 4:00 PM: Acitrom
🍽️ 10:00 PM (After Dinner): Rotin F, Telmiford

MOTHER:
🍳 10:00 AM (After Breakfast): Telzox H, Cinod, Zavamet  
🍽️ 10:00 PM (After Dinner): Cinod, Zavamet

Set up recurring reminders in your email or phone for these times!
            `.trim();
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        function resetAllData() {
            if (confirm('Are you sure you want to reset all medicine data and doses taken? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(DOSES_TAKEN_KEY);
                medicineData = JSON.parse(JSON.stringify(defaultMedicineData));
                dosesTakenToday = {};
                renderMedicineSchedule();
                checkStockAlerts();
                showCustomNotification('Data Reset', 'All medicine data has been reset to defaults.');
            }
        }

        // UI Functions
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to corresponding nav tab
            event.target.classList.add('active');
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('currentTime').textContent = `Current Time: ${timeString}`;
            
            // Update next reminder time
            updateNextReminderDisplay();
        }

        function updateNextReminderDisplay() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            const reminderTimes = [
                { hour: 8, minute: 0, label: 'Father\'s morning medicine (8:00 AM)' },
                { hour: 10, minute: 0, label: 'Morning medicines (10:00 AM)' },
                { hour: 16, minute: 0, label: 'Father\'s afternoon medicine (4:00 PM)' },
                { hour: 22, minute: 0, label: 'Evening medicines (10:00 PM)' }
            ];
            
            let nextReminder = null;
            
            for (let reminder of reminderTimes) {
                if (currentHour < reminder.hour || (currentHour === reminder.hour && currentMinute < reminder.minute)) {
                    nextReminder = reminder;
                    break;
                }
            }
            
            // If no reminder today, show tomorrow's first reminder
            if (!nextReminder) {
                nextReminder = { ...reminderTimes[0], label: reminderTimes[0].label + ' (tomorrow)' };
            }
            
            const nextTime = `${nextReminder.hour.toString().padStart(2, '0')}:${nextReminder.minute.toString().padStart(2, '0')}`;
            document.getElementById('nextReminderTime').textContent = `${nextReminder.label}`;
        }

        // Initialize the application
        function initializeApp() {
            // Check browser support
            const support = checkBrowserSupport();
            
            // Update notification status
            updateNotificationStatus();
            
            // Initialize voice recognition
            if (support.speechRecognition) {
                initializeVoiceRecognition();
            } else {
                document.getElementById('voiceStatus').textContent = 'Voice recognition not supported';
                document.getElementById('voiceButton').disabled = true;
                }
            
            // Render initial medicine schedule
            renderMedicineSchedule();
            
            // Check for stock alerts
            checkStockAlerts();
            
            // Set up automatic time updates
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime();
            
            // Set up automatic reminders if notifications are enabled
            if (Notification.permission === 'granted') {
                setupAutomaticReminders();
            }
            
            // Show first tab by default
            showTab('schedule');
            
            console.log('Medicine Tracker App initialized successfully');
        }

        // Global variables for reminders
        let reminderIntervals = [];
        let deferredPrompt;

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle offline functionality
        window.addEventListener('online', () => {
            showCustomNotification('Connection Restored', 'You are back online!');
        });

        window.addEventListener('offline', () => {
            showCustomNotification('Offline Mode', 'App is working offline. Data will sync when connection is restored.');
        });

        // Auto-save data periodically
        setInterval(() => {
            saveMedicineData();
            saveDosesTakenToday(dosesTakenToday);
        }, 30000); // Save every 30 seconds

        // Handle page visibility changes for better battery management
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, reduce activity
                stopSpeaking();
                if (isListening) {
                    recognition.stop();
                }
            } else {
                // Page is visible again
                updateCurrentTime();
                checkStockAlerts();
            }
        });

        // Export data function for backup
        function exportData() {
            const exportData = {
                medicineData: medicineData,
                dosesTaken: loadAllDosesTaken(),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `medicine-data-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showCustomNotification('Data Exported', 'Your medicine data has been downloaded as a backup file.');
        }

        // Import data function
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.medicineData && importedData.version) {
                        if (confirm('This will replace your current medicine data. Are you sure?')) {
                            medicineData = importedData.medicineData;
                            
                            // Import historical doses if available
                            if (importedData.dosesTaken) {
                                Object.keys(importedData.dosesTaken).forEach(date => {
                                    const saved = localStorage.getItem(DOSES_TAKEN_KEY);
                                    const allDoses = saved ? JSON.parse(saved) : {};
                                    allDoses[date] = importedData.dosesTaken[date];
                                    localStorage.setItem(DOSES_TAKEN_KEY, JSON.stringify(allDoses));
                                });
                            }
                            
                            saveMedicineData();
                            renderMedicineSchedule();
                            checkStockAlerts();
                            
                            showCustomNotification('Data Imported', 'Your medicine data has been successfully imported.');
                        }
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Function to load all historical doses taken
        function loadAllDosesTaken() {
            try {
                const saved = localStorage.getItem(DOSES_TAKEN_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('Error loading historical doses:', e);
                return {};
            }
        }

        // Generate weekly report
        function generateWeeklyReport() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const allDoses = loadAllDosesTaken();
            
            let report = 'Weekly Medicine Report\n';
            report += `From ${weekAgo.toLocaleDateString()} to ${today.toLocaleDateString()}\n\n`;
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekAgo.getTime() + i * 24 * 60 * 60 * 1000);
                weekDates.push(date.toISOString().split('T')[0]);
            }
            
            ['father', 'mother'].forEach(person => {
                report += `${person.toUpperCase()}:\n`;
                let totalDoses = 0;
                let takenDoses = 0;
                
                Object.keys(medicineData[person]).forEach(timeSlot => {
                    medicineData[person][timeSlot].forEach((medicine, index) => {
                        weekDates.forEach(date => {
                            totalDoses++;
                            const doseKey = `${person}_${timeSlot}_${index}`;
                            if (allDoses[date] && allDoses[date][doseKey]) {
                                takenDoses++;
                            }
                        });
                    });
                });
                
                const adherenceRate = totalDoses > 0 ? ((takenDoses / totalDoses) * 100).toFixed(1) : '0';
                report += `Adherence Rate: ${adherenceRate}% (${takenDoses}/${totalDoses} doses)\n\n`;
            });
            
            // Create and download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medicine-weekly-report-${today.toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showCustomNotification('Weekly Report Generated', 'Your weekly medicine adherence report has been downloaded.');
        }

        // Advanced voice commands for power users
        function processAdvancedVoiceCommand(command) {
            if (command.includes('weekly report') || command.includes('adherence report')) {
                generateWeeklyReport();
                return 'Generating weekly adherence report...';
            } else if (command.includes('export data') || command.includes('backup data')) {
                exportData();
                return 'Exporting medicine data for backup...';
            } else if (command.includes('reset today') || command.includes('clear today')) {
                if (confirm('Reset all doses taken today?')) {
                    dosesTakenToday = {};
                    saveDosesTakenToday(dosesTakenToday);
                    renderMedicineSchedule();
                    return 'All doses for today have been reset.';
                }
                return 'Reset cancelled.';
            }
            
            return null; // Command not recognized as advanced
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            // Ctrl/Cmd + M for microphone
            if ((event.ctrlKey || event.metaKey) && event.key === 'm') {
                event.preventDefault();
                toggleVoiceRecognition();
            }
            
            // Escape to stop speaking/listening
            if (event.key === 'Escape') {
                stopSpeaking();
                if (isListening) {
                    recognition.stop();
                }
            }
            
            // Ctrl/Cmd + S to stop speaking
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                stopSpeaking();
            }
        });

        // Touch gestures for mobile
        let touchStartY = 0;
        let touchEndY = 0;

        document.addEventListener('touchstart', (event) => {
            touchStartY = event.changedTouches[0].screenY;
        });

        document.addEventListener('touchend', (event) => {
            touchEndY = event.changedTouches[0].screenY;
            handleSwipeGesture();
        });

        function handleSwipeGesture() {
            const swipeThreshold = 100;
            const swipeDistance = touchStartY - touchEndY;
            
            if (Math.abs(swipeDistance) > swipeThreshold) {
                if (swipeDistance > 0) {
                    // Swipe up - could trigger quick actions
                    console.log('Swipe up detected');
                } else {
                    // Swipe down - could refresh or show status
                    console.log('Swipe down detected');
                    updateCurrentTime();
                    checkStockAlerts();
                }
            }
        }

        // Error handling and recovery
        window.addEventListener('error', (event) => {
            console.error('Application error:', event.error);
            showCustomNotification('Error Detected', 'An error occurred. The app will attempt to recover automatically.');
            
            // Attempt to recover by reinitializing critical components
            setTimeout(() => {
                try {
                    renderMedicineSchedule();
                    checkStockAlerts();
                    updateCurrentTime();
                } catch (e) {
                    console.error('Recovery failed:', e);
                }
            }, 1000);
        });

        // Performance monitoring
        let performanceMetrics = {
            startTime: Date.now(),
            renderCount: 0,
            voiceCommands: 0
        };

        function trackPerformance(action) {
            switch (action) {
                case 'render':
                    performanceMetrics.renderCount++;
                    break;
                case 'voice':
                    performanceMetrics.voiceCommands++;
                    break;
            }
        }

        // Debug mode toggle (for development)
        let debugMode = false;
        function toggleDebugMode() {
            debugMode = !debugMode;
            console.log('Debug mode:', debugMode ? 'ON' : 'OFF');
            
            if (debugMode) {
                console.log('Performance metrics:', performanceMetrics);
                console.log('Current medicine data:', medicineData);
                console.log('Doses taken today:', dosesTakenToday);
            }
        }

        // Final app ready notification
        setTimeout(() => {
            if (Notification.permission === 'granted') {
                showCustomNotification('Medicine Tracker Ready!', 'Your personal medicine assistant is now active.');
            }
        }, 2000);
    
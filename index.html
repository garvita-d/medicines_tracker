<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Reminder System</title>
    <meta name="theme-color" content="#4F46E5">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVkaWNpbmUgUmVtaW5kZXIgU3lzdGVtIiwic2hvcnRfbmFtZSI6Ik1lZFJlbWluZGVyIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkZGRkYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2QwZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJelEyTmpreVJTSStQR05wY21Oc1pTQmplRDBpTVRJaUlHTjVQU0l4TWlJZ2NqMGlOU0lnWm1sc2JEMGlJekZHUXpjelFTSXZQand2YzNablBnPT0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .data-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .person-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .person-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .time-slot {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .time-slot h3 {
            color: #4F46E5;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medicine-item {
            background: linear-gradient(45deg, #f8f9ff, #e8eeff);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4F46E5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medicine-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
        }

        .medicine-item.low-stock {
            border-left-color: #EF4444;
            background: linear-gradient(45deg, #fff5f5, #fee2e2);
            animation: pulse 2s infinite;
        }

        .medicine-item.taken-today {
            border-left-color: #10B981;
            background: linear-gradient(45deg, #f0fdf4, #dcfce7);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medicine-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1F2937;
        }

        .stock-count {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .stock-count.low {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            animation: shake 0.5s ease-in-out;
        }

        .stock-count.taken {
            background: linear-gradient(45deg, #10B981, #059669);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .medicine-details {
            color: #6B7280;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .last-taken {
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-take {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-take:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-take:disabled {
            background: linear-gradient(45deg, #9CA3AF, #6B7280);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-calendar {
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border-radius: 50%;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .voice-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .voice-assistant.listening {
            animation: pulse-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .reset-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(45deg, #EF4444, #DC2626);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .voice-output {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .install-prompt {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: white;
            color: #FF6B6B;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #EF4444, #DC2626);
        }

        .storage-status {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .storage-status.enabled {
            background: rgba(16, 185, 129, 0.2);
        }

        .storage-status.disabled {
            background: rgba(239, 68, 68, 0.2);
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .medicine-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .action-buttons { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <h3>Add to Home Screen</h3>
            <p>Install this app on your phone for easy access!</p>
            <button class="install-btn" onclick="showInstallInstructions()">Show Instructions</button>
            <button class="install-btn" onclick="hideInstallPrompt()">Later</button>
        </div>

        <div class="header">
            <h1>Medicine Reminder System</h1>
            <p>Never miss your medication again!</p>
            <div class="data-info" id="dataInfo">
                Data persists across sessions â€¢ Last updated: <span id="lastUpdate">Never</span>
            </div>
            <div class="storage-status" id="storageStatus">
                <span id="storageIcon">ðŸ’¾</span>
                <span id="storageText">Checking storage...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('father')">Father</button>
            <button class="tab" onclick="switchTab('mother')">Mother</button>
            <button class="tab" onclick="switchTab('chat')">Voice Assistant</button>
        </div>

        <div id="father" class="person-section active">
            <!-- Father's medicines will be populated by JavaScript -->
        </div>

        <div id="mother" class="person-section">
            <!-- Mother's medicines will be populated by JavaScript -->
        </div>

        <div id="chat" class="person-section">
            <div class="time-slot">
                <h3>Voice Assistant</h3>
                <p>Click the voice button to interact with your medicine assistant. You can:</p>
                <ul style="margin: 20px 0; color: #6B7280; line-height: 1.6;">
                    <li>Check medicine stock levels</li>
                    <li>Ask about dosage information</li>
                    <li>Get reminders for specific medicines</li>
                    <li>Inquire about medicine interactions</li>
                    <li>Get general medical advice</li>
                </ul>
                <div style="background: linear-gradient(45deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px;">Example Commands:</h4>
                    <p style="color: #6B7280; font-style: italic;">
                        "Check father's medicine stock"<br>
                        "What is Metolol used for?"<br>
                        "Remind me about evening medicines"<br>
                        "How many Acitrom tablets are left?"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <button class="voice-assistant" onclick="toggleVoiceAssistant()" id="voiceBtn">ðŸŽ¤</button>
    <button class="reset-btn" onclick="resetAllStock()">Reset Stock</button>

    <div class="voice-output" id="voiceOutput">
        <h3>ðŸŽ¤ Voice Assistant</h3>
        <p id="voiceText">Listening...</p>
        <button onclick="closeVoiceOutput()" style="background: #4F46E5; color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-top: 15px; cursor: pointer;">Close</button>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Persistent storage key
        const STORAGE_KEY = 'medicine_tracker_data';
        const STORAGE_VERSION = '2.0';
        
        // Check localStorage availability
        let storageAvailable = false;
        
        function checkStorageAvailability() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, 'test');
                localStorage.removeItem(test);
                storageAvailable = true;
                return true;
            } catch(e) {
                storageAvailable = false;
                console.warn('localStorage is not available. Data will not persist across sessions.');
                return false;
            }
        }

        function updateStorageStatus() {
            const statusElement = document.getElementById('storageStatus');
            const iconElement = document.getElementById('storageIcon');
            const textElement = document.getElementById('storageText');
            
            if (storageAvailable) {
                statusElement.className = 'storage-status enabled';
                iconElement.textContent = 'âœ…';
                textElement.textContent = 'Persistent storage enabled';
            } else {
                statusElement.className = 'storage-status disabled';
                iconElement.textContent = 'âš ï¸';
                textElement.textContent = 'Persistent storage unavailable - data will reset on refresh';
            }
        }
        
        // Original medicine data structure
        const originalMedicineData = {
            father: {
                morning: [
                    { name: "Maxi PhD", dose: "30 tablets", timing: "Before breakfast", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterBreakfast: [
                    { name: "Metolol MF", dose: "60mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Pilclop", dose: "75mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cordarone", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Orofer XT", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Hyqvit", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afternoon: [
                    { name: "Acitrom", dose: "1mg/2mg alternate days", timing: "4pm", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Rotin F", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Telmiford", dose: "40mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null }
                ]
            },
            mother: {
                afterBreakfast: [
                    { name: "Telzox H", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ]
            }
        };

        // Current medicine data (will be loaded from storage or default to original)
        let medicineData = {};

        // Enhanced persistent storage functions
        function saveToStorage(data) {
            try {
                if (!storageAvailable) {
                    // Fallback to memory storage
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    return true;
                }
                
                const jsonData = JSON.stringify({
                    ...data,
                    lastUpdated: new Date().toISOString(),
                    version: STORAGE_VERSION
                });
                
                localStorage.setItem(STORAGE_KEY, jsonData);
                
                // Update UI to show last saved time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                
                // Show user-friendly error
                showNotification('âš ï¸ Unable to save data. Changes may be lost on refresh.', 'error');
                
                // Try fallback to memory
                try {
                    window.persistentMedicineData = JSON.stringify({
                        ...data,
                        lastUpdated: new Date().toISOString(),
                        version: STORAGE_VERSION
                    });
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback storage also failed:', fallbackError);
                    return false;
                }
            }
        }

        function loadFromStorage() {
            try {
                let data = null;
                
                if (storageAvailable) {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        data = JSON.parse(stored);
                    }
                } else {
                    // Fallback to memory storage
                    if (window.persistentMedicineData) {
                        data = JSON.parse(window.persistentMedicineData);
                    }
                }
                
                if (data) {
                    // Check version compatibility
                    if (data.version !== STORAGE_VERSION) {
                        console.warn('Data version mismatch. Migrating data...');
                        // Could add migration logic here if needed
                    }
                    
                    // Update last updated time
                    if (data.lastUpdated) {
                        document.getElementById('lastUpdate').textContent = new Date(data.lastUpdated).toLocaleString();
                    }
                    
                    // Remove metadata and return actual data
                    delete data.lastUpdated;
                    delete data.version;
                    
                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('âš ï¸ Error loading saved data. Using default values.', 'error');
                return null;
            }
        }

        // Data validation function
        function validateMedicineData(data) {
            try {
                // Basic structure validation
                if (!data || typeof data !== 'object') return false;
                if (!data.father || !data.mother) return false;
                
                // Validate each person's data structure
                for (const person of ['father', 'mother']) {
                    const personData = data[person];
                    if (!personData || typeof personData !== 'object') return false;
                    
                    // Check that each time slot is an array
                    for (const slot in personData) {
                        if (!Array.isArray(personData[slot])) return false;
                        
                        // Validate each medicine object
                        for (const medicine of personData[slot]) {
                            if (!medicine.name || typeof medicine.stock !== 'number') return false;
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Data validation error:', error);
                return false;
            }
        }

        // Initialize data on app start
        function initializeData() {
            const savedData = loadFromStorage();
            
            if (savedData && validateMedicineData(savedData)) {
                // Use saved data
                medicineData = savedData;
                showNotification('ðŸ’¾ Previous data loaded successfully!');
                
                // Count total medicines tracked
                let totalMedicines = 0;
                Object.values(medicineData.father).flat().forEach(() => totalMedicines++);
                Object.values(medicineData.mother).flat().forEach(() => totalMedicines++);
                
                console.log(`Loaded data for ${totalMedicines} medicines`);
            } else {
                // Use original data for first time or if saved data is corrupted
                medicineData = JSON.parse(JSON.stringify(originalMedicineData));
                saveToStorage(medicineData);
                showNotification('ðŸŽ‰ Welcome to AI-powered medicine tracking!');
                console.log('Initialized with original data');
            }
        }

        // Save data after any changes
        function saveData() {
            if (validateMedicineData(medicineData)) {
                return saveToStorage(medicineData);
            } else {
                console.error('Invalid data structure, not saving');
                showNotification('âš ï¸ Data validation failed. Changes not saved.', 'error');
                return false;
            }
        }

        // Auto-save with error handling
        function autoSave() {
            try {
                if (saveData()) {
                    console.log('Auto-save successful');
                } else {
                    console.warn('Auto-save failed');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Check if medicine was taken today
        function wasTakenToday(lastTaken) {
            if (!lastTaken) return false;
            const today = new Date().toDateString();
            const takenDate = new Date(lastTaken).toDateString();
            return today === takenDate;
        }

        // Initialize the app
        function initApp() {
            // Check storage availability first
            checkStorageAvailability();
            updateStorageStatus();
            
            initializeData();
            renderFatherMedicines();
            renderMotherMedicines();
            
            // Show install prompt on mobile
            if (isMobile() && !isAppInstalled()) {
                setTimeout(() => {
                    document.getElementById('installPrompt').style.display = 'block';
                }, 2000);
            }
            
            // Warn user if storage is not available
            if (!storageAvailable) {
                setTimeout(() => {
                    showNotification('âš ï¸ Browser storage unavailable. Data will reset on page refresh.', 'error');
                }, 1000);
            }
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches;
        }

        function switchTab(tab) {
            // Remove active class from all tabs and sections
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.person-section').forEach(s => s.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding section
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function renderFatherMedicines() {
            const fatherSection = document.getElementById('father');
            fatherSection.innerHTML = '';

            const timeSlots = [
                { key: 'morning', title: 'ðŸŒ… Morning (Before Breakfast)', icon: 'ðŸŒ…' },
                { key: 'afterBreakfast', title: 'ðŸ¥ž After Breakfast', icon: 'ðŸ¥ž' },
                { key: 'afternoon', title: 'â˜€ï¸ Afternoon (4 PM)', icon: 'â˜€ï¸' },
                { key: 'afterDinner', title: 'ðŸŒ™ After Dinner', icon: 'ðŸŒ™' }
            ];

            timeSlots.forEach(slot => {
                if (medicineData.father[slot.key] && medicineData.father[slot.key].length > 0) {
                const timeSlotDiv = document.createElement('div');
                timeSlotDiv.className = 'time-slot';
                
                const header = document.createElement('h3');
                header.innerHTML = `${slot.icon} ${slot.title}`;
                timeSlotDiv.appendChild(header);

                medicineData.father[slot.key].forEach((medicine, index) => {
                    const medicineDiv = document.createElement('div');
                    medicineDiv.className = 'medicine-item';
                    
                    // Add classes for styling based on stock and taken status
                    if (medicine.stock <= 5) {
                        medicineDiv.classList.add('low-stock');
                    }
                    if (wasTakenToday(medicine.lastTaken)) {
                        medicineDiv.classList.add('taken-today');
                    }

                    const takenToday = wasTakenToday(medicine.lastTaken);
                    const stockClass = medicine.stock <= 5 ? 'low' : (takenToday ? 'taken' : '');
                    
                    medicineDiv.innerHTML = `
                        <div class="medicine-header">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="stock-count ${stockClass}">
                                ${medicine.stock} left
                            </div>
                        </div>
                        <div class="medicine-details">
                            <strong>Dose:</strong> ${medicine.dose}<br>
                            ${medicine.timing ? `<strong>Timing:</strong> ${medicine.timing}<br>` : ''}
                        </div>
                        ${takenToday ? 
                            `<div class="last-taken">âœ… Taken today at ${new Date(medicine.lastTaken).toLocaleTimeString()}</div>` : 
                            ''
                        }
                        <div class="action-buttons">
                            <button class="btn btn-take ${takenToday ? 'disabled' : ''}" 
                                    ${takenToday ? 'disabled' : ''} 
                                    onclick="takeMedicine('father', '${slot.key}', ${index})">
                                ${takenToday ? 'âœ… Taken Today' : 'ðŸ’Š Take Medicine'}
                            </button>
                            <button class="btn btn-calendar" onclick="viewCalendar('father', '${medicine.name}')">
                                ðŸ“… History
                            </button>
                        </div>
                    `;
                    
                    timeSlotDiv.appendChild(medicineDiv);
                });

                fatherSection.appendChild(timeSlotDiv);
            }
        });
    }

    function renderMotherMedicines() {
        const motherSection = document.getElementById('mother');
        motherSection.innerHTML = '';

        const timeSlots = [
            { key: 'afterBreakfast', title: 'ðŸ¥ž After Breakfast', icon: 'ðŸ¥ž' },
            { key: 'afterDinner', title: 'ðŸŒ™ After Dinner', icon: 'ðŸŒ™' }
        ];

        timeSlots.forEach(slot => {
            if (medicineData.mother[slot.key] && medicineData.mother[slot.key].length > 0) {
                const timeSlotDiv = document.createElement('div');
                timeSlotDiv.className = 'time-slot';
                
                const header = document.createElement('h3');
                header.innerHTML = `${slot.icon} ${slot.title}`;
                timeSlotDiv.appendChild(header);

                medicineData.mother[slot.key].forEach((medicine, index) => {
                    const medicineDiv = document.createElement('div');
                    medicineDiv.className = 'medicine-item';
                    
                    // Add classes for styling based on stock and taken status
                    if (medicine.stock <= 10) { // Higher threshold for mother's medicines as they're taken twice daily
                        medicineDiv.classList.add('low-stock');
                    }
                    if (wasTakenToday(medicine.lastTaken)) {
                        medicineDiv.classList.add('taken-today');
                    }

                    const takenToday = wasTakenToday(medicine.lastTaken);
                    const stockClass = medicine.stock <= 10 ? 'low' : (takenToday ? 'taken' : '');
                    
                    medicineDiv.innerHTML = `
                        <div class="medicine-header">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="stock-count ${stockClass}">
                                ${medicine.stock} left
                            </div>
                        </div>
                        <div class="medicine-details">
                            <strong>Dose:</strong> ${medicine.dose}<br>
                            ${medicine.timing ? `<strong>Timing:</strong> ${medicine.timing}<br>` : ''}
                        </div>
                        ${takenToday ? 
                            `<div class="last-taken">âœ… Taken today at ${new Date(medicine.lastTaken).toLocaleTimeString()}</div>` : 
                            ''
                        }
                        <div class="action-buttons">
                            <button class="btn btn-take ${takenToday ? 'disabled' : ''}" 
                                    ${takenToday ? 'disabled' : ''} 
                                    onclick="takeMedicine('mother', '${slot.key}', ${index})">
                                ${takenToday ? 'âœ… Taken Today' : 'ðŸ’Š Take Medicine'}
                            </button>
                            <button class="btn btn-calendar" onclick="viewCalendar('mother', '${medicine.name}')">
                                ðŸ“… History
                            </button>
                        </div>
                    `;
                    
                    timeSlotDiv.appendChild(medicineDiv);
                });

                motherSection.appendChild(timeSlotDiv);
            }
        });
    }

    function takeMedicine(person, timeSlot, medicineIndex) {
        const medicine = medicineData[person][timeSlot][medicineIndex];
        
        // Check if already taken today
        if (wasTakenToday(medicine.lastTaken)) {
            showNotification('ðŸ’Š This medicine was already taken today!', 'error');
            return;
        }
        
        // Check stock
        if (medicine.stock <= 0) {
            showNotification('âŒ Out of stock! Please refill this medicine.', 'error');
            return;
        }
        
        // Update medicine data
        medicine.stock--;
        medicine.lastTaken = new Date().toISOString();
        
        // Save data
        autoSave();
        
        // Re-render the appropriate section
        if (person === 'father') {
            renderFatherMedicines();
        } else {
            renderMotherMedicines();
        }
        
        // Show success notification
        showNotification(`âœ… ${medicine.name} taken successfully! ${medicine.stock} tablets remaining.`);
        
        // Check for low stock warning
        const threshold = person === 'mother' ? 10 : 5;
        if (medicine.stock <= threshold) {
            setTimeout(() => {
                showNotification(`âš ï¸ Low stock alert: Only ${medicine.stock} ${medicine.name} tablets left!`, 'error');
            }, 2000);
        }
    }

    function viewCalendar(person, medicineName) {
        // This could be expanded to show a full calendar view
        showNotification(`ðŸ“… Calendar view for ${medicineName} - Feature coming soon!`);
    }

    function resetAllStock() {
        if (confirm('Are you sure you want to reset all medicine stock to original levels? This action cannot be undone.')) {
            // Reset to original stock levels
            medicineData = JSON.parse(JSON.stringify(originalMedicineData));
            
            // Save the reset data
            autoSave();
            
            // Re-render both sections
            renderFatherMedicines();
            renderMotherMedicines();
            
            showNotification('ðŸ”„ All medicine stock has been reset to original levels!');
        }
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type === 'error' ? 'error' : ''}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }

    // Voice Assistant Functions
    let isListening = false;
    let recognition;

    function initializeVoiceRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('voiceOutput').style.display = 'block';
                document.getElementById('voiceText').textContent = 'Listening... Speak now!';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.toLowerCase();
                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                document.getElementById('voiceText').textContent = `Error: ${event.error}. Please try again.`;
                stopListening();
            };

            recognition.onend = function() {
                stopListening();
            };
        } else {
            console.warn('Speech recognition not supported in this browser');
        }
    }

    function toggleVoiceAssistant() {
        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    }

    function startListening() {
        if (recognition) {
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                showNotification('âŒ Voice recognition failed to start', 'error');
            }
        } else {
            showNotification('âŒ Voice recognition not supported in this browser', 'error');
        }
    }

    function stopListening() {
        isListening = false;
        document.getElementById('voiceBtn').classList.remove('listening');
        if (recognition) {
            recognition.stop();
        }
    }

    function processVoiceCommand(command) {
        let response = "I didn't understand that command. Please try again.";
        
        // Stock checking commands
        if (command.includes('stock') || command.includes('how many')) {
            response = getStockInfo(command);
        }
        // Medicine information commands
        else if (command.includes('what is') || command.includes('tell me about')) {
            response = getMedicineInfo(command);
        }
        // Taking medicine commands
        else if (command.includes('take') || command.includes('taken')) {
            response = handleTakeMedicineCommand(command);
        }
        // General help
        else if (command.includes('help')) {
            response = "I can help you check medicine stock, provide medicine information, and track when medicines are taken. Try saying 'check father's medicine stock' or 'what is Metolol used for?'";
        }
        
        document.getElementById('voiceText').textContent = response;
        
        // Use text-to-speech if available
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(response);
            speechSynthesis.speak(utterance);
        }
    }

    function getStockInfo(command) {
        let response = "";
        let lowStockMedicines = [];
        
        if (command.includes('father')) {
            Object.values(medicineData.father).flat().forEach(medicine => {
                if (medicine.stock <= 5) {
                    lowStockMedicines.push(`${medicine.name}: ${medicine.stock} left`);
                }
            });
            response = lowStockMedicines.length > 0 ? 
                `Father's low stock medicines: ${lowStockMedicines.join(', ')}` :
                "Father's medicines are well stocked.";
        } else if (command.includes('mother')) {
            Object.values(medicineData.mother).flat().forEach(medicine => {
                if (medicine.stock <= 10) {
                    lowStockMedicines.push(`${medicine.name}: ${medicine.stock} left`);
                }
            });
            response = lowStockMedicines.length > 0 ? 
                `Mother's low stock medicines: ${lowStockMedicines.join(', ')}` :
                "Mother's medicines are well stocked.";
        } else {
            // General stock check
            Object.values(medicineData.father).flat().forEach(medicine => {
                if (medicine.stock <= 5) lowStockMedicines.push(`Father's ${medicine.name}: ${medicine.stock} left`);
            });
            Object.values(medicineData.mother).flat().forEach(medicine => {
                if (medicine.stock <= 10) lowStockMedicines.push(`Mother's ${medicine.name}: ${medicine.stock} left`);
            });
            
            response = lowStockMedicines.length > 0 ? 
                `Low stock medicines: ${lowStockMedicines.join(', ')}` :
                "All medicines are well stocked.";
        }
        
        return response;
    }

    function getMedicineInfo(command) {
        const medicineInfo = {
            'metolol': 'Metolol MF is a beta-blocker used to treat high blood pressure and heart conditions.',
            'pilclop': 'Pilclop contains clopidogrel, used to prevent blood clots.',
            'cordarone': 'Cordarone contains amiodarone, used to treat irregular heartbeats.',
            'acitrom': 'Acitrom is an anticoagulant used to prevent blood clots.',
            'telzox': 'Telzox H is used to treat high blood pressure.',
            'cinod': 'Cinod is used to manage diabetes.',
            'zavamet': 'Zavamet is used to control blood sugar in diabetes.'
        };
        
        for (const [med, info] of Object.entries(medicineInfo)) {
            if (command.includes(med)) {
                return info;
            }
        }
        
        return "I don't have specific information about that medicine. Please consult with a healthcare provider.";
    }

    function handleTakeMedicineCommand(command) {
        return "Please use the app interface to mark medicines as taken for accurate tracking.";
    }

    function closeVoiceOutput() {
        document.getElementById('voiceOutput').style.display = 'none';
        stopListening();
    }

    // Install prompt functions
    function showInstallInstructions() {
        const instructions = isMobile() ? 
            "On mobile: Tap the menu button in your browser and select 'Add to Home Screen' or 'Install App'" :
            "On desktop: Look for the install icon in your browser's address bar or use the browser menu";
        
        alert(instructions);
        hideInstallPrompt();
    }

    function hideInstallPrompt() {
        document.getElementById('installPrompt').style.display = 'none';
    }

    // Initialize the application when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        initializeVoiceRecognition();
    });

    // Cleanup function for when page is about to unload
    window.addEventListener('beforeunload', function() {
        autoSave();
    });

    // Auto-save every 5 minutes as backup
    setInterval(autoSave, 5 * 60 * 1000);
    </script>
</body>
</html>
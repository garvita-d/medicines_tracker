<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Reminder System</title>
    <meta name="theme-color" content="#4F46E5">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWVkaWNpbmUgUmVtaW5kZXIgU3lzdGVtIiwic2hvcnRfbmFtZSI6Ik1lZFJlbWluZGVyIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkZGRkYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2QwZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJelEyTmpreVJTSStQR05wY21Oc1pTQmplRDBpTVRJaUlHTjVQU0l4TWlJZ2NqMGlOU0lnWm1sc2JEMGlJekZHUXpjelFTSXZQand2YzNablBnPT0iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .data-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .person-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .person-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .time-slot {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .time-slot h3 {
            color: #4F46E5;
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medicine-item {
            background: linear-gradient(45deg, #f8f9ff, #e8eeff);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4F46E5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .medicine-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
        }

        .medicine-item.low-stock {
            border-left-color: #EF4444;
            background: linear-gradient(45deg, #fff5f5, #fee2e2);
            animation: pulse 2s infinite;
        }

        .medicine-item.taken-today {
            border-left-color: #10B981;
            background: linear-gradient(45deg, #f0fdf4, #dcfce7);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medicine-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1F2937;
        }

        .stock-count {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .stock-count.low {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            animation: shake 0.5s ease-in-out;
        }

        .stock-count.taken {
            background: linear-gradient(45deg, #10B981, #059669);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .medicine-details {
            color: #6B7280;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .last-taken {
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-take {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-take:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-take:disabled {
            background: linear-gradient(45deg, #9CA3AF, #6B7280);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-calendar {
            background: linear-gradient(45deg, #8B5CF6, #7C3AED);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-calendar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .voice-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border-radius: 50%;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }

        .voice-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .voice-assistant.listening {
            animation: pulse-voice 1s infinite;
        }

        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .reset-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(45deg, #EF4444, #DC2626);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .voice-output {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .install-prompt {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: white;
            color: #FF6B6B;
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #EF4444, #DC2626);
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .medicine-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .action-buttons { flex-direction: column; }
            .tabs { flex-direction: column; }
            .tab { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <h3>Add to Home Screen</h3>
            <p>Install this app on your phone for easy access!</p>
            <button class="install-btn" onclick="showInstallInstructions()">Show Instructions</button>
            <button class="install-btn" onclick="hideInstallPrompt()">Later</button>
        </div>

        <div class="header">
            <h1>Medicine Reminder System</h1>
            <p>Never miss your medication again!</p>
            <div class="data-info" id="dataInfo">
                Data persists across sessions • Last updated: <span id="lastUpdate">Never</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('father')">Father</button>
            <button class="tab" onclick="switchTab('mother')">Mother</button>
            <button class="tab" onclick="switchTab('chat')">Voice Assistant</button>
        </div>

        <div id="father" class="person-section active">
            <!-- Father's medicines will be populated by JavaScript -->
        </div>

        <div id="mother" class="person-section">
            <!-- Mother's medicines will be populated by JavaScript -->
        </div>

        <div id="chat" class="person-section">
            <div class="time-slot">
                <h3>Voice Assistant</h3>
                <p>Click the voice button to interact with your medicine assistant. You can:</p>
                <ul style="margin: 20px 0; color: #6B7280; line-height: 1.6;">
                    <li>Check medicine stock levels</li>
                    <li>Ask about dosage information</li>
                    <li>Get reminders for specific medicines</li>
                    <li>Inquire about medicine interactions</li>
                    <li>Get general medical advice</li>
                </ul>
                <div style="background: linear-gradient(45deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px;">Example Commands:</h4>
                    <p style="color: #6B7280; font-style: italic;">
                        "Check father's medicine stock"<br>
                        "What is Metolol used for?"<br>
                        "Remind me about evening medicines"<br>
                        "How many Acitrom tablets are left?"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <button class="voice-assistant" onclick="toggleVoiceAssistant()" id="voiceBtn">MIC</button>
    <button class="reset-btn" onclick="resetAllStock()">Reset Stock</button>

    <div class="voice-output" id="voiceOutput">
        <h3>Voice Assistant</h3>
        <p id="voiceText">Listening...</p>
        <button onclick="closeVoiceOutput()" style="background: #4F46E5; color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-top: 15px; cursor: pointer;">Close</button>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Persistent storage key
        const STORAGE_KEY = 'medicine_tracker_data';
        
        // Original medicine data structure
        const originalMedicineData = {
            father: {
                morning: [
                    { name: "Maxi PhD", dose: "30 days", timing: "Before breakfast", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterBreakfast: [
                    { name: "Metolol MF", dose: "60mg", timing: "30 days", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Pilclop", dose: "75mg", timing: "30 days", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cordarone", dose: "30 days", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Orofer XT", dose: "30 days", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Hyqvit", dose: "30 days", timing: "", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afternoon: [
                    { name: "Acitrom", dose: "1mg/2mg alternate days", timing: "4pm", stock: 30, originalStock: 30, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Rotin F", dose: "30 tablets", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Telmiford", dose: "40mg", timing: "30 tablets", stock: 30, originalStock: 30, lastTaken: null }
                ]
            },
            mother: {
                afterBreakfast: [
                    { name: "Telzox H", dose: "30 days", timing: "", stock: 30, originalStock: 30, lastTaken: null },
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ],
                afterDinner: [
                    { name: "Cinod", dose: "10mg", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null },
                    { name: "Zavamet", dose: "50/500", timing: "After breakfast and dinner", stock: 60, originalStock: 60, lastTaken: null }
                ]
            }
        };

        // Current medicine data (will be loaded from storage or default to original)
        let medicineData = {};

        // Persistent storage functions using memory simulation
        function saveToStorage(data) {
            try {
                // Create a JSON string that simulates persistent storage
                const jsonData = JSON.stringify({
                    ...data,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                });
                
                // Store in global variable to simulate persistence
                window.persistentMedicineData = jsonData;
                
                // Update UI to show last saved time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                return false;
            }
        }

        function loadFromStorage() {
            try {
                // Try to load from global variable (simulates persistent storage)
                if (window.persistentMedicineData) {
                    const data = JSON.parse(window.persistentMedicineData);
                    
                    // Update last updated time
                    if (data.lastUpdated) {
                        document.getElementById('lastUpdate').textContent = new Date(data.lastUpdated).toLocaleString();
                    }
                    
                    // Remove metadata and return actual data
                    delete data.lastUpdated;
                    delete data.version;
                    
                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                return null;
            }
        }

        // Initialize data on app start
        function initializeData() {
            const savedData = loadFromStorage();
            
            if (savedData) {
                // Use saved data
                medicineData = savedData;
                showNotification('Previous data loaded successfully!');
            } else {
                // Use original data for first time
                medicineData = JSON.parse(JSON.stringify(originalMedicineData));
                saveToStorage(medicineData);
                showNotification('Welcome for medicine tracking.');
            }
        }

        // Save data after any changes
        function saveData() {
            return saveToStorage(medicineData);
        }

        // Check if medicine was taken today
        function wasTakenToday(lastTaken) {
            if (!lastTaken) return false;
            const today = new Date().toDateString();
            const takenDate = new Date(lastTaken).toDateString();
            return today === takenDate;
        }

        // Initialize the app
        function initApp() {
            initializeData();
            renderFatherMedicines();
            renderMotherMedicines();
            
            // Show install prompt on mobile
            if (isMobile() && !isAppInstalled()) {
                setTimeout(() => {
                    document.getElementById('installPrompt').style.display = 'block';
                }, 2000);
            }
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches;
        }

        function switchTab(tab) {
            // Remove active class from all tabs and sections
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.person-section').forEach(s => s.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding section
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function renderFatherMedicines() {
            const fatherSection = document.getElementById('father');
            fatherSection.innerHTML = '';

            const timeSlots = [
                { key: 'morning', title: 'Morning (Before Breakfast)' },
                { key: 'afterBreakfast', title: 'After Breakfast' },
                { key: 'afternoon', title: 'Afternoon (4 PM)' },
                { key: 'afterDinner', title: 'After Dinner'}
            ];

            timeSlots.forEach(slot => {
                if (medicineData.father[slot.key] && medicineData.father[slot.key].length > 0) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.innerHTML = `<h3>${slot.title}</h3>`;

                    medicineData.father[slot.key].forEach((medicine, index) => {
                        const medicineDiv = createMedicineItem(medicine, 'father', slot.key, index);
                        slotDiv.appendChild(medicineDiv);
                    });

                    fatherSection.appendChild(slotDiv);
                }
            });
        }

        function renderMotherMedicines() {
            const motherSection = document.getElementById('mother');
            motherSection.innerHTML = '';

            const timeSlots = [
                { key: 'afterBreakfast', title: 'After Breakfast'},
                { key: 'afterDinner', title: 'After Dinner' }
            ];

            timeSlots.forEach(slot => {
                if (medicineData.mother[slot.key] && medicineData.mother[slot.key].length > 0) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.innerHTML = `<h3>${slot.title}</h3>`;

                    // Handle duplicate medicines for mother (Cinod and Zavamet appear in both slots)
                    const uniqueMedicines = slot.key === 'afterDinner' ? 
                        medicineData.mother[slot.key].filter(med => med.timing.includes('dinner')) :
                        medicineData.mother[slot.key];

                    uniqueMedicines.forEach((medicine, index) => {
                        const medicineDiv = createMedicineItem(medicine, 'mother', slot.key, index);
                        slotDiv.appendChild(medicineDiv);
                    });

                    motherSection.appendChild(slotDiv);
                }
            });
        }

        function createMedicineItem(medicine, person, slot, index) {
            const isLowStock = medicine.stock <= 1;
            const takenToday = wasTakenToday(medicine.lastTaken);
            
            const medicineDiv = document.createElement('div');
            let className = 'medicine-item';
            if (isLowStock) className += ' low-stock';
            if (takenToday) className += ' taken-today';
            medicineDiv.className = className;
            
            let stockStatus = '';
            if (takenToday) {
                stockStatus = 'Taken Today';
            } else if (isLowStock) {
                stockStatus = `${medicine.stock} WARNING`;
            } else {
                stockStatus = `${medicine.stock} Pills`;
            }

            let lastTakenText = '';
            if (medicine.lastTaken) {
                const takenDate = new Date(medicine.lastTaken);
                lastTakenText = `<div class="last-taken">Last taken: ${takenDate.toLocaleDateString()} at ${takenDate.toLocaleTimeString()}</div>`;
            }
            
            medicineDiv.innerHTML = `
                <div class="medicine-header">
                    <div class="medicine-name">${medicine.name}</div>
                    <div class="stock-count ${isLowStock ? 'low' : ''} ${takenToday ? 'taken' : ''}">
                        ${stockStatus}
                    </div>
                </div>
                <div class="medicine-details">
                    ${medicine.dose} ${medicine.timing ? '• ' + medicine.timing : ''}
                    ${lastTakenText}
                </div>
                <div class="action-buttons">
                    <button class="btn btn-take" 
                            onclick="takeMedicine('${person}', '${slot}', ${index})"
                            ${medicine.stock <= 0 ? 'disabled' : ''}>
                        ${medicine.stock <= 0 ? 'Out of Stock' : (takenToday ? 'Taken Today' : 'Take Medicine')}
                    </button>
                    <button class="btn btn-calendar" onclick="addToCalendar('${medicine.name}', '${slot}')">
                        Add to Calendar
                    </button>
                </div>
            `;

            return medicineDiv;
        }

        function takeMedicine(person, slot, index) {
            const medicine = medicineData[person][slot][index];
            
            if (medicine.stock > 0) {
                // Check if already taken today
                if (wasTakenToday(medicine.lastTaken)) {
                    showNotification(`${medicine.name} was already taken today!`, 'error');
                    return;
                }
                
                // Decrease stock and record time
                medicine.stock--;
                medicine.lastTaken = new Date().toISOString();
                
                // Save data to persistent storage
                if (saveData()) {
                    const remainingStock = medicine.stock;
                    
                    if (remainingStock <= 1) {
                        showNotification(`${medicine.name} taken! Only ${remainingStock} dose${remainingStock === 1 ? '' : 's'} left - Time to refill!`, 'error');
                    } else {
                        showNotification(`${medicine.name} taken successfully! ${remainingStock} doses remaining.`);
                    }
                    
                    // Re-render the appropriate section
                    if (person === 'father') {
                        renderFatherMedicines();
                    } else {
                        renderMotherMedicines();
                    }
                } else {
                    showNotification('Error saving data. Please try again.', 'error');
               }
           } else {
               showNotification(`${medicine.name} is out of stock!`, 'error');
           }
       }

       // Continuing from the addToCalendar function
function addToCalendar(medicineName, timeSlot) {
    const timeMap = {
        'morning': '08:00',
        'afterBreakfast': '10:00',
        'afternoon': '16:00',
        'afterDinner': '21:00'
    };
    
    const time = timeMap[timeSlot] || '09:00';
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const startDate = tomorrow.toISOString().split('T')[0] + 'T' + time + ':00';
    const endDate = new Date(startDate);
    endDate.setMinutes(endDate.getMinutes() + 15);
    
    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Take ${medicineName}&dates=${startDate.replace(/[-:]/g, '')}/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=Reminder to take ${medicineName}&location=Home`;
    
    window.open(calendarUrl, '_blank');
    showNotification(`Calendar reminder created for ${medicineName}!`);
}

function resetAllStock() {
    if (confirm('Are you sure you want to reset all medicine stock to original amounts? This will clear all taken history.')) {
        medicineData = JSON.parse(JSON.stringify(originalMedicineData));
        
        if (saveData()) {
            renderFatherMedicines();
            renderMotherMedicines();
            showNotification('All medicine stock has been reset to original amounts!');
        } else {
            showNotification('Error resetting stock. Please try again.', 'error');
        }
    }
}

let isListening = false;
let recognition;

function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            isListening = true;
            document.getElementById('voiceBtn').classList.add('listening');
            document.getElementById('voiceOutput').style.display = 'block';
            document.getElementById('voiceText').textContent = 'Listening... Please speak now.';
        };

        recognition.onresult = function(event) {
            const command = event.results[0][0].transcript.toLowerCase();
            processVoiceCommand(command);
        };

        recognition.onerror = function(event) {
            showNotification('Voice recognition error. Please try again.', 'error');
            stopListening();
        };

        recognition.onend = function() {
            stopListening();
        };
    } else {
        showNotification('Voice recognition not supported in this browser', 'error');
    }
}

function toggleVoiceAssistant() {
    if (!recognition) {
        initVoiceRecognition();
    }
    
    if (isListening) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

function stopListening() {
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('listening');
}

function processVoiceCommand(command) {
    let response = '';
    
    // Check stock levels
    if (command.includes('stock') || command.includes('how many')) {
        if (command.includes('father')) {
            response = getFatherStockInfo();
        } else if (command.includes('mother')) {
            response = getMotherStockInfo();
        } else {
            response = getAllStockInfo();
        }
    }
    // Medicine information
    else if (command.includes('what is') || command.includes('tell me about')) {
        response = getMedicineInfo(command);
    }
    // Low stock warnings
    else if (command.includes('low stock') || command.includes('running low')) {
        response = getLowStockWarnings();
    }
    // Today's medicines
    else if (command.includes('today') || command.includes('taken today')) {
        response = getTodaysMedicines();
    }
    // Help
    else if (command.includes('help') || command.includes('what can you do')) {
        response = getHelpInfo();
    }
    else {
        response = "I didn't understand that command. Try asking about stock levels, medicine information, or say 'help' for more options.";
    }
    
    displayVoiceResponse(response, command);
}

function getFatherStockInfo() {
    let info = "Father's medicine stock:\n\n";
    Object.keys(medicineData.father).forEach(timeSlot => {
        medicineData.father[timeSlot].forEach(medicine => {
            const status = medicine.stock <= 1 ? ' (LOW STOCK!)' : '';
            info += `${medicine.name}: ${medicine.stock} tablets${status}\n`;
        });
    });
    return info;
}

function getMotherStockInfo() {
    let info = "Mother's medicine stock:\n\n";
    const processedMedicines = new Set();
    
    Object.keys(medicineData.mother).forEach(timeSlot => {
        medicineData.mother[timeSlot].forEach(medicine => {
            if (!processedMedicines.has(medicine.name)) {
                const status = medicine.stock <= 1 ? ' (LOW STOCK!)' : '';
                info += `${medicine.name}: ${medicine.stock} tablets${status}\n`;
                processedMedicines.add(medicine.name);
            }
        });
    });
    return info;
}

function getAllStockInfo() {
    return getFatherStockInfo() + "\n" + getMotherStockInfo();
}

function getMedicineInfo(command) {
    const medicineNames = [];
    
    // Collect all medicine names
    Object.keys(medicineData.father).forEach(timeSlot => {
        medicineData.father[timeSlot].forEach(medicine => {
            medicineNames.push(medicine);
        });
    });
    
    Object.keys(medicineData.mother).forEach(timeSlot => {
        medicineData.mother[timeSlot].forEach(medicine => {
            if (!medicineNames.find(m => m.name === medicine.name)) {
                medicineNames.push(medicine);
            }
        });
    });
    
    // Find mentioned medicine
    const foundMedicine = medicineNames.find(medicine => 
        command.includes(medicine.name.toLowerCase())
    );
    
    if (foundMedicine) {
        return `${foundMedicine.name}: Dose is ${foundMedicine.dose}. ${foundMedicine.timing ? 'Timing: ' + foundMedicine.timing : ''} Current stock: ${foundMedicine.stock} tablets.`;
    }
    
    return "I couldn't find information about that medicine. Please check the medicine name and try again.";
}

function getLowStockWarnings() {
    let warnings = "Low stock warnings:\n\n";
    let hasLowStock = false;
    
    // Check father's medicines
    Object.keys(medicineData.father).forEach(timeSlot => {
        medicineData.father[timeSlot].forEach(medicine => {
            if (medicine.stock <= 1) {
                warnings += `Father's ${medicine.name}: Only ${medicine.stock} left!\n`;
                hasLowStock = true;
            }
        });
    });
    
    // Check mother's medicines
    const processedMedicines = new Set();
    Object.keys(medicineData.mother).forEach(timeSlot => {
        medicineData.mother[timeSlot].forEach(medicine => {
            if (medicine.stock <= 1 && !processedMedicines.has(medicine.name)) {
                warnings += `Mother's ${medicine.name}: Only ${medicine.stock} left!\n`;
                hasLowStock = true;
                processedMedicines.add(medicine.name);
            }
        });
    });
    
    if (!hasLowStock) {
        warnings = "All medicines have adequate stock levels!";
    }
    
    return warnings;
}

function getTodaysMedicines() {
    let info = "Medicines taken today:\n\n";
    let hasTakenToday = false;
    
    // Check father's medicines
    Object.keys(medicineData.father).forEach(timeSlot => {
        medicineData.father[timeSlot].forEach(medicine => {
            if (wasTakenToday(medicine.lastTaken)) {
                info += `Father's ${medicine.name} (${timeSlot})\n`;
                hasTakenToday = true;
            }
        });
    });
    
    // Check mother's medicines
    const processedMedicines = new Set();
    Object.keys(medicineData.mother).forEach(timeSlot => {
        medicineData.mother[timeSlot].forEach(medicine => {
            if (wasTakenToday(medicine.lastTaken) && !processedMedicines.has(medicine.name)) {
                info += `Mother's ${medicine.name}\n`;
                hasTakenToday = true;
                processedMedicines.add(medicine.name);
            }
        });
    });
    
    if (!hasTakenToday) {
        info = "No medicines have been taken today yet.";
    }
    
    return info;
}

function getHelpInfo() {
    return `Voice Assistant Help:

You can ask me:
• "Check father's stock" or "Check mother's stock"
• "What is [medicine name] used for?"
• "Show low stock warnings"
• "What medicines were taken today?"
• "How many [medicine name] tablets are left?"

I can help you track medicine usage and stock levels!`;
}

function displayVoiceResponse(response, command) {
    document.getElementById('voiceText').innerHTML = `
        <strong>You said:</strong> "${command}"<br><br>
        <strong>Response:</strong><br>${response.replace(/\n/g, '<br>')}
    `;
    
    // Text-to-speech if available
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(response);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
    }
}

function closeVoiceOutput() {
    document.getElementById('voiceOutput').style.display = 'none';
    if (isListening) {
        recognition.stop();
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

function showInstallInstructions() {
    const instructions = isMobile() ? 
        'On mobile: Tap the share button and select "Add to Home Screen"' :
        'On desktop: Look for the install icon in your browser\'s address bar';
    
    alert(instructions);
}

function hideInstallPrompt() {
    document.getElementById('installPrompt').style.display = 'none';
}

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', initApp);

// PWA service worker registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCJpbnN0YWxsIiwgZXZlbnQgPT4geyBldmVudC53YWl0VW50aWwoc2VsZi5za2lwV2FpdGluZygpKTsgfSk7IHNlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGV2ZW50ID0+IHsgaWYgKGV2ZW50LmRhdGEgJiYgZXZlbnQuZGF0YS50eXBlID09PSAiU0tJUF9XQUlUSU5HIikgeyBzZWxmLnNraXBXYWl0aW5nKCk7IH0gfSk7')
            .then(function(registration) {
                console.log('ServiceWorker registration successful');
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}

// Handle install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installPrompt').style.display = 'block';
});

// Auto-save data every 5 minutes
setInterval(() => {
    saveData();
}, 5 * 60 * 1000);